<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>蝦皮折扣分攤計算機</title>

<style>
body{
font-family:"Microsoft JhengHei",sans-serif;
background:#f5f5f5;
margin:0;
}
.container{
max-width:720px;
margin:auto;
padding:20px;
}
.card{
background:#fff;
padding:20px;
border-radius:12px;
box-shadow:0 4px 12px rgba(0,0,0,.08);
}
h2{
text-align:center;
color:#ee4d2d;
}
input,select{
width:100%;
padding:10px;
margin-top:6px;
border:1px solid #ddd;
border-radius:6px;
box-sizing:border-box;
}
.item-card{
border:1px solid #eee;
padding:12px;
border-radius:8px;
margin-bottom:10px;
}
.item-grid{
display:grid;
grid-template-columns:1fr 1fr;
gap:8px;
}
button{
padding:10px 12px;
border:none;
border-radius:6px;
cursor:pointer;
font-weight:bold;
margin-top:6px;
}
.btn-orange{background:#ee4d2d;color:#fff;}
.btn-green{background:#26af61;color:#fff;}
.btn-gray{background:#eee;}
.result-box{
margin-top:20px;
background:#fff8f6;
padding:15px;
border-radius:8px;
display:none;
}
.highlight{color:#ee4d2d;font-size:20px;font-weight:bold;}
table{
width:100%;
border-collapse:collapse;
margin-top:10px;
}
th,td{
border:1px solid #eee;
padding:6px;
text-align:center;
}
</style>
</head>
<body>

<div class="container">
<div class="card">

<h2>蝦皮折扣分攤計算機</h2>

<h4>折扣與運費</h4>
<input type="number" id="shopeeCoupon" placeholder="蝦皮優惠券">
<input type="number" id="storeCoupon" placeholder="賣場優惠券">
<input type="number" id="shippingFee" placeholder="運費">
<select id="shippingMode">
<option value="ratio">運費按比例分攤</option>
<option value="average">運費平均分攤</option>
<option value="self">不分攤運費</option>
</select>

<h4>品項明細</h4>
<div id="items"></div>
<button class="btn-gray" onclick="addItem()">+ 新增品項</button>

<br><br>
<button class="btn-orange" onclick="calculate()">重新計算</button>

<div class="result-box" id="resultBox">
<h4>計算結果</h4>
<div id="summary"></div>
<table>
<thead>
<tr>
<th>品項</th>
<th>數量</th>
<th>最終單價</th>
<th>小計</th>
</tr>
</thead>
<tbody id="resultTable"></tbody>
</table>

<br>
<input type="number" id="coins" placeholder="蝦幣折抵">
<div>最後實付：<span class="highlight" id="finalCash">$0</span></div>
</div>

</div>
</div>

<script>

let finalItems=[];
let currentTotal=0;

function addItem(data={}){
const div=document.createElement("div");
div.className="item-card";
div.innerHTML=`
<input type="text" class="name" placeholder="品名" value="${data.name||''}">
<div class="item-grid">
<input type="number" class="price" placeholder="單價" value="${data.price||''}">
<input type="number" class="qty" placeholder="數量" value="${data.qty||''}">
</div>
<label>
<input type="checkbox" class="participate" ${data.participate!==false?'checked':''}>
參與折扣
</label>
<button onclick="this.parentElement.remove()">刪除</button>
`;
document.getElementById("items").appendChild(div);
}

function calculate(){

const rows=document.querySelectorAll(".item-card");
let items=[];
let originalTotal=0;

rows.forEach((r,i)=>{
const p=parseFloat(r.querySelector(".price").value);
const q=parseInt(r.querySelector(".qty").value);
const name=r.querySelector(".name").value||"品項"+(i+1);
const participate=r.querySelector(".participate").checked;

if(p>0&&q>0){
items.push({
rowIndex:i,
name,
price:p,
qty:q,
participate
});
originalTotal+=p*q;
}
});

if(originalTotal<=0)return;

const shopee=parseFloat(shopeeCoupon.value)||0;
const store=parseFloat(storeCoupon.value)||0;
const shipping=parseFloat(shippingFee.value)||0;

if(shopee+store>originalTotal){
alert("折扣不可超過商品總額");
return;
}

/* 單位展開 */
let units=[];

items.forEach(item=>{
for(let i=0;i<item.qty;i++){
units.push({
rowIndex:item.rowIndex,
name:item.name,
price:item.price,
participate:item.participate
});
}
});

/* 折扣基準 */
let discountBase=units
.filter(u=>u.participate)
.reduce((a,b)=>a+b.price,0);

/* 理論單位價格 */
let theoreticalUnits=units.map(unit=>{

let discountShare=unit.participate && discountBase>0
? (unit.price/discountBase)*(shopee+store)
:0;

let shippingShare=0;

if(shippingMode.value==="ratio"){
shippingShare=shipping*(unit.price/originalTotal);
}
else if(shippingMode.value==="average"){
shippingShare=shipping/units.length;
}

return unit.price-discountShare+shippingShare;
});

/* floor + 尾數補償 */
let unitObjects=theoreticalUnits.map((v,i)=>({
index:i,
rowIndex:units[i].rowIndex,
price:units[i].price,
floor:Math.floor(v),
fraction:v-Math.floor(v)
}));

let floorSum=unitObjects.reduce((a,b)=>a+b.floor,0);
let theoreticalSum=theoreticalUnits.reduce((a,b)=>a+b,0);
let diff=Math.round(theoreticalSum-floorSum);

/* 最高單價優先 */
unitObjects.sort((a,b)=>{
if(b.price!==a.price) return b.price-a.price;
return b.fraction-a.fraction;
});

for(let i=0;i<diff;i++){
unitObjects[i].floor++;
}

unitObjects.sort((a,b)=>a.index-b.index);

/* 聚合回原列（不合併同名） */
let rowMap={};

unitObjects.forEach(u=>{
if(!rowMap[u.rowIndex]){
rowMap[u.rowIndex]={subtotal:0,qty:0};
}
rowMap[u.rowIndex].subtotal+=u.floor;
rowMap[u.rowIndex].qty++;
});

/* 組裝結果 */
finalItems=[];
items.forEach(item=>{
let row=rowMap[item.rowIndex];
let unit=Math.floor(row.subtotal/row.qty);
finalItems.push({
name:item.name,
qty:item.qty,
unit:unit,
subtotal:row.subtotal
});
});

currentTotal=Object.values(rowMap)
.reduce((a,b)=>a+b.subtotal,0);

renderResult(originalTotal,shopee+store,shipping);
}

function renderResult(original,discount,shipping){
resultBox.style.display="block";
summary.innerHTML=
`商品總額：$${original}<br>
總折扣：-$${discount}<br>
運費：+$${shipping}<br>
訂單總計：<b>$${currentTotal}</b>`;

resultTable.innerHTML="";
finalItems.forEach(i=>{
const tr=document.createElement("tr");
tr.innerHTML=
`<td>${i.name}</td>
<td>${i.qty}</td>
<td>$${i.unit}</td>
<td>$${i.subtotal}</td>`;
resultTable.appendChild(tr);
});

updateFinal();
}

function updateFinal(){
const c=parseFloat(coins.value)||0;
finalCash.innerText="$"+Math.max(0,currentTotal-c);
}

coins.addEventListener("input",updateFinal);

addItem();

</script>

</body>
</html>

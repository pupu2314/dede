<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦çš®è¨‚å–®æŠ˜åƒ¹åˆ†æ”¤è¨ˆç®—æ©Ÿ</title>
    <style>
        :root {
            --shopee-orange: #ee4d2d;
            --shopee-bg: #f5f5f5;
            --success-green: #26af61;
            --error-red: #ff4d4f;
        }
        body { font-family: "Helvetica Neue", Helvetica, Arial, "PingFang TC", "Heiti TC", "Microsoft JhengHei", sans-serif; padding: 15px; background-color: var(--shopee-bg); color: #333; line-height: 1.5; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: var(--shopee-orange); text-align: center; margin-bottom: 20px; border-bottom: 2px solid var(--shopee-orange); padding-bottom: 10px; }
        
        .section-title { font-weight: bold; margin-bottom: 12px; display: flex; align-items: center; color: #444; }
        .section-title::before { content: ""; display: inline-block; width: 4px; height: 1.2em; background: var(--shopee-orange); margin-right: 8px; border-radius: 2px; }
        
        .input-group { margin-bottom: 20px; background: #fafafa; padding: 15px; border-radius: 6px; border: 1px solid #eee; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        label { display: block; margin-bottom: 5px; font-size: 13px; color: #666; }
        input { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; transition: all 0.2s; }
        input:focus { border-color: var(--shopee-orange); outline: none; box-shadow: 0 0 0 2px rgba(238, 77, 45, 0.1); }
        
        /* éŒ¯èª¤è¼¸å…¥æ¨£å¼ */
        input.input-error { border-color: var(--error-red); background-color: #fff1f0; }

        .item-row { display: grid; grid-template-columns: 2fr 1.2fr 1fr auto; gap: 8px; margin-bottom: 10px; align-items: center; }
        .btn-delete { background: #ffefed; color: var(--shopee-orange); border: 1px solid #ffcfc9; border-radius: 4px; padding: 8px 10px; cursor: pointer; height: 38px; min-width: 45px; font-size: 13px; transition: all 0.2s; }
        .btn-delete:hover { background: var(--shopee-orange); color: white; }
        
        .action-btns { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        button { flex: 1; min-width: 85px; padding: 12px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; transition: opacity 0.2s; }
        .btn-add { background-color: #f8f8f8; color: #555; border: 1px solid #ddd; }
        .btn-calc { background-color: var(--shopee-orange); color: white; }
        .btn-round { background-color: #36cfc9; color: white; }
        .btn-clear { background-color: #eee; color: #666; }
        .btn-copy { background-color: var(--success-green); color: white; margin-top: 10px; width: 100%; flex: none; }
        
        #results { margin-top: 25px; padding: 15px; background: #fffcfb; border: 1px solid #ffe8e4; border-radius: 8px; display: none; }
        .result-summary { margin-bottom: 15px; font-size: 14px; border-bottom: 1px dashed #ddd; padding-bottom: 10px; }
        .result-summary p { margin: 5px 0; display: flex; justify-content: space-between; }
        
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; margin-bottom: 15px; min-width: 400px; }
        th, td { border: 1px solid #eee; padding: 10px 5px; text-align: center; font-size: 13px; }
        th { background-color: #fcfcfc; color: #777; font-weight: normal; }
        
        .final-payment-box { background: #fff; padding: 15px; border-radius: 6px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .payment-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .highlight { color: var(--shopee-orange); font-weight: bold; font-size: 20px; }
        
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; display: none; z-index: 100; }
    </style>
</head>
<body>

<div class="container">
    <h2>è¦çš®æŠ˜æ‰£åˆ†æ”¤è¨ˆç®—æ©Ÿ</h2>
    
    <!-- 1. æŠ˜æ‰£èˆ‡é‹è²» -->
    <div class="input-group">
        <span class="section-title">1. æŠ˜æ‰£èˆ‡é‹è²»</span>
        <div class="grid-2">
            <div>
                <label>è¦çš®å„ªæƒ åˆ¸</label>
                <input type="number" id="shopeeCoupon" placeholder="0" min="0" oninput="saveData()">
            </div>
            <div>
                <label>è³£å ´å„ªæƒ åˆ¸</label>
                <input type="number" id="storeCoupon" placeholder="0" min="0" oninput="saveData()">
            </div>
        </div>
        <div style="margin-top: 10px;">
            <label>é‹è²» (è‡ªä»˜é¡)</label>
            <input type="number" id="shippingFee" placeholder="0" min="0" oninput="saveData()">
        </div>
    </div>

    <!-- 2. å“é …æ˜ç´° -->
    <div class="input-group">
        <span class="section-title">2. å“é …æ˜ç´°</span>
        <div id="itemsContainer"></div>
        <div class="action-btns">
            <button class="btn-add" onclick="addItem()">+ æ–°å¢</button>
            <button class="btn-calc" onclick="calculate(false)">è¨ˆç®—</button>
            <button class="btn-round" onclick="calculate(true)">æ™ºæ…§å–æ•´</button>
            <button class="btn-clear" onclick="clearAll()">æ¸…é™¤</button>
        </div>
    </div>

    <!-- 3. çµæœ -->
    <div id="results">
        <div class="result-summary">
            <p><span>å•†å“åŸå§‹ç¸½é¡ï¼š</span><span id="resOriginalTotal">$0</span></p>
            <p><span>ç¸½æŠ˜æ‰£é¡ï¼š</span><span id="resTotalDiscount" style="color: red;">-$0</span></p>
            <p><span>è‡ªä»˜é‹è²»ï¼š</span><span id="resShipping">+$0</span></p>
            <p style="font-size: 16px; font-weight: bold; margin-top: 8px; color: #333;">
                <span>è¨‚å–®æ‡‰ä»˜ç¸½è¨ˆï¼š</span><span id="resActualTotal">$0</span>
            </p>
        </div>

        <div class="table-wrapper">
            <table id="resultTable">
                <thead>
                    <tr>
                        <th>å“é …</th>
                        <th>åŸå–®åƒ¹</th>
                        <th>æ•¸é‡</th>
                        <th>åˆ†æ”¤å¾Œå–®åƒ¹</th>
                        <th>å°è¨ˆ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="final-payment-box">
            <label>è¦å¹£æŠ˜æŠµ</label>
            <input type="number" id="shopeeCoins" placeholder="0" min="0" oninput="saveData(); updateFinalPayment()">
            <div class="payment-row">
                <span>æœ€å¾Œå¯¦ä»˜ç¾é‡‘ï¼š</span>
                <span id="finalCash" class="highlight">$0</span>
            </div>
        </div>

        <button class="btn-copy" onclick="copyToClipboard()">è¤‡è£½çµæœæ–‡å­— (LINEåˆ†äº«)</button>
    </div>
</div>

<div id="toast" class="toast">å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿</div>

<script>
    let currentActualTotal = 0;
    let currentResults = [];

    window.onload = function() {
        const savedData = localStorage.getItem('shopee_calc_v2');
        if (savedData) {
            const data = JSON.parse(savedData);
            document.getElementById('shopeeCoupon').value = data.shopeeCoupon || '';
            document.getElementById('storeCoupon').value = data.storeCoupon || '';
            document.getElementById('shippingFee').value = data.shippingFee || '';
            document.getElementById('shopeeCoins').value = data.shopeeCoins || '';
            if (data.items && data.items.length > 0) {
                data.items.forEach(item => addItem(item.n, item.p, item.q));
            } else { addItem(); }
        } else { addItem(); }
    };

    function addItem(name = '', price = '', qty = '') {
        const container = document.getElementById('itemsContainer');
        const div = document.createElement('div');
        div.className = 'item-row';
        div.innerHTML = `
            <input type="text" class="name" placeholder="å“å" value="${name}" oninput="saveData()">
            <input type="number" class="price" placeholder="å–®åƒ¹" value="${price}" oninput="handleInput(this)">
            <input type="number" class="qty" placeholder="æ•¸é‡" value="${qty}" oninput="handleInput(this)">
            <button class="btn-delete" onclick="removeItem(this)">åˆª</button>
        `;
        container.appendChild(div);
        saveData();
    }

    function handleInput(el) {
        if (el.value !== '' && parseFloat(el.value) > 0) {
            el.classList.remove('input-error');
        }
        saveData();
    }

    function removeItem(btn) {
        btn.parentElement.remove();
        if (document.querySelectorAll('.item-row').length === 0) addItem();
        saveData();
    }

    function saveData() {
        const items = [];
        const rows = document.querySelectorAll('.item-row');
        rows.forEach(row => {
            items.push({
                n: row.querySelector('.name').value,
                p: row.querySelector('.price').value,
                q: row.querySelector('.qty').value
            });
        });
        const data = {
            shopeeCoupon: document.getElementById('shopeeCoupon').value,
            storeCoupon: document.getElementById('storeCoupon').value,
            shippingFee: document.getElementById('shippingFee').value,
            shopeeCoins: document.getElementById('shopeeCoins').value,
            items: items
        };
        localStorage.setItem('shopee_calc_v2', JSON.stringify(data));
    }

    function clearAll() {
        if (!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) return;
        localStorage.removeItem('shopee_calc_v2');
        location.reload();
    }

    function calculate(useSmartRounding) {
        const rows = document.querySelectorAll('.item-row');
        const shopeeCoupon = parseFloat(document.getElementById('shopeeCoupon').value) || 0;
        const storeCoupon = parseFloat(document.getElementById('storeCoupon').value) || 0;
        const shippingFee = parseFloat(document.getElementById('shippingFee').value) || 0;
        
        let itemOriginalTotal = 0;
        let validItems = [];

        rows.forEach((row, i) => {
            const priceEl = row.querySelector('.price');
            const qtyEl = row.querySelector('.qty');
            const nameEl = row.querySelector('.name');
            
            let p = parseFloat(priceEl.value);
            let q = parseFloat(qtyEl.value);
            let n = nameEl.value.trim() || `å“é …${i + 1}`;

            // é˜²å‘†åˆ¤æ–·ï¼šè‹¥ç‚ºç©ºå€¼æˆ–ç„¡æ•ˆæ•¸å­—ï¼Œæ¨™ç¤ºç´…åº•
            let isInvalid = isNaN(p) || p <= 0 || isNaN(q) || q <= 0;
            
            if (isInvalid) {
                if (isNaN(p) || p <= 0) priceEl.classList.add('input-error');
                if (isNaN(q) || q <= 0) qtyEl.classList.add('input-error');
            } else {
                priceEl.classList.remove('input-error');
                qtyEl.classList.remove('input-error');
                itemOriginalTotal += p * q;
                validItems.push({ n, p, q });
            }
        });

        if (validItems.length === 0) return;

        const totalDiscount = shopeeCoupon + storeCoupon;
        currentActualTotal = Math.max(0, itemOriginalTotal - totalDiscount + shippingFee);
        const ratio = itemOriginalTotal > 0 ? currentActualTotal / itemOriginalTotal : 0;

        document.getElementById('resOriginalTotal').innerText = `$${itemOriginalTotal.toLocaleString()}`;
        document.getElementById('resTotalDiscount').innerText = `-$${totalDiscount.toLocaleString()}`;
        document.getElementById('resShipping').innerText = `+$${shippingFee.toLocaleString()}`;
        document.getElementById('resActualTotal').innerText = `$${Math.round(currentActualTotal).toLocaleString()}`;
        
        const tbody = document.querySelector('#resultTable tbody');
        tbody.innerHTML = '';
        currentResults = [];

        let currentSum = 0;
        validItems.forEach((item, idx) => {
            let finalUnitPrice;
            if (useSmartRounding) {
                if (idx === validItems.length - 1) {
                    let remaining = currentActualTotal - currentSum;
                    finalUnitPrice = item.q > 0 ? remaining / item.q : 0;
                } else {
                    finalUnitPrice = Math.round(item.p * ratio);
                }
            } else {
                finalUnitPrice = item.p * ratio;
            }
            
            let subtotal = finalUnitPrice * item.q;
            currentSum += subtotal;

            currentResults.push({ name: item.n, original: item.p, qty: item.q, unit: finalUnitPrice, subtotal: subtotal });

            tbody.innerHTML += `<tr>
                <td>${item.n}</td>
                <td>$${item.p}</td>
                <td>${item.q}</td>
                <td style="color:var(--shopee-orange); font-weight:bold;">$${useSmartRounding ? Math.round(finalUnitPrice) : finalUnitPrice.toFixed(2)}</td>
                <td>$${Math.round(subtotal).toLocaleString()}</td>
            </tr>`;
        });

        document.getElementById('results').style.display = 'block';
        updateFinalPayment();
        document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
    }

    function updateFinalPayment() {
        const coins = parseFloat(document.getElementById('shopeeCoins').value) || 0;
        const finalCash = Math.max(0, currentActualTotal - coins);
        document.getElementById('finalCash').innerText = `$${Math.round(finalCash).toLocaleString()}`;
    }

    function copyToClipboard() {
        let text = "ğŸ›ï¸ è¦çš®è¨‚å–®åˆ†æ”¤æ˜ç´°\n---\n";
        currentResults.forEach(item => {
            text += `ğŸ”¹ ${item.name}\n   æ•¸é‡: ${item.qty}\n   åˆ†æ”¤å–®åƒ¹: $${Math.round(item.unit)}\n   å°è¨ˆ: $${Math.round(item.subtotal)}\n`;
        });
        text += `---\nğŸ’° è¨‚å–®ç¸½è¨ˆ: $${Math.round(currentActualTotal)}\n`;
        const coins = parseFloat(document.getElementById('shopeeCoins').value) || 0;
        if(coins > 0) text += `ğŸª™ è¦å¹£æŠ˜æŠµ: -$${coins}\n`;
        text += `ğŸ’µ å¯¦ä»˜ç¾é‡‘: $${document.getElementById('finalCash').innerText}`;

        const el = document.createElement('textarea');
        el.value = text;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        
        const toast = document.getElementById('toast');
        toast.style.display = 'block';
        setTimeout(() => toast.style.display = 'none', 2000);
    }
</script>

</body>
</html>

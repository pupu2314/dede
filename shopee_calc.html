<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>蝦皮折扣分攤計算機</title>

<style>
body{font-family:"Microsoft JhengHei";background:#f5f5f5;margin:0}
.container{max-width:720px;margin:auto;padding:20px}
.card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
h2{text-align:center;color:#ee4d2d}
input,select{width:100%;padding:10px;margin-top:6px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box}
.item-card{border:1px solid #eee;padding:12px;border-radius:8px;margin-bottom:10px}
.item-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
button{padding:8px 12px;border:none;border-radius:6px;cursor:pointer;font-weight:bold;margin-top:6px}
.btn-orange{background:#ee4d2d;color:#fff}
.btn-green{background:#26af61;color:#fff}
.btn-gray{background:#eee}
.result-box{margin-top:20px;background:#fff8f6;padding:15px;border-radius:8px;display:none}
.highlight{color:#ee4d2d;font-size:20px;font-weight:bold}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #eee;padding:6px;text-align:center}
</style>
</head>
<body>

<div class="container">
<div class="card">

<h2>蝦皮折扣分攤計算機</h2>

<h4>折扣與運費</h4>
<input type="number" id="shopeeCoupon" placeholder="蝦皮優惠券">
<input type="number" id="storeCoupon" placeholder="賣場優惠券">
<input type="number" id="shippingFee" placeholder="運費">
<select id="shippingMode">
<option value="ratio">運費按比例分攤</option>
<option value="average">運費平均分攤</option>
<option value="self">不分攤運費</option>
</select>

<h4>品項明細</h4>
<div id="items"></div>
<button class="btn-gray" onclick="addItem()">+ 新增品項</button>

<br>
<button class="btn-orange" onclick="calculate()">重新計算</button>
<button class="btn-gray" onclick="clearMemory()">清除記憶</button>

<div class="result-box" id="resultBox">
<h4>計算結果</h4>
<div id="summary"></div>
<table>
<thead>
<tr>
<th>品項</th>
<th>數量</th>
<th>最終單價</th>
<th>小計</th>
</tr>
</thead>
<tbody id="resultTable"></tbody>
</table>

<br>
<input type="number" id="coins" placeholder="蝦幣折抵">
<div>最後實付：<span class="highlight" id="finalCash">$0</span></div>
</div>

</div>
</div>

<script>

let finalItems=[];
let currentTotal=0;

function addItem(){
const div=document.createElement("div");
div.className="item-card";
div.innerHTML=`
<input type="text" class="name" placeholder="品名">
<div class="item-grid">
<input type="number" class="price" placeholder="單價">
<input type="number" class="qty" placeholder="數量">
</div>
<label><input type="checkbox" class="participate" checked>參與折扣</label>
<button onclick="this.parentElement.remove()">刪除</button>
`;
items.appendChild(div);
}

function calculate(){

const rows=document.querySelectorAll(".item-card");
let itemsData=[];
let originalTotal=0;

rows.forEach((r,i)=>{
let p=parseFloat(r.querySelector(".price").value);
let q=parseInt(r.querySelector(".qty").value);
let name=r.querySelector(".name").value||"品項"+(i+1);
let participate=r.querySelector(".participate").checked;

if(p>0&&q>0){
itemsData.push({index:i,name,price:p,qty:q,participate});
originalTotal+=p*q;
}
});

if(originalTotal<=0)return;

let discount=(parseFloat(shopeeCoupon.value)||0)+(parseFloat(storeCoupon.value)||0);
let shipping=parseFloat(shippingFee.value)||0;

if(discount>originalTotal){
alert("折扣不可超過總額");
return;
}

/* 單位展開 */
let units=[];
itemsData.forEach(item=>{
for(let i=0;i<item.qty;i++){
units.push({row:item.index,price:item.price,participate:item.participate});
}
});

/* 折扣比例 */
let base=units.filter(u=>u.participate).reduce((a,b)=>a+b.price,0);

let theoretical=units.map(u=>{
let d=u.participate&&base>0?(u.price/base)*discount:0;
return u.price-d;
});

/* floor */
let floors=theoretical.map(v=>Math.floor(v));
let diff=Math.round(theoretical.reduce((a,b)=>a+b,0)-floors.reduce((a,b)=>a+b,0));

/* 尾數分配給數量較少的列 */
let rowQty={};
itemsData.forEach(i=>rowQty[i.index]=i.qty);

let indices=[...Array(units.length).keys()];
indices.sort((a,b)=>rowQty[units[a].row]-rowQty[units[b].row]);

for(let i=0;i<diff;i++){
floors[indices[i]]++;
}

/* 聚合 */
let rowMap={};
floors.forEach((v,i)=>{
let row=units[i].row;
if(!rowMap[row])rowMap[row]=0;
rowMap[row]+=v;
});

finalItems=[];
itemsData.forEach(item=>{
let subtotal=rowMap[item.index];
let unit=subtotal/item.qty;
finalItems.push({
name:item.name,
qty:item.qty,
unit:unit,
subtotal:subtotal
});
});

currentTotal=Object.values(rowMap).reduce((a,b)=>a+b,0);

render(originalTotal,discount);
}

function render(original,discount){
resultBox.style.display="block";
summary.innerHTML=
`商品總額：$${original}<br>
總折扣：-$${discount}<br>
訂單總計：<b>$${currentTotal}</b>`;

resultTable.innerHTML="";
finalItems.forEach(i=>{
let tr=document.createElement("tr");
tr.innerHTML=`<td>${i.name}</td>
<td>${i.qty}</td>
<td>$${i.unit}</td>
<td>$${i.subtotal}</td>`;
resultTable.appendChild(tr);
});

updateFinal();
}

function updateFinal(){
let c=parseFloat(coins.value)||0;
finalCash.innerText="$"+(currentTotal-c);
}

function clearMemory(){
localStorage.clear();
location.reload();
}

coins.addEventListener("input",updateFinal);

addItem();

</script>

</body>
</html>

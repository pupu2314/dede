<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¦çš®æŠ˜æ‰£åˆ†æ”¤è¨ˆç®—æ©Ÿ Pro</title>

<style>
:root{
--orange:#ee4d2d;
--bg:#f5f5f5;
--green:#26af61;
--red:#ff4d4f;
}

body{
font-family:"Microsoft JhengHei",sans-serif;
background:var(--bg);
padding:15px;
margin:0;
}

.container{
max-width:720px;
margin:auto;
background:white;
padding:20px;
border-radius:14px;
box-shadow:0 8px 25px rgba(0,0,0,.08);
}

h2{
text-align:center;
color:var(--orange);
border-bottom:2px solid var(--orange);
padding-bottom:10px;
margin-bottom:20px;
}

.section{margin-top:20px;}

input,select{
width:100%;
padding:10px;
border:1px solid #ddd;
border-radius:8px;
box-sizing:border-box;
}

input:focus{
border-color:var(--orange);
outline:none;
}

.input-error{
border-color:var(--red)!important;
background:#fff1f0;
}

.item-row{
display:grid;
grid-template-columns: 1.5fr 1fr 1fr auto;
gap:8px;
align-items:center;
margin-bottom:12px;
}

.chk{
display:flex;
align-items:center;
gap:6px;
font-size:13px;
}

button{
padding:10px;
border:none;
border-radius:8px;
cursor:pointer;
font-weight:bold;
}

.btn-orange{background:var(--orange);color:white;}
.btn-green{background:var(--green);color:white;}
.btn-gray{background:#eee;}

.result-box{
margin-top:20px;
background:#fff8f6;
padding:15px;
border-radius:10px;
display:none;
}

.highlight{
color:var(--orange);
font-size:22px;
font-weight:bold;
}

table{
width:100%;
border-collapse:collapse;
margin-top:10px;
}

th,td{
border:1px solid #eee;
padding:8px;
text-align:center;
font-size:14px;
}

.toast{
position:fixed;
bottom:20px;
left:50%;
transform:translateX(-50%);
background:black;
color:white;
padding:8px 18px;
border-radius:20px;
display:none;
}

/* ğŸ“± æ‰‹æ©Ÿå„ªåŒ– */
@media (max-width:600px){

.item-row{
grid-template-columns: 1fr 1fr;
}

.item-row input[type="text"]{
grid-column: span 2;
}

.item-row button{
grid-column: span 1;
}

.section button{
width:100%;
margin-top:8px;
}

}
</style>
</head>
<body>

<div class="container">
<h2>è¦çš®æŠ˜æ‰£åˆ†æ”¤è¨ˆç®—æ©Ÿ Pro</h2>

<div class="section">
<h4>æŠ˜æ‰£èˆ‡é‹è²»</h4>
<input type="number" id="shopeeCoupon" placeholder="è¦çš®å„ªæƒ åˆ¸">
<input type="number" id="storeCoupon" placeholder="è³£å ´å„ªæƒ åˆ¸" style="margin-top:8px;">
<input type="number" id="shippingFee" placeholder="é‹è²»è‡ªä»˜é¡" style="margin-top:8px;">

<select id="shippingMode" style="margin-top:8px;">
<option value="ratio">é‹è²»æŒ‰é‡‘é¡æ¯”ä¾‹åˆ†æ”¤</option>
<option value="average">é‹è²»å¹³å‡åˆ†æ”¤</option>
<option value="self">é‹è²»ä¸åˆ†æ”¤</option>
</select>
</div>

<div class="section">
<h4>å“é …æ˜ç´°</h4>
<div id="items"></div>
<button class="btn-gray" onclick="addItem()">+ æ–°å¢å“é …</button>
</div>

<div class="section">
<button class="btn-orange" onclick="calculate()">é‡æ–°è¨ˆç®—</button>
<button class="btn-green" onclick="exportCSV()">åŒ¯å‡ºCSV</button>
</div>

<div class="result-box" id="resultBox">
<h4>è¨ˆç®—çµæœ</h4>
<div id="summary"></div>

<table>
<thead>
<tr>
<th>å“é …</th>
<th>æ•¸é‡</th>
<th>æœ€çµ‚å–®åƒ¹</th>
<th>å°è¨ˆ</th>
</tr>
</thead>
<tbody id="resultTable"></tbody>
</table>

<div style="margin-top:15px;">
<input type="number" id="coins" placeholder="è¦å¹£æŠ˜æŠµ">
<div style="margin-top:8px;">æœ€å¾Œå¯¦ä»˜ï¼š
<span class="highlight" id="finalCash">$0</span>
</div>
</div>

<button class="btn-green" style="margin-top:12px;" onclick="copyText()">è¤‡è£½åˆ†äº«æ–‡å­—</button>
</div>
</div>

<div class="toast" id="toast">å·²è¤‡è£½</div>

<script>

const STORAGE_KEY="shopee_calc_v5";
let currentTotal=0;
let finalItems=[];

let debounceTimer;
document.addEventListener("input",()=>{
clearTimeout(debounceTimer);
debounceTimer=setTimeout(()=>{
calculate();
saveData();
},300);
});

/* æ–°å¢å“é … */
function addItem(data={}){
const div=document.createElement("div");
div.className="item-row";
div.innerHTML=`
<input type="text" placeholder="å“å" class="name" value="${data.name||''}">
<input type="number" placeholder="å–®åƒ¹" class="price" value="${data.price||''}">
<input type="number" placeholder="æ•¸é‡" class="qty" value="${data.qty||''}">
<label class="chk"><input type="checkbox" class="participate" ${data.participate!==false?'checked':''}>æŠ˜æ‰£</label>
<button onclick="this.parentElement.remove();calculate()">åˆª</button>
`;
document.getElementById("items").appendChild(div);
}

/* åŒåƒ¹ä¸€è‡´å„ªå…ˆæ¼”ç®—æ³• */
function calculate(){

const rows=document.querySelectorAll(".item-row");
let items=[];
let originalTotal=0;

rows.forEach((r,i)=>{
const p=parseFloat(r.querySelector(".price").value);
const q=parseInt(r.querySelector(".qty").value);
const name=r.querySelector(".name").value||"å“é …"+(i+1);
const participate=r.querySelector(".participate").checked;

if(p>0&&q>0){
items.push({name,p,q,participate});
originalTotal+=p*q;
}
});

if(originalTotal<=0)return;

const shopee=parseFloat(shopeeCoupon.value)||0;
const store=parseFloat(storeCoupon.value)||0;
const shipping=parseFloat(shippingFee.value)||0;

if(shopee+store>originalTotal){
alert("æŠ˜æ‰£ä¸å¯è¶…éå•†å“ç¸½é¡");
return;
}

/* åˆ†ç¾¤ */
let groupMap={};
items.forEach(item=>{
if(!groupMap[item.p]){
groupMap[item.p]={price:item.p,qty:0,participate:item.participate};
}
groupMap[item.p].qty+=item.q;
});
let groups=Object.values(groupMap);

/* æŠ˜æ‰£åŸºç¤ */
let discountBase=items.filter(i=>i.participate)
.reduce((a,b)=>a+b.p*b.q,0);

let theoreticalTotal=0;

groups.forEach(group=>{
let original=group.price*group.qty;
let discountShare=group.participate
? (original/discountBase)*(shopee+store)
:0;

let shippingShare=0;
if(shippingMode.value==="ratio"){
shippingShare=shipping*(original/originalTotal);
}
else if(shippingMode.value==="average"){
shippingShare=shipping/groups.length;
}

group.theoretical=original-discountShare+shippingShare;
theoreticalTotal+=group.theoretical;
});

groups.forEach(g=>g.rounded=Math.round(g.theoretical));

let roundedTotal=groups.reduce((a,b)=>a+b.rounded,0);
let targetTotal=Math.round(theoreticalTotal);
let diff=targetTotal-roundedTotal;

/* èª¤å·®é›†ä¸­åˆ°æœ€é«˜å–®åƒ¹ */
groups.sort((a,b)=>b.price-a.price);
if(diff!==0) groups[0].rounded+=diff;

/* å›å¡« */
finalItems=[];
items.forEach(item=>{
let group=groups.find(g=>g.price==item.p);
let unit=Math.round(group.rounded/group.qty);

finalItems.push({
name:item.name,
qty:item.q,
unit:unit,
subtotal:unit*item.q
});
});

currentTotal=finalItems.reduce((a,b)=>a+b.subtotal,0);

renderResult(originalTotal,shopee+store,shipping);
}

function renderResult(original,discount,shipping){
resultBox.style.display="block";
summary.innerHTML=
`å•†å“ç¸½é¡ï¼š$${original}<br>
ç¸½æŠ˜æ‰£ï¼š-$${discount}<br>
é‹è²»ï¼š+$${shipping}<br>
è¨‚å–®ç¸½è¨ˆï¼š<b>$${currentTotal}</b>`;

resultTable.innerHTML="";
finalItems.forEach(i=>{
const tr=document.createElement("tr");
tr.innerHTML=
`<td>${i.name}</td>
<td>${i.qty}</td>
<td>$${i.unit}</td>
<td>$${i.subtotal}</td>`;
resultTable.appendChild(tr);
});

updateFinal();
}

function updateFinal(){
const c=parseFloat(coins.value)||0;
if(c>currentTotal){
coins.classList.add("input-error");
}else{
coins.classList.remove("input-error");
}
finalCash.innerText="$"+Math.max(0,currentTotal-c);
}

coins.addEventListener("input",updateFinal);

function copyText(){
let text="è¦çš®åˆ†æ”¤æ˜ç´°\n";
finalItems.forEach(i=>{
text+=`${i.name} x${i.qty} = $${i.subtotal}\n`;
});
text+=`ç¸½è¨ˆ $${currentTotal}`;
navigator.clipboard.writeText(text);
toast.style.display="block";
setTimeout(()=>toast.style.display="none",2000);
}

function exportCSV(){
let csv="å“é …,æ•¸é‡,å–®åƒ¹,å°è¨ˆ\n";
finalItems.forEach(i=>{
csv+=`${i.name},${i.qty},${i.unit},${i.subtotal}\n`;
});
const blob=new Blob([csv]);
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="shopee_calc.csv";
a.click();
}

/* æš«å­˜ */
function saveData(){
const rows=document.querySelectorAll(".item-row");
let items=[];
rows.forEach(r=>{
items.push({
name:r.querySelector(".name").value,
price:r.querySelector(".price").value,
qty:r.querySelector(".qty").value,
participate:r.querySelector(".participate").checked
});
});
localStorage.setItem(STORAGE_KEY,JSON.stringify({
shopeeCoupon:shopeeCoupon.value,
storeCoupon:storeCoupon.value,
shippingFee:shippingFee.value,
shippingMode:shippingMode.value,
coins:coins.value,
items:items
}));
}

function loadData(){
const raw=localStorage.getItem(STORAGE_KEY);
if(!raw){addItem();return;}
const data=JSON.parse(raw);
shopeeCoupon.value=data.shopeeCoupon||"";
storeCoupon.value=data.storeCoupon||"";
shippingFee.value=data.shippingFee||"";
shippingMode.value=data.shippingMode||"ratio";
coins.value=data.coins||"";
items.innerHTML="";
(data.items||[]).forEach(i=>addItem(i));
calculate();
}

window.onload=loadData;

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>蝦皮訂單折價分攤計算機 Pro</title>

<style>
:root{
--orange:#ee4d2d;
--bg:#f5f5f5;
--green:#26af61;
--red:#ff4d4f;
}
body{
font-family:"Microsoft JhengHei",sans-serif;
background:var(--bg);
padding:15px;
}
.container{
max-width:680px;
margin:auto;
background:white;
padding:20px;
border-radius:10px;
box-shadow:0 5px 20px rgba(0,0,0,.1);
}
h2{
text-align:center;
color:var(--orange);
border-bottom:2px solid var(--orange);
padding-bottom:8px;
}
.section{
margin-top:20px;
}
input,select{
width:100%;
padding:8px;
border:1px solid #ddd;
border-radius:5px;
}
input:focus{
border-color:var(--orange);
outline:none;
}
.input-error{
border-color:var(--red)!important;
background:#fff1f0;
}
.item-row{
display:grid;
grid-template-columns:2fr 1fr 1fr 1fr auto;
gap:6px;
margin-bottom:8px;
align-items:center;
}
@media(max-width:520px){
.item-row{
grid-template-columns:1fr 1fr;
}
}
button{
padding:10px;
border:none;
border-radius:5px;
cursor:pointer;
font-weight:bold;
}
.btn-orange{background:var(--orange);color:white;}
.btn-green{background:var(--green);color:white;}
.btn-gray{background:#eee;}
.result-box{
margin-top:20px;
background:#fff8f6;
padding:15px;
border-radius:8px;
display:none;
}
.highlight{
color:var(--orange);
font-size:20px;
font-weight:bold;
}
table{
width:100%;
border-collapse:collapse;
margin-top:10px;
}
th,td{
border:1px solid #eee;
padding:6px;
text-align:center;
}
.toast{
position:fixed;
bottom:20px;
left:50%;
transform:translateX(-50%);
background:black;
color:white;
padding:6px 15px;
border-radius:20px;
display:none;
}
</style>
</head>
<body>

<div class="container">
<h2>蝦皮折扣分攤計算機 Pro</h2>

<div class="section">
<h4>折扣與運費</h4>
<input type="number" id="shopeeCoupon" placeholder="蝦皮優惠券">
<input type="number" id="storeCoupon" placeholder="賣場優惠券" style="margin-top:6px;">
<input type="number" id="shippingFee" placeholder="運費自付額" style="margin-top:6px;">

<select id="shippingMode" style="margin-top:6px;">
<option value="ratio">運費按金額比例分攤</option>
<option value="average">運費平均分攤</option>
<option value="self">運費不分攤(下單者負擔)</option>
</select>
</div>

<div class="section">
<h4>品項明細</h4>
<div id="items"></div>
<button class="btn-gray" onclick="addItem()">+ 新增品項</button>
</div>

<div class="section">
<button class="btn-orange" onclick="calculate()">重新計算</button>
<button class="btn-green" onclick="exportCSV()">匯出CSV</button>
</div>

<div class="result-box" id="resultBox">
<h4>計算結果</h4>
<div id="summary"></div>
<table>
<thead>
<tr>
<th>品項</th>
<th>數量</th>
<th>最終單價</th>
<th>小計</th>
</tr>
</thead>
<tbody id="resultTable"></tbody>
</table>

<div style="margin-top:10px;">
<input type="number" id="coins" placeholder="蝦幣折抵">
<div>最後實付：<span class="highlight" id="finalCash">$0</span></div>

</div>
<button class="btn-green" onclick="copyText()">複製分享文字</button>

<button class="btn-red" onclick="clearAll()">清除紀錄</button>
</div>
</div>

<div class="toast" id="toast">已複製</div>

<script>
const STORAGE_KEY="shopee_calc_pro_v3";
let currentTotal=0;
let finalItems=[];

/* debounce 自動計算 */
let timer;
document.addEventListener("input",()=>{
clearTimeout(timer);
timer=setTimeout(calculate,300);
saveData();
});

/* 新增品項 */
function addItem(data={}){
const div=document.createElement("div");
div.className="item-row";
div.innerHTML=`
<input type="text" placeholder="品名" class="name" value="${data.name||''}">
<input type="number" placeholder="單價" class="price" value="${data.price||''}">
<input type="number" placeholder="數量" class="qty" value="${data.qty||''}">
<label><input type="checkbox" class="participate" ${data.participate!==false?'checked':''}>折扣</label>
<button onclick="this.parentElement.remove();calculate()">刪</button>
`;
document.getElementById("items").appendChild(div);
}

/* 核心零誤差演算法 */
function calculate(){

const rows=document.querySelectorAll(".item-row");
let items=[];
let originalTotal=0;

/* 讀取資料 */
rows.forEach((r,i)=>{
const p=parseFloat(r.querySelector(".price").value);
const q=parseInt(r.querySelector(".qty").value);
const name=r.querySelector(".name").value||"品項"+(i+1);
const participate=r.querySelector(".participate").checked;

if(p>0&&q>0){
items.push({name,p,q,participate});
originalTotal+=p*q;
}
});

if(originalTotal<=0)return;

const shopee=parseFloat(shopeeCoupon.value)||0;
const store=parseFloat(storeCoupon.value)||0;
const shipping=parseFloat(shippingFee.value)||0;

if(shopee+store>originalTotal){
alert("折扣不可超過商品總額");
return;
}

/* ===== 單位展開 ===== */

let unitList=[];
items.forEach(item=>{
for(let i=0;i<item.q;i++){
unitList.push({
name:item.name,
price:item.p,
participate:item.participate
});
}
});

/* ===== 折扣基礎 ===== */

let discountBase=unitList
.filter(u=>u.participate)
.reduce((a,b)=>a+b.price,0);

/* ===== 計算理論價格 ===== */

let theoreticalUnits=unitList.map(unit=>{

let discountShare=unit.participate
? (unit.price/discountBase)*(shopee+store)
:0;

let shippingShare=0;

if(shippingMode.value==="ratio"){
shippingShare=shipping*(unit.price/originalTotal);
}
else if(shippingMode.value==="average"){
shippingShare=shipping/unitList.length;
}

return unit.price-discountShare+shippingShare;
});

/* ===== floor + 記錄小數 ===== */

let unitObjects=theoreticalUnits.map((val,index)=>{
return{
index:index,
name:unitList[index].name,
price:unitList[index].price,
floor:Math.floor(val),
fraction:val-Math.floor(val)
};
});

let floorSum=unitObjects.reduce((a,b)=>a+b.floor,0);
let theoreticalSum=theoreticalUnits.reduce((a,b)=>a+b,0);
let diff=Math.round(theoreticalSum-floorSum);

/* ===== 最大餘數法 + 同單價優先 ===== */

unitObjects.sort((a,b)=>{
if(b.fraction!==a.fraction){
return b.fraction-a.fraction;
}
return b.price-a.price; // 同小數 → 高單價優先
});

for(let i=0;i<diff;i++){
unitObjects[i].floor++;
}

/* ===== 還原原順序 ===== */

unitObjects.sort((a,b)=>a.index-b.index);

let roundedUnits=unitObjects.map(u=>u.floor);

/* ===== 聚合同品項 ===== */

let resultMap={};

roundedUnits.forEach((val,index)=>{
let name=unitList[index].name;
if(!resultMap[name]){
resultMap[name]={qty:0,subtotal:0};
}
resultMap[name].qty++;
resultMap[name].subtotal+=val;
});

finalItems=[];
for(let name in resultMap){
let obj=resultMap[name];
finalItems.push({
name:name,
qty:obj.qty,
unit:Math.round(obj.subtotal/obj.qty),
subtotal:obj.subtotal
});
}

currentTotal=roundedUnits.reduce((a,b)=>a+b,0);

renderResult(originalTotal,shopee+store,shipping);
}

/* 渲染 */
function renderResult(original,discount,shipping){
const box=document.getElementById("resultBox");
box.style.display="block";

summary.innerHTML=
`商品總額：$${original}<br>
總折扣：-$${discount}<br>
運費：+$${shipping}<br>
訂單總計：<b>$${currentTotal}</b>`;

const tbody=document.getElementById("resultTable");
tbody.innerHTML="";
finalItems.forEach(i=>{
const tr=document.createElement("tr");
tr.innerHTML=
`<td>${i.name}</td>
<td>${i.qty}</td>
<td>$${i.unit}</td>
<td>$${i.subtotal}</td>`;
tbody.appendChild(tr);
});

updateFinal();
}

function updateFinal(){
const c=parseFloat(coins.value)||0;
if(c>currentTotal){
coins.classList.add("input-error");
}else{
coins.classList.remove("input-error");
}
finalCash.innerText="$"+Math.max(0,currentTotal-c);
}

coins.addEventListener("input",updateFinal);

/* copy */
function copyText(){
let text="蝦皮分攤明細\n";
finalItems.forEach(i=>{
text+=`${i.name} x${i.qty} = $${i.subtotal}\n`;
});
text+=`總計 $${currentTotal}`;
navigator.clipboard.writeText(text);
toast.style.display="block";
setTimeout(()=>toast.style.display="none",2000);
}

/* CSV */
function exportCSV(){
let csv="品項,數量,單價,小計\n";
finalItems.forEach(i=>{
csv+=`${i.name},${i.qty},${i.unit},${i.subtotal}\n`;
});
const blob=new Blob([csv]);
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="shopee_calc.csv";
a.click();
}

/* 儲存 */
function saveData(){

const rows=document.querySelectorAll(".item-row");

let items=[];
rows.forEach(r=>{
items.push({
name:r.querySelector(".name").value,
price:r.querySelector(".price").value,
qty:r.querySelector(".qty").value,
participate:r.querySelector(".participate").checked
});
});

const data={
version:4,
shopeeCoupon:shopeeCoupon.value,
storeCoupon:storeCoupon.value,
shippingFee:shippingFee.value,
shippingMode:shippingMode.value,
coins:coins.value,
items:items
};

localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
}
function loadData(){

const raw=localStorage.getItem(STORAGE_KEY);
if(!raw) {
addItem(); 
return;
}

const data=JSON.parse(raw);

shopeeCoupon.value=data.shopeeCoupon||"";
storeCoupon.value=data.storeCoupon||"";
shippingFee.value=data.shippingFee||"";
shippingMode.value=data.shippingMode||"ratio";
coins.value=data.coins||"";

document.getElementById("items").innerHTML="";

if(data.items && data.items.length>0){
data.items.forEach(item=>{
addItem(item);
});
}else{
addItem();
}

calculate();
}
window.onload=loadData;

function clearAll(){
if(confirm("確定清除所有暫存資料？")){
localStorage.removeItem(STORAGE_KEY);
location.reload();
}
}

</script>
</body>
</html>

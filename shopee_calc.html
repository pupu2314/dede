<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>蝦皮折扣分攤計算機</title>

<style>
:root{
--orange:#ee4d2d;
--bg:#f5f5f5;
--green:#26af61;
--red:#ff4d4f;
}
body{
margin:0;
font-family:"Microsoft JhengHei",sans-serif;
background:var(--bg);
}
.container{
max-width:720px;
margin:auto;
padding:20px;
}
.card{
background:#fff;
padding:20px;
border-radius:12px;
box-shadow:0 6px 20px rgba(0,0,0,.08);
}
h2{
text-align:center;
color:var(--orange);
border-bottom:2px solid var(--orange);
padding-bottom:10px;
}
.section{margin-top:20px;}
input,select{
width:100%;
padding:10px;
border:1px solid #ddd;
border-radius:6px;
margin-top:6px;
box-sizing:border-box;
}
input:focus{border-color:var(--orange);outline:none;}
.input-error{border-color:var(--red)!important;background:#fff1f0;}
.item-card{
border:1px solid #eee;
padding:12px;
border-radius:8px;
margin-bottom:10px;
}
.item-grid{
display:grid;
grid-template-columns:1fr 1fr;
gap:8px;
}
.item-actions{
display:flex;
justify-content:space-between;
align-items:center;
margin-top:8px;
}
button{
padding:10px 12px;
border:none;
border-radius:6px;
cursor:pointer;
font-weight:bold;
}
.btn-orange{background:var(--orange);color:white;}
.btn-green{background:var(--green);color:white;}
.btn-gray{background:#eee;}
.result-box{
margin-top:20px;
background:#fff8f6;
padding:15px;
border-radius:8px;
display:none;
}
.highlight{color:var(--orange);font-size:20px;font-weight:bold;}
table{
width:100%;
border-collapse:collapse;
margin-top:10px;
}
th,td{
border:1px solid #eee;
padding:6px;
text-align:center;
font-size:14px;
}
.toast{
position:fixed;
bottom:20px;
left:50%;
transform:translateX(-50%);
background:black;
color:white;
padding:6px 15px;
border-radius:20px;
display:none;
}
</style>
</head>
<body>

<div class="container">
<div class="card">

<h2>蝦皮折扣分攤計算機</h2>

<div class="section">
<h4>折扣與運費</h4>
<input type="number" id="shopeeCoupon" placeholder="蝦皮優惠券">
<input type="number" id="storeCoupon" placeholder="賣場優惠券">
<input type="number" id="shippingFee" placeholder="運費自付額">
<select id="shippingMode">
<option value="ratio">運費按金額比例分攤</option>
<option value="average">運費平均分攤</option>
<option value="self">運費不分攤</option>
</select>
</div>

<div class="section">
<h4>品項明細</h4>
<div id="items"></div>
<button class="btn-gray" onclick="addItem()">+ 新增品項</button>
</div>

<div class="section">
<button class="btn-orange" onclick="calculate()">重新計算</button>
<button class="btn-green" onclick="exportCSV()">匯出CSV</button>
<button class="btn-gray" onclick="clearMemory()">清除記憶</button>
</div>

<div class="result-box" id="resultBox">
<h4>計算結果</h4>
<div id="summary"></div>
<table>
<thead>
<tr>
<th>品項</th>
<th>數量</th>
<th>最終單價</th>
<th>小計</th>
</tr>
</thead>
<tbody id="resultTable"></tbody>
</table>

<div style="margin-top:10px;">
<input type="number" id="coins" placeholder="蝦幣折抵">
<div>最後實付：<span class="highlight" id="finalCash">$0</span></div>
</div>

<button class="btn-green" onclick="copyText()">複製分享文字</button>
</div>

</div>
</div>

<div class="toast" id="toast">已複製</div>

<script>
const STORAGE_KEY="shopee_calc_pro_v5";
let finalItems=[];
let currentTotal=0;

/* debounce */
let timer;
document.addEventListener("input",()=>{
clearTimeout(timer);
timer=setTimeout(calculate,300);
saveData();
});

/* 新增品項 */
function addItem(data={}){
const div=document.createElement("div");
div.className="item-card";
div.innerHTML=`
<input type="text" class="name" placeholder="品名" value="${data.name||''}">
<div class="item-grid">
<input type="number" class="price" placeholder="單價" value="${data.price||''}">
<input type="number" class="qty" placeholder="數量" value="${data.qty||''}">
</div>
<div class="item-actions">
<label><input type="checkbox" class="participate" ${data.participate!==false?'checked':''}>參與折扣</label>
<button onclick="this.parentElement.parentElement.remove();calculate()">刪除</button>
</div>`;
document.getElementById("items").appendChild(div);
}

/* 核心計算 */
function calculate(){

const rows=document.querySelectorAll(".item-card");
let items=[];
let originalTotal=0;

/* 保留每一列獨立 index */
rows.forEach((r,i)=>{
const p=parseFloat(r.querySelector(".price").value);
const q=parseInt(r.querySelector(".qty").value);
const name=r.querySelector(".name").value||"品項"+(i+1);
const participate=r.querySelector(".participate").checked;

if(p>0&&q>0){
items.push({
index:i,
name,
price:p,
qty:q,
participate
});
originalTotal+=p*q;
}
});

if(originalTotal<=0)return;

const shopee=parseFloat(shopeeCoupon.value)||0;
const store=parseFloat(storeCoupon.value)||0;
const shipping=parseFloat(shippingFee.value)||0;

if(shopee+store>originalTotal){
alert("折扣不可超過商品總額");
return;
}

/* ===== 單位展開 ===== */

let units=[];

items.forEach(item=>{
for(let i=0;i<item.qty;i++){
units.push({
itemIndex:item.index,
name:item.name,
price:item.price,
participate:item.participate
});
}
});

/* 折扣基準 */
let discountBase=units
.filter(u=>u.participate)
.reduce((a,b)=>a+b.price,0);

/* 理論值 */
let theoreticalUnits=units.map(unit=>{

let discountShare=unit.participate
? (unit.price/discountBase)*(shopee+store)
:0;

let shippingShare=0;

if(shippingMode.value==="ratio"){
shippingShare=shipping*(unit.price/originalTotal);
}
else if(shippingMode.value==="average"){
shippingShare=shipping/units.length;
}

return unit.price-discountShare+shippingShare;
});

/* floor */
let unitObjects=theoreticalUnits.map((v,i)=>({
index:i,
itemIndex:units[i].itemIndex,
price:units[i].price,
floor:Math.floor(v),
fraction:v-Math.floor(v)
}));

let floorSum=unitObjects.reduce((a,b)=>a+b.floor,0);
let theoreticalSum=theoreticalUnits.reduce((a,b)=>a+b,0);
let diff=Math.round(theoreticalSum-floorSum);

/* 尾數由最高單價優先承擔 */
unitObjects.sort((a,b)=>{
if(b.price!==a.price) return b.price-a.price;
return b.fraction-a.fraction;
});

for(let i=0;i<diff;i++){
unitObjects[i].floor++;
}

unitObjects.sort((a,b)=>a.index-b.index);

/* ===== 聚合回原列（不合併同名）===== */

let rowMap={};

unitObjects.forEach(u=>{
if(!rowMap[u.itemIndex]){
rowMap[u.itemIndex]={
subtotal:0,
qty:0
};
}
rowMap[u.itemIndex].subtotal+=u.floor;
rowMap[u.itemIndex].qty++;
});

/* 組裝結果 */
finalItems=[];

items.forEach(item=>{
let row=rowMap[item.index];
let unit=Math.floor(row.subtotal/row.qty); // 不再 round
finalItems.push({
name:item.name,
qty:item.qty,
unit:unit,
subtotal:row.subtotal
});
});

currentTotal=Object.values(rowMap)
.reduce((a,b)=>a+b.subtotal,0);

renderResult(originalTotal,shopee+store,shipping);
  }

function updateFinal(){
const c=parseFloat(coins.value)||0;
if(c>currentTotal){
coins.classList.add("input-error");
}else{
coins.classList.remove("input-error");
}
finalCash.innerText="$"+Math.max(0,currentTotal-c);
}
coins.addEventListener("input",updateFinal);

/* Clipboard */
function copyText(){
let text="蝦皮分攤明細\n";
finalItems.forEach(i=>{
text+=`${i.name} x${i.qty} = $${i.subtotal}\n`;
});
text+=`總計 $${currentTotal}`;
navigator.clipboard.writeText(text);
toast.style.display="block";
setTimeout(()=>toast.style.display="none",2000);
}

/* CSV */
function exportCSV(){
let csv="品項,數量,單價,小計\n";
finalItems.forEach(i=>{
csv+=`${i.name},${i.qty},${i.unit},${i.subtotal}\n`;
});
const blob=new Blob([csv]);
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="shopee_calc.csv";
a.click();
}

/* 暫存 */
function saveData(){
const rows=document.querySelectorAll(".item-card");
let items=[];
rows.forEach(r=>{
items.push({
name:r.querySelector(".name").value,
price:r.querySelector(".price").value,
qty:r.querySelector(".qty").value,
participate:r.querySelector(".participate").checked
});
});
localStorage.setItem(STORAGE_KEY,JSON.stringify({
version:5,
shopeeCoupon:shopeeCoupon.value,
storeCoupon:storeCoupon.value,
shippingFee:shippingFee.value,
shippingMode:shippingMode.value,
coins:coins.value,
items:items
}));
}

function loadData(){
const raw=localStorage.getItem(STORAGE_KEY);
if(!raw){addItem();return;}
const data=JSON.parse(raw);
if(data.version!==5){addItem();return;}

shopeeCoupon.value=data.shopeeCoupon||"";
storeCoupon.value=data.storeCoupon||"";
shippingFee.value=data.shippingFee||"";
shippingMode.value=data.shippingMode||"ratio";
coins.value=data.coins||"";

document.getElementById("items").innerHTML="";
if(data.items&&data.items.length>0){
data.items.forEach(i=>addItem(i));
}else{
addItem();
}
calculate();
}

function clearMemory(){
if(confirm("確定清除所有暫存資料？")){
localStorage.removeItem(STORAGE_KEY);
location.reload();
}
}

window.onload=loadData;
</script>

</body>
</html>

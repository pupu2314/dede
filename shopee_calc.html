<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>æŠ˜æ‰£åˆ†æ”¤è¨ˆç®—æ©Ÿ (åˆ†äº«å„ªåŒ–ç‰ˆ)</title>

<style>
/* åŸºç¤è¨­å®š */
*{box-sizing:border-box}
body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft JhengHei",sans-serif;
    background:#f4f6f8;
    color: #333;
}

.container{
    max-width:720px;
    margin:auto;
    padding:16px;
}

.card{
    background:#fff;
    padding:20px;
    border-radius:16px;
    box-shadow:0 4px 20px rgba(0,0,0,.05);
}

h2{
    text-align:center;
    color:#ee4d2d;
    margin:0 0 20px 0;
    font-size: 1.5rem;
}

/* æ¨™é¡Œèˆ‡å€å¡Š */
.section-title{
    margin-top:20px;
    margin-bottom: 8px;
    font-weight:700;
    font-size:14px;
    color:#555;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* è¼¸å…¥æ¡†æ¨£å¼ */
.input-group {
    margin-bottom: 10px;
}

input, select {
    width:100%;
    padding:12px;
    border:1px solid #ddd;
    border-radius:10px;
    font-size:16px;
    transition: border-color 0.2s;
    background: #fff;
}

input:focus, select:focus {
    outline: none;
    border-color: #ee4d2d;
}

/* å…©æ¬„ä½ˆå±€ */
.grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

/* å•†å“å¡ç‰‡ */
.item-card{
    background:#fafafa;
    padding:12px;
    border-radius:12px;
    margin-bottom:10px;
    border:1px solid #eee;
    position: relative;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

.item-row {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

.btn-delete {
    background: #fff0f0;
    color: #ff4d4f;
    border: 1px solid #ffccc7;
    padding: 8px 12px;
    border-radius: 8px;
    margin-top: 8px;
    font-size: 13px;
    width: 100%;
}

/* æŒ‰éˆ•ç¾¤çµ„ */
.actions{
    display:flex;
    gap:10px;
    margin-top:20px;
}

button{
    padding:12px;
    border:none;
    border-radius:10px;
    font-size:15px;
    font-weight:600;
    cursor:pointer;
    flex: 1;
    transition: opacity 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}
button:active { opacity: 0.8; }

.btn-primary{background:#ee4d2d;color:#fff}
.btn-secondary{background:#e0e0e0; color: #333;}
.btn-danger{background:#ff4d4f;color:#fff}
.btn-copy{background:#28a745; color:#fff; width: 100%; margin-top: 15px;}

/* çµæœå€å¡Š */
.result-box{
    margin-top:24px;
    background:#fff7f5;
    padding:16px;
    border-radius:14px;
    border: 1px solid #ffe4de;
    display:none;
}

.summary-text {
    line-height: 1.6;
    color: #444;
    margin-bottom: 12px;
    font-size: 14px;
}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    font-size:14px;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

th {
    background: #eee;
    color: #333;
    font-weight: 600;
}

th,td{
    border-bottom:1px solid #f0f0f0;
    padding:10px 8px;
    text-align:center;
}

td:first-child { text-align: left; }
tr:last-child td { border-bottom: none; }

.highlight{
    font-size:24px;
    font-weight:800;
    color:#ee4d2d;
}

.error-msg {
    color: #ff4d4f;
    font-size: 12px;
    margin-top: 4px;
    display: none;
}

.shipping-row { background-color: #e6f7ff; color: #0050b3; font-weight: bold; }
.diff-row { background-color: #fffbe6; color: #faad14; font-weight: bold; }
</style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>æŠ˜æ‰£åˆ†æ”¤è¨ˆç®—æ©Ÿ</h2>

        <!-- è¨­å®š -->
        <div class="section-title">è²»ç”¨è¨­å®š</div>
        <div class="grid-2">
            <input type="number" id="shopeeCoupon" placeholder="è¦çš®å„ªæƒ åˆ¸ (-)" min="0">
            <input type="number" id="storeCoupon" placeholder="è³£å ´å„ªæƒ åˆ¸ (-)" min="0">
        </div>
        
        <div class="grid-2" style="margin-top:10px;">
            <input type="number" id="shippingFee" placeholder="é‹è²» (+)" min="0">
            <select id="shippingMethod">
                <option value="separate">é‹è²»ç¨ç«‹åˆ—é …</option>
                <option value="distribute">é‹è²»å‡æ”¤è‡³å•†å“</option>
            </select>
        </div>
        <div id="topError" class="error-msg"></div>

        <!-- å•†å“ -->
        <div class="section-title">
            å•†å“æ˜ç´°
            <small id="itemCount" style="font-weight:normal; color:#888">(0é …)</small>
        </div>
        <div id="itemsContainer"></div>

        <div class="actions">
            <button class="btn-secondary" onclick="addNewItem()">+ æ–°å¢å“é …</button>
            <button class="btn-danger" onclick="clearAll()">æ¸…é™¤é‡ç½®</button>
        </div>

        <!-- çµæœ -->
        <div class="result-box" id="resultBox">
            <div id="summary" class="summary-text"></div>

            <table>
                <thead>
                    <tr>
                        <th width="35%">å“é …</th>
                        <th width="15%">æ•¸é‡</th>
                        <th width="25%">å–®åƒ¹</th>
                        <th width="25%">å°è¨ˆ</th>
                    </tr>
                </thead>
                <tbody id="resultTable"></tbody>
            </table>
            
            <button class="btn-copy" onclick="copyResultText()">
                ğŸ“‹ è¤‡è£½æ–‡å­—ä¾›åˆ†äº«
            </button>

            <div style="margin-top:16px; border-top: 1px dashed #ee4d2d; padding-top: 16px;">
                <input type="number" id="coins" placeholder="è¼¸å…¥è¦å¹£æŠ˜æŠµ (-)" style="margin-bottom: 8px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span>æœ€å¾Œå¯¦ä»˜ç¾é‡‘ï¼š</span>
                    <span class="highlight" id="finalCash">$0</span>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
// DOM å…ƒç´ 
const els = {
    shopeeCoupon: document.getElementById('shopeeCoupon'),
    storeCoupon: document.getElementById('storeCoupon'),
    shippingFee: document.getElementById('shippingFee'),
    shippingMethod: document.getElementById('shippingMethod'),
    coins: document.getElementById('coins'),
    itemsContainer: document.getElementById('itemsContainer'),
    resultBox: document.getElementById('resultBox'),
    resultTable: document.getElementById('resultTable'),
    summary: document.getElementById('summary'),
    finalCash: document.getElementById('finalCash'),
    topError: document.getElementById('topError'),
    itemCount: document.getElementById('itemCount')
};

let debounceTimer = null;
let currentResultData = null; // ç”¨æ–¼å„²å­˜è¤‡è£½æ‰€éœ€çš„è³‡æ–™

// é˜²æŠ–å‹•è¨ˆç®—
function triggerCalculate() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(calculate, 300);
}

// ç›£è½
[els.shopeeCoupon, els.storeCoupon, els.shippingFee, els.shippingMethod, els.coins].forEach(el => {
    el.addEventListener('input', () => { saveToStorage(); triggerCalculate(); });
});

// æ–°å¢å“é …
function addNewItem(data = {}) {
    const div = document.createElement("div");
    div.className = "item-card";
    div.innerHTML = `
        <input type="text" class="item-name" placeholder="å“å" value="${data.name || ''}">
        <div class="item-row">
            <input type="number" class="item-price" placeholder="å–®åƒ¹" inputmode="numeric" value="${data.price || ''}">
            <input type="number" class="item-qty" placeholder="æ•¸é‡" inputmode="numeric" value="${data.qty || ''}">
        </div>
        <button class="btn-delete">åˆªé™¤</button>
    `;
    div.querySelector('.btn-delete').addEventListener('click', () => {
        div.remove(); saveToStorage(); triggerCalculate(); updateCount();
    });
    div.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', () => { saveToStorage(); triggerCalculate(); });
    });
    els.itemsContainer.appendChild(div);
    updateCount();
}

function updateCount() {
    els.itemCount.innerText = `(${els.itemsContainer.querySelectorAll('.item-card').length}é …)`;
}

// æ ¸å¿ƒè¨ˆç®—
function calculate() {
    const rows = els.itemsContainer.querySelectorAll(".item-card");
    let itemsData = [];
    let goodsTotal = 0;

    rows.forEach((r, i) => {
        let name = r.querySelector(".item-name").value || `å“é … ${i + 1}`;
        let price = parseFloat(r.querySelector(".item-price").value) || 0;
        let qty = parseInt(r.querySelector(".item-qty").value) || 0;

        if (price > 0 && qty > 0) {
            itemsData.push({ id: i, name, price, qty, totalRaw: price * qty });
            goodsTotal += price * qty;
        }
    });

    if (goodsTotal <= 0) { els.resultBox.style.display = "none"; return; }

    const shopeeDisc = parseFloat(els.shopeeCoupon.value) || 0;
    const storeDisc = parseFloat(els.storeCoupon.value) || 0;
    const totalDisc = shopeeDisc + storeDisc;
    const shipping = parseFloat(els.shippingFee.value) || 0;
    const isShippingSeparate = els.shippingMethod.value === 'separate';

    if (totalDisc > goodsTotal) {
        els.topError.style.display = 'block';
        els.topError.innerText = 'éŒ¯èª¤ï¼šæŠ˜æ‰£é‡‘é¡å¤§æ–¼å•†å“ç¸½é¡';
        els.resultBox.style.display = "none";
        return;
    } else {
        els.topError.style.display = 'none';
    }

    let targetDistributeTotal = goodsTotal - totalDisc;
    if (!isShippingSeparate) targetDistributeTotal += shipping;

    // --- è¨ˆç®—éšæ®µ 1: ç„¡æ¢ä»¶æ¨å» ---
    let ratio = targetDistributeTotal / goodsTotal;
    let currentCalculatedTotal = 0;

    itemsData.forEach(item => {
        item.finalUnit = Math.floor(item.price * ratio);
        if(item.finalUnit < 0) item.finalUnit = 0;
        item.finalTotal = item.finalUnit * item.qty;
        currentCalculatedTotal += item.finalTotal;
    });

    let diff = targetDistributeTotal - currentCalculatedTotal;

    // --- è¨ˆç®—éšæ®µ 2: æ™ºæ…§æ¶ˆé™¤åƒ¹å·® ---
    if (diff > 0) {
        let sortedItems = [...itemsData].sort((a, b) => b.totalRaw - a.totalRaw);
        for (let item of sortedItems) {
            if (diff % item.qty === 0) {
                let addPerUnit = diff / item.qty;
                let targetItem = itemsData.find(i => i.id === item.id);
                targetItem.finalUnit += addPerUnit;
                targetItem.finalTotal += diff;
                diff = 0;
                break; 
            }
        }
    }

    renderResult(itemsData, goodsTotal, totalDisc, shipping, isShippingSeparate, targetDistributeTotal, diff);
    saveToStorage();
}

function renderResult(items, goodsTotal, totalDisc, shipping, isShippingSeparate, distributedTotal, diff) {
    els.resultBox.style.display = "block";
    els.resultTable.innerHTML = "";

    // å„²å­˜è³‡æ–™ä¾›è¤‡è£½ä½¿ç”¨
    currentResultData = {
        items, goodsTotal, totalDisc, shipping, isShippingSeparate, distributedTotal, diff
    };

    let shippingText = isShippingSeparate ? "é‹è²»(ç¨ç«‹)" : "é‹è²»(å«)";
    els.summary.innerHTML = `
        å•†å“åŸé¡ï¼š$${goodsTotal}<br>
        ç¸½æŠ˜æ‰£ï¼š-$${totalDisc}<br>
        ${shippingText}ï¼š+$${shipping}<br>
        <div style="margin-top:4px; font-weight:bold;">åˆ†æ”¤å¾Œç¸½è¨ˆï¼š$${isShippingSeparate ? distributedTotal + shipping : distributedTotal}</div>
    `;

    // æ¸²æŸ“å•†å“
    items.forEach(item => {
        let tr = document.createElement("tr");
        tr.innerHTML = `<td>${item.name}</td><td>${item.qty}</td><td>$${item.finalUnit}</td><td>$${item.finalTotal}</td>`;
        els.resultTable.appendChild(tr);
    });

    // æ¸²æŸ“åƒ¹å·®
    let grandTotal = distributedTotal;
    if (diff > 0) {
        let tr = document.createElement("tr");
        tr.className = "diff-row";
        tr.innerHTML = `<td>åƒ¹å·®(è£œ)</td><td>1</td><td>$${diff}</td><td>$${diff}</td>`;
        els.resultTable.appendChild(tr);
    }

    // æ¸²æŸ“é‹è²»(ç¨ç«‹)
    if (isShippingSeparate && shipping > 0) {
        let tr = document.createElement("tr");
        tr.className = "shipping-row";
        tr.innerHTML = `<td>é‹è²»</td><td>1</td><td>$${shipping}</td><td>$${shipping}</td>`;
        els.resultTable.appendChild(tr);
        grandTotal += shipping;
    }

    updateFinalCash(grandTotal);
}

function updateFinalCash(grandTotal) {
    let coinsVal = parseFloat(els.coins.value) || 0;
    let final = Math.max(0, grandTotal - coinsVal);
    els.finalCash.innerText = "$" + final;
    
    // æ›´æ–°è¤‡è£½è³‡æ–™ä¸­çš„æœ€çµ‚é‡‘é¡
    if(currentResultData) {
        currentResultData.finalCash = final;
        currentResultData.coins = coinsVal;
    }
}

// è¤‡è£½æ–‡å­—åŠŸèƒ½ (å·²æ ¹æ“šéœ€æ±‚èª¿æ•´æ ¼å¼)
function copyResultText() {
    if (!currentResultData) return;
    const d = currentResultData;
    
    let text = `ã€åˆ†æ”¤è¨ˆç®—çµæœã€‘\n`;
    text += `å•†å“åŸé¡ï¼š$${d.goodsTotal}\n`;
    text += `ç¸½æŠ˜æ‰£ï¼š-$${d.totalDisc}\n`;
    text += `é‹è²»ï¼š$${d.shipping} (${d.isShippingSeparate ? 'ç¨ç«‹åˆ—é …' : 'å·²å‡æ”¤'})\n`;
    text += `----------------\n`;
    
    d.items.forEach(item => {
        text += `${item.name} x${item.qty} = $${item.finalTotal}`;
        if (item.qty > 1) {
            text += ` ($${item.finalUnit}/å€‹)`;
        }
        text += `\n`;
    });

    if (d.diff > 0) {
        text += `âš ï¸ åƒ¹å·®/é¤˜æ•¸ = $${d.diff}\n`;
    }

    // è‹¥é‹è²»æ˜¯ç¨ç«‹åˆ—é …ï¼Œä¸‹æ–¹å†åˆ—ä¸€æ¬¡ï¼Œæˆ–è€…åªåœ¨ä¸Šæ–¹é¡¯ç¤ºçš†å¯ã€‚
    // ç‚ºäº†å°å¸³æ–¹ä¾¿ï¼Œé€™è£¡é¸æ“‡è‹¥ç‚ºç¨ç«‹é‹è²»ï¼Œåœ¨æ˜ç´°ä¸­ä¹Ÿåˆ—å‡ºè¼ƒç‚ºæ¸…æ¥šã€‚
    if (d.isShippingSeparate && d.shipping > 0) {
        text += `ğŸšš é‹è²» = $${d.shipping}\n`;
    }

    text += `----------------\n`;
    
    if (d.coins > 0) {
        text += `ğŸ’° è¦å¹£æŠ˜æŠµï¼š-$${d.coins}\n`;
    }
    
    text += `æœ€å¾Œå¯¦ä»˜ï¼š$${d.finalCash}\n`;
    
    // åŸ·è¡Œè¤‡è£½
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼"));
    } else {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand("copy");
        document.body.removeChild(textArea);
        alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
    }
}

// å„²å­˜èˆ‡è®€å–
function saveToStorage() {
    const rows = els.itemsContainer.querySelectorAll(".item-card");
    let data = {
        shopee: els.shopeeCoupon.value, store: els.storeCoupon.value,
        shipping: els.shippingFee.value, method: els.shippingMethod.value,
        coins: els.coins.value, items: []
    };
    rows.forEach(r => {
        data.items.push({
            name: r.querySelector(".item-name").value,
            price: r.querySelector(".item-price").value,
            qty: r.querySelector(".item-qty").value
        });
    });
    localStorage.setItem("shopeeCalcData_v5", JSON.stringify(data));
}

function loadFromStorage() {
    let json = localStorage.getItem("shopeeCalcData_v5") || localStorage.getItem("shopeeCalcData_v4") || localStorage.getItem("shopeeCalcData_v3");
    if (!json) { addNewItem(); return; }
    try {
        let data = JSON.parse(json);
        els.shopeeCoupon.value = data.shopee || "";
        els.storeCoupon.value = data.store || "";
        els.shippingFee.value = data.shipping || "";
        els.shippingMethod.value = data.method || "separate";
        els.coins.value = data.coins || "";
        els.itemsContainer.innerHTML = "";
        if (data.items && data.items.length) data.items.forEach(i => addNewItem(i));
        else addNewItem();
        setTimeout(calculate, 100);
    } catch (e) { addNewItem(); }
}

function clearAll() {
    if(confirm('ç¢ºå®šæ¸…é™¤ï¼Ÿ')) {
        localStorage.removeItem("shopeeCalcData_v5");
        location.reload();
    }
}

window.addEventListener("load", loadFromStorage);
</script>

</body>
</html>


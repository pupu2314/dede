<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>電動摩托車紀錄系統</title>
    
    <!-- PWA 設定 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <link rel="stylesheet" href="motolog.css">
</head>
<body>
    <!-- 置頂懸浮備份提示容器 -->
    <div id="topAlert" class="top-alert"></div>

    <div class="container">
        <div class="header">
            <h1>🏍️ 電動摩托車紀錄</h1>
        </div>
        
        <div class="dashboard">
            <div class="stat-card">
                <h3>總里程</h3>
                <div class="value" id="totalMileage">0</div>
                <div class="subtitle">公里</div>
            </div>
            <div class="stat-card">
                <h3>上次充電</h3>
                <div class="value" id="lastChargeDays">-</div>
                <div class="subtitle" id="lastChargeDate">無記錄</div>
            </div>
            <div class="stat-card">
                <h3>下次保養</h3>
                <div class="value" id="nextServiceStatus">正常</div>
                <div class="subtitle" id="nextServiceDate">待記錄</div>
            </div>
            <div class="stat-card">
                <h3>總花費</h3>
                <div class="value" id="totalExpense">0</div>
                <div class="subtitle">元</div>
            </div>
        </div>
        
        <!-- 底部導覽列 -->
        <nav class="tabs">
            <button class="tab active" data-tab="tab-charge"><i class="icon-bolt"></i> 充電</button>
            <button class="tab" data-tab="tab-service"><i class="icon-wrench"></i> 保養</button>
            <button class="tab" data-tab="tab-expense"><i class="icon-credit-card"></i> 花費</button>
            <button class="tab" data-tab="tab-log"><i class="icon-list"></i> 紀錄</button>
            <button class="tab" data-tab="tab-settings"><i class="icon-settings"></i> 設定</button>
        </nav>
        
        <!-- 頁面內容 -->
        <div class="content">
            
            <!-- 1. 充電頁面 -->
            <div class="tab-content active" id="tab-charge">
                <div class="card">
                    <h2>記錄充電</h2>
                    <form id="chargeForm">
                        <div class="form-group">
                            <label for="chargeMileage">目前里程 (公里)</label>
                            <input type="number" id="chargeMileage" required>
                        </div>
                        <div class="form-group">
                            <label for="chargeKWh">充電度數 (kWh)</label>
                            <input type="number" id="chargeKWh" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="chargeCost">花費金額 (元)</label>
                            <input type="number" id="chargeCost" required>
                        </div>
                        <div class="form-group">
                            <label for="chargeStation">充電地點</label>
                            <select id="chargeStation">
                                <option value="家裡">家裡</option>
                                <option value="公司">公司</option>
                                <option value="充電站">充電站</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="chargeNotes">備註 (選填)</label>
                            <input type="text" id="chargeNotes">
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">記錄充電</button>
                    </form>
                </div>
            </div>
            
            <!-- 2. 保養頁面 -->
            <div class="tab-content" id="tab-service">
                <div class="card">
                    <h2>記錄保養</h2>
                    <form id="serviceForm">
                        <div class="form-group">
                            <label for="serviceMileage">目前里程 (公里)</label>
                            <input type="number" id="serviceMileage" required>
                        </div>
                        <div class="form-group">
                            <label for="serviceName">項目</label>
                            <select id="serviceName" required onchange="updateServiceCost()">
                                <option value="">請選擇項目</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label for="serviceCost">花費金額 (元)</label>
                            <input type="number" id="serviceCost" required>
                        </div>
                        <div class="form-group">
                            <label for="serviceNotes">備註 (選填)</label>
                            <input type="text" id="serviceNotes">
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">記錄保養</button>
                    </form>
                    
                    <div class="section-title">歷史保養紀錄</div>
                    <div id="serviceHistoryList" class="log-list">
                        <!-- 歷史保養紀錄將會動態插入這裡 -->
                    </div>
                </div>
            </div>

            <!-- 3. 花費頁面 -->
            <div class="tab-content" id="tab-expense">
                <div class="card">
                    <h2>記錄其他花費</h2>
                    <form id="expenseForm">
                        <div class="form-group">
                            <label for="expenseName">項目</label>
                            <input type="text" id="expenseName" required>
                        </div>
                        <div class="form-group">
                            <label for="expenseCost">花費金額 (元)</label>
                            <input type="number" id="expenseCost" required>
                        </div>
                        <div class="form-group">
                            <label for="expenseDate">日期</label>
                            <input type="date" id="expenseDate" required>
                        </div>
                         <div class="form-group">
                            <label for="expenseTime">時間</label>
                            <input type="time" id="expenseTime" required>
                        </div>
                        <div class="form-group">
                            <label for="expenseNotes">備註 (選填)</label>
                            <input type="text" id="expenseNotes">
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">記錄花費</button>
                    </form>

                    <div class="section-title">歷史花費紀錄</div>
                    <div id="expenseHistoryList" class="log-list">
                        <!-- 歷史花費紀錄將會動態插入這裡 -->
                    </div>
                </div>
            </div>

            <!-- 4. 紀錄與分析頁面 -->
            <div class="tab-content" id="tab-log">
                <div class="card">
                    <h2>紀錄篩選</h2>
                    <div class="form-group">
                        <label for="logMonthFilter">篩選月份</label>
                        <input type="month" id="logMonthFilter" onchange="renderLogs()">
                    </div>
                    
                    <!-- 新增的重新計算電費按鈕容器 -->
                    <div class="log-actions-container">
                         <button id="recalculateChargeBtn" class="btn btn-secondary btn-small" onclick="recalculateChargeCost()">
                            <i class="icon-refresh"></i> 重新計算電費
                        </button>
                    </div>

                    <div class="section-title">充電紀錄</div>
                    <div id="chargeLogList" class="log-list">
                        <!-- 充電紀錄將會動態插入這裡 -->
                    </div>
                    
                    <div class="section-title">保養紀錄</div>
                    <div id="maintenanceLogList" class="log-list">
                        <!-- 保養紀錄將會動態插入這裡 -->
                    </div>
                    
                    <div class="section-title">花費紀錄</div>
                    <div id="expenseLogList" class="log-list">
                        <!-- 花費紀錄將會動態插入這裡 -->
                    </div>
                </div>
            </div>

            <!-- 5. 設定頁面 -->
            <div class="tab-content" id="tab-settings">
                <div class="card">
                    <h2>基礎設定</h2>
                    <form id="settingsForm">
                        <div class="form-group">
                            <label for="initialMileage">起始里程 (公里)</label>
                            <input type="number" id="initialMileage" required>
                        </div>
                        <div class="form-group">
                            <label for="serviceIntervalKm">定期保養里程 (公里)</label>
                            <input type="number" id="serviceIntervalKm" required>
                        </div>
                        <div class="form-group">
                            <label for="serviceIntervalDays">定期保養天數 (天)</label>
                            <input type="number" id="serviceIntervalDays" required>
                        </div>
                        <div class="form-group">
                            <label for="serviceTemplates">預設保養項目 (JSON 格式)</label>
                            <textarea id="serviceTemplates" rows="6" required></textarea>
                            <small class="text-muted">格式範例: `[{"name":"項目名","cost":100}]`</small>
                        </div>
                        <div class="form-group">
                            <label for="pricePerKWh">電費單價 (元/度)</label>
                            <input type="number" id="pricePerKWh" step="0.01" required>
                            <small class="text-muted">用於重新計算家裡/公司充電費用</small>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">儲存設定</button>
                    </form>
                </div>
                
                <div class="card mt-4">
                    <h2>雲端同步 (Google Sheets)</h2>
                    <div class="form-group">
                        <label for="gasUrl">Google Apps Script API 網址</label>
                        <input type="url" id="gasUrl" placeholder="以 /exec 結尾的網址">
                        <small class="text-muted"><a href="#" onclick="showTutorialModal(event)">如何設定？</a></small>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-success" onclick="syncToGoogleSheets()"><i class="icon-cloud-upload"></i> 手動同步至雲端</button>
                        <button class="btn btn-warning" onclick="restoreFromGoogleSheets()"><i class="icon-cloud-download"></i> 從雲端還原 (覆蓋)</button>
                    </div>
                    <div class="sync-status" id="syncStatus">
                        同步狀態：未同步
                    </div>
                </div>
                
                <div class="card mt-4">
                    <h2>資料管理</h2>
                    <button class="btn btn-danger btn-full" onclick="showExportDataModal()">匯出/匯入資料</button>
                    <button class="btn btn-danger btn-full mt-2" onclick="showResetModal()">⚠️ 清除所有資料</button>
                </div>
                
                <div class="app-info">
                    版本：<span id="appVersion"></span> | 最後更新：<span id="lastUpdated"></span> | <span id="onlineStatus"></span>
                </div>
            </div>
            
        </div> <!-- end .content -->
    </div> <!-- end .container -->

    <!-- Modal: 編輯花費紀錄 -->
    <div id="editExpenseModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeExpenseModal">&times;</span>
            <h2>編輯花費紀錄</h2>
            <form id="editExpenseForm">
                <input type="hidden" id="editExpenseId">
                <div class="form-group">
                    <label for="editExpenseName">項目</label>
                    <input type="text" id="editExpenseName" required>
                </div>
                <div class="form-group">
                    <label for="editExpenseCost">花費金額 (元)</label>
                    <input type="number" id="editExpenseCost" required>
                </div>
                <div class="form-group">
                    <label for="editExpenseDate">日期</label>
                    <input type="date" id="editExpenseDate" required>
                </div>
                <div class="form-group">
                    <label for="editExpenseTime">時間</label>
                    <input type="time" id="editExpenseTime" required>
                </div>
                <div class="form-group">
                    <label for="editExpenseNotes">備註 (選填)</label>
                    <input type="text" id="editExpenseNotes">
                </div>
                <button type="submit" class="btn btn-primary btn-full">儲存修改</button>
            </form>
        </div>
    </div>
    
    <!-- Modal: 編輯保養紀錄 -->
    <div id="editServiceModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeServiceModal">&times;</span>
            <h2>編輯保養紀錄</h2>
            <form id="editServiceForm">
                <input type="hidden" id="editServiceId">
                 <div class="form-group">
                    <label for="editServiceMileage">里程 (公里)</label>
                    <input type="number" id="editServiceMileage" required>
                </div>
                <div class="form-group">
                    <label for="editServiceName">項目</label>
                    <select id="editServiceName" required>
                         <option value="">請選擇項目</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editServiceCost">花費金額 (元)</label>
                    <input type="number" id="editServiceCost" required>
                </div>
                <div class="form-group">
                    <label for="editServiceDate">日期</label>
                    <input type="date" id="editServiceDate" required>
                </div>
                <div class="form-group">
                    <label for="editServiceTime">時間</label>
                    <input type="time" id="editServiceTime" required>
                </div>
                <div class="form-group">
                    <label for="editServiceNotes">備註 (選填)</label>
                    <input type="text" id="editServiceNotes">
                </div>
                <button type="submit" class="btn btn-primary btn-full">儲存修改</button>
            </form>
        </div>
    </div>

    <!-- Modal: 編輯充電紀錄 -->
    <div id="editChargeModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeChargeModal">&times;</span>
            <h2>編輯充電紀錄</h2>
            <form id="editChargeForm">
                <input type="hidden" id="editChargeId">
                <div class="form-group">
                    <label for="editChargeMileage">里程 (公里)</label>
                    <input type="number" id="editChargeMileage" required>
                </div>
                <div class="form-group">
                    <label for="editChargeKWh">充電度數 (kWh)</label>
                    <input type="number" id="editChargeKWh" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="editChargeCost">花費金額 (元)</label>
                    <input type="number" id="editChargeCost" required>
                </div>
                <div class="form-group">
                    <label for="editChargeStation">充電地點</label>
                    <select id="editChargeStation">
                        <option value="家裡">家裡</option>
                        <option value="公司">公司</option>
                        <option value="充電站">充電站</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editChargeDate">日期</label>
                    <input type="date" id="editChargeDate" required>
                </div>
                <div class="form-group">
                    <label for="editChargeTime">時間</label>
                    <input type="time" id="editChargeTime" required>
                </div>
                <div class="form-group">
                    <label for="editChargeNotes">備註 (選填)</label>
                    <input type="text" id="editChargeNotes">
                </div>
                <button type="submit" class="btn btn-primary btn-full">儲存修改</button>
            </form>
        </div>
    </div>
    
    <!-- Modal: 匯出/匯入資料 -->
    <div id="exportImportModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeExportImportModal">&times;</span>
            <h2>匯出/匯入資料</h2>
            <div class="form-group">
                <label for="exportData">匯出資料 (JSON)</label>
                <textarea id="exportData" rows="10" readonly></textarea>
                <button class="btn btn-secondary btn-full mt-2" onclick="copyExportData()"><i class="icon-copy"></i> 複製資料</button>
            </div>
            <div class="section-title">匯入資料 (覆蓋現有資料)</div>
             <div class="form-group">
                <label for="importData">貼上匯入 JSON 資料</label>
                <textarea id="importData" rows="5"></textarea>
                <button class="btn btn-danger btn-full mt-2" onclick="importData()"><i class="icon-upload"></i> 執行匯入 (覆蓋)</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: 清除資料確認 -->
    <div id="resetModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeResetModal">&times;</span>
            <h2>⚠️ 確認清除所有資料</h2>
            <p>您確定要清除所有充電、保養、花費紀錄和設定嗎？**此操作無法復原！**</p>
            <div class="button-group mt-4">
                <button class="btn btn-secondary" onclick="document.getElementById('closeResetModal').click()">取消</button>
                <button class="btn btn-danger" onclick="resetAllData()">確定清除</button>
            </div>
        </div>
    </div>

    <!-- Modal: GAS 教學 -->
    <div id="tutorialModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeTutorialModal">&times;</span>
            <h2>Google Sheets 雲端同步教學</h2>
            
            <div class="tutorial-body">
                <h4>步驟 1：建立 Google Sheets</h4>
                <p>1. 建立一個新的 Google 試算表 (例如：`電動摩托車紀錄資料`)。</p>
                <p>2. 在試算表中建立三個工作表，名稱必須完全匹配：</p>
                <ul style="margin-left:20px;">
                    <li>`ChargeLog` (充電紀錄)</li>
                    <li>`MaintenanceLog` (保養紀錄)</li>
                    <li>`ExpenseLog` (花費紀錄)</li>
                    <li>`StatusLog` (狀態紀錄 - 可選)</li>
                </ul>
                
                <h4>步驟 2：部署 Google Apps Script</h4>
                <p>1. 在試算表菜單中，點擊「擴充功能」>「Apps Script」。</p>
                <p>2. 將以下程式碼貼入 `程式碼.gs` 檔案中，覆蓋所有內容：</p>
                <pre><code>function doPost(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var params = JSON.parse(e.postData.contents);
  var action = params.action;
  
  if (action === 'sync') {
    // 處理同步上傳
    try {
      if (params.ChargeLog) syncData(ss, 'ChargeLog', params.ChargeLog);
      if (params.MaintenanceLog) syncData(ss, 'MaintenanceLog', params.MaintenanceLog);
      if (params.ExpenseLog) syncData(ss, 'ExpenseLog', params.ExpenseLog);
      if (params.StatusLog) syncData(ss, 'StatusLog', params.StatusLog);
      return ContentService.createTextOutput(JSON.stringify({ status: 'success', message: '資料同步成功' })).setMimeType(ContentService.MimeType.JSON);
    } catch (error) {
       return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: '同步失敗: ' + error.message })).setMimeType(ContentService.MimeType.JSON);
    }
  } else if (action === 'restore') {
    // 處理還原下載
    var data = {};
    try {
      data.ChargeLog = readData(ss, 'ChargeLog');
      data.MaintenanceLog = readData(ss, 'MaintenanceLog');
      data.ExpenseLog = readData(ss, 'ExpenseLog');
      data.StatusLog = readData(ss, 'StatusLog');
      
      // 移除所有為空陣列的屬性
      for (var key in data) {
          if (Array.isArray(data[key]) && data[key].length === 0) {
              delete data[key];
          }
      }
      
      return ContentService.createTextOutput(JSON.stringify({ status: 'success', data: data })).setMimeType(ContentService.MimeType.JSON);
    } catch (error) {
      return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: '還原失敗: ' + error.message })).setMimeType(ContentService.MimeType.JSON);
    }
  }
  
  return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: '無效的動作' })).setMimeType(ContentService.MimeType.JSON);
}

// 輔助函數：將 JSON 陣列寫入工作表
function syncData(ss, sheetName, data) {
  var sheet = ss.getSheetByName(sheetName);
  if (!sheet) throw new Error('找不到工作表: ' + sheetName);
  
  // 1. 取得標頭 (使用陣列的第一個物件的所有 key)
  var headers = data.length > 0 ? Object.keys(data[0]) : [];
  if (headers.length === 0) return; // 沒有資料或沒有標頭，直接返回

  // 2. 清除舊資料 (保留第一行標頭)
  sheet.clearContents();
  
  // 3. 寫入標頭
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  
  // 4. 準備寫入資料
  var values = data.map(function(obj) {
    return headers.map(function(header) {
      var val = obj[header];
      // 檢查是否為物件或陣列，如果是，轉換為 JSON 字串
      if (typeof val === 'object' && val !== null) {
        return JSON.stringify(val);
      }
      return val;
    });
  });
  
  // 5. 寫入所有資料
  if (values.length > 0) {
    sheet.getRange(2, 1, values.length, headers.length).setValues(values);
  }
}

// 輔助函數：從工作表讀取資料並轉換為 JSON 陣列
function readData(ss, sheetName) {
  var sheet = ss.getSheetByName(sheetName);
  if (!sheet) throw new Error('找不到工作表: ' + sheetName);
  
  var range = sheet.getDataRange();
  var values = range.getValues();
  
  if (values.length < 2) return []; // 只有標頭或空白
  
  var headers = values[0]; // 第一行是標頭
  var data = [];
  
  for (var i = 1; i < values.length; i++) {
    var row = values[i];
    var obj = {};
    for (var j = 0; j < headers.length; j++) {
      var val = row[j];
      try {
         // 嘗試解析 JSON 字串 (如備註欄位可能為 JSON)
         if (typeof val === 'string' && (val.startsWith('[') || val.startsWith('{'))) {
             val = JSON.parse(val);
         }
      } catch(e) {}
      obj[headers[j]] = val;
    }
    data.push(obj);
  }
  return data;
}</code></pre>

                <h4>步驟 3：部署</h4>
                <p>1. 點擊右上角「部署」>「新增部署作業」。</p>
                <p>2. 類型選擇「網頁應用程式」。</p>
                <p>3. 設定：</p>
                <ul style="margin-left:20px;">
                    <li>執行身分：<b>我 (您的信箱)</b></li>
                    <li>誰可以存取：<b>所有人 (這很重要！)</b></li>
                </ul>
                <p>4. 點擊部署，授權時選擇「進階」>「前往... (不安全)」>「允許」。</p>
                <p>5. 複製產生的網址 (以 <code>/exec</code> 結尾)。</p>
                
                <h4>步驟 4：完成設定</h4>
                <p>回到本系統，將網址貼入「API 欄位」並儲存，即可開始同步！</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-full btn-lg" onclick="document.getElementById('closeTutorialModal').click()">我瞭解了</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    <script src="motolog.js"></script>
    <script>
        // 註冊 Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js').then(function(registration) {
                    console.log('Service Worker 註冊成功: ', registration.scope);
                }, function(err) {
                    console.log('Service Worker 註冊失敗: ', err);
                });
            });
        }
    </script>
</body>
</html>

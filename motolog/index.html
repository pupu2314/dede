<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>電動摩托車紀錄系統</title>
    
    <!-- PWA 設定 -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <link rel="stylesheet" href="motolog.css">
</head>
<body>
    <!-- 置頂懸浮備份提示容器 -->
    <div id="topAlert" class="top-alert"></div>

    <div class="container">
        <div class="header">
            <h1>🏍️ 電動摩托車紀錄</h1>
        </div>
        
        <div class="dashboard">
            <div class="stat-card">
                <h3>總里程</h3>
                <div class="value" id="totalMileage">0</div>
                <div class="subtitle">公里</div>
            </div>
            <div class="stat-card">
                <h3>上次充電</h3>
                <div class="value" id="lastChargeDays">-</div>
                <div class="subtitle" id="lastChargeDate">無記錄</div>
            </div>
            <div class="stat-card">
                <h3>下次保養</h3>
                <div class="value" id="nextServiceStatus">正常</div>
                <div class="subtitle" id="nextServiceDate">待記錄</div>
            </div>
            <div class="stat-card">
                <h3>總花費</h3>
                <div class="value" id="totalExpense">0</div>
                <div class="subtitle">NT$</div>
            </div>
        </div>
        
        <div class="content">
            <div class="tabs-wrapper">
                <div class="tabs">
                    <button class="tab-button active" data-tab="status">快速更新</button>
                    <button class="tab-button" data-tab="charge">充電</button>
                    <button class="tab-button" data-tab="maintenance">保養</button>
                    <button class="tab-button" data-tab="expense">其他</button>
                    <button class="tab-button" data-tab="statistics">統計</button>
                    <button class="tab-button" data-tab="settings">設定</button>
                </div>
            </div>
            
            <!-- 快速更新頁面 -->
            <div id="statusTab" class="tab-content active">
                <div class="form-card">
                    <h3 id="statusTitle">📝 快速更新狀態</h3>
                    <!-- 顯示最後更新時間 -->
                    <div id="lastUpdateInfo" class="last-update-info"></div>
                    
                    <form id="statusForm">
                        <div class="form-group">
                            <label>目前里程 (ODO)</label>
                            <input type="number" inputmode="decimal" step="0.1" id="sOdo" placeholder="自動帶入最新紀錄..." required style="font-size: 1.2rem;">
                        </div>
                        <div class="form-group">
                            <label>目前電量</label>
                            <div class="battery-selector">
                                <div class="battery-option"><input type="radio" id="sb0" name="sBattery" value="0"><label for="sb0">0</label></div>
                                <div class="battery-option"><input type="radio" id="sb1" name="sBattery" value="1" checked><label for="sb1">1</label></div>
                                <div class="battery-option"><input type="radio" id="sb2" name="sBattery" value="2"><label for="sb2">2</label></div>
                                <div class="battery-option"><input type="radio" id="sb3" name="sBattery" value="3"><label for="sb3">3</label></div>
                                <div class="battery-option"><input type="radio" id="sb4" name="sBattery" value="4"><label for="sb4">4</label></div>
                                <div class="battery-option"><input type="radio" id="sb5" name="sBattery" value="5"><label for="sb5">5</label></div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full btn-lg" style="margin-top: 20px;">💾 更新狀態</button>
                    </form>
                </div>
            </div>

            <!-- 充電頁面 -->
            <div id="chargeTab" class="tab-content">
                <div id="startChargeSection">
                    <div class="form-card">
                        <h3>⚡ 開始充電</h3>
                        <form id="startChargeForm">
                            <div class="form-group">
                                <label>快速地點</label>
                                <div class="quick-stations">
                                    <button type="button" class="station-btn" data-station="公司">🏢 公司</button>
                                    <button type="button" class="station-btn" data-station="充電站">⚡ 充電站</button>
                                    <button type="button" class="station-btn" data-station="家裡">🏠 家裡</button>
                                    <button type="button" class="station-btn" data-station="其他">📍 其他</button>
                                </div>
                                <input type="text" id="cStation" placeholder="輸入自訂地點" style="display:none; margin-top:10px;">
                            </div>
                            
                            <div class="form-group">
                                <label>目前里程 (ODO)</label>
                                <input type="number" inputmode="decimal" step="0.1" id="cOdo" placeholder="例如: 1234.5" required>
                            </div>
                            
                            <div class="form-group">
                                <label>充電前電量</label>
                                <div class="battery-selector">
                                    <div class="battery-option"><input type="radio" id="bs0" name="cBatteryStart" value="0"><label for="bs0">0</label></div>
                                    <div class="battery-option"><input type="radio" id="bs1" name="cBatteryStart" value="1" checked><label for="bs1">1</label></div>
                                    <div class="battery-option"><input type="radio" id="bs2" name="cBatteryStart" value="2"><label for="bs2">2</label></div>
                                    <div class="battery-option"><input type="radio" id="bs3" name="cBatteryStart" value="3"><label for="bs3">3</label></div>
                                    <div class="battery-option"><input type="radio" id="bs4" name="cBatteryStart" value="4"><label for="bs4">4</label></div>
                                    <div class="battery-option"><input type="radio" id="bs5" name="cBatteryStart" value="5"><label for="bs5">5</label></div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>備註</label>
                                <textarea id="cNotes" rows="2" placeholder="選填..."></textarea>
                            </div>
                             
                            <button type="submit" class="btn btn-success btn-full btn-lg">⚡ 開始充電</button>
                        </form>
                    </div>
                </div>
                
                <div id="endChargeSection" style="display:none;">
                    <div class="charging-status">
                        <h3>⚡ 充電進行中</h3>
                        <div id="currentChargeInfo"></div>
                        <div class="charging-timer" id="chargingTimer">00:00:00</div>
                    </div>
                    
                    <div class="form-card">
                        <h3>結束充電</h3>
                        <form id="endChargeForm">
                            <div class="form-group">
                                <label>充電後電量</label>
                                <div class="battery-selector">
                                    <div class="battery-option"><input type="radio" id="be0" name="cBatteryEnd" value="0"><label for="be0">0</label></div>
                                    <div class="battery-option"><input type="radio" id="be1" name="cBatteryEnd" value="1"><label for="be1">1</label></div>
                                    <div class="battery-option"><input type="radio" id="be2" name="cBatteryEnd" value="2"><label for="be2">2</label></div>
                                    <div class="battery-option"><input type="radio" id="be3" name="cBatteryEnd" value="3"><label for="be3">3</label></div>
                                    <div class="battery-option"><input type="radio" id="be4" name="cBatteryEnd" value="4"><label for="be4">4</label></div>
                                    <div class="battery-option"><input type="radio" id="be5" name="cBatteryEnd" value="5" checked><label for="be5">5</label></div>
                                </div>
                            </div>
                            
                            <div class="form-group" id="kwhGroup">
                                <label>充電度數 (kWh)</label>
                                <input type="number" inputmode="decimal" step="0.01" id="cKwh" placeholder="例如: 1.5">
                            </div>
                            
                            <div class="form-group" id="costGroup">
                                <label>充電費用 (NT$)</label>
                                <input type="number" inputmode="numeric" id="cCost" placeholder="例如: 30">
                            </div>
                            
                            <div class="form-group">
                                <label>預估里程 (Range)</label>
                                <input type="number" inputmode="decimal" step="0.1" id="cRange" placeholder="儀表顯示值">
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-full btn-lg">✅ 完成並儲存</button>
                        </form>
                    </div>
                </div>
                
                <div class="analytics-grid">
                    <div class="analytics-card"><h4>平均效率</h4><p id="avgEfficiency">-</p></div>
                    <div class="analytics-card"><h4>最佳效率</h4><p id="bestEfficiency">-</p></div>
                    <div class="analytics-card"><h4>總次數</h4><p id="totalCharges">0</p></div>
                </div>
                
                <div class="filter-bar">
                    <input type="text" id="chargeSearch" placeholder="🔍 搜尋地點...">
                    <select id="chargeMonthFilter"><option value="">所有月份</option></select>
                    <button type="button" id="recalcCostBtn" class="btn btn-secondary btn-sm">🔄 重新計算電費</button>
                </div>
                
                <div id="chargeList" class="history-list"></div>
            </div>
            
            <!-- 保養頁面 -->
            <div id="maintenanceTab" class="tab-content">
                <div class="form-card">
                    <h3 id="maintTitle">🛠️ 記錄保養</h3>
                    <form id="maintenanceForm">
                        <input type="hidden" id="editingMaintId">
                        <div class="row-group">
                            <div class="form-group half"><label>日期</label><input type="date" id="mDate" required></div>
                            <div class="form-group half"><label>時間</label><input type="time" id="mTime" required></div>
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm" id="maintNowBtn">🕒 填入現在時間</button>
                        
                        <div class="form-group" style="margin-top:15px;">
                            <label>里程 (ODO)</label>
                            <input type="number" inputmode="decimal" step="0.1" id="mOdo" placeholder="公里" required>
                        </div>
                        
                        <div class="form-group">
                            <label>地點</label>
                            <div style="display:flex; gap:8px;">
                                <select id="mLocationSelect" style="flex:1;">
                                    <option value="基隆成功專賣店">基隆成功專賣店</option>
                                    <option value="其他">其他...</option>
                                </select>
                            </div>
                            <input type="text" id="mLocationInput" placeholder="輸入地點名稱" style="display:none; margin-top:10px;">
                        </div>
                        
                        <div class="form-group">
                            <label>類型</label>
                            <select id="mType">
                                <option value="定期保養">定期保養</option>
                                <option value="大保養">大保養</option>
                                <option value="小保養">小保養</option>
                                <option value="維修">維修</option>
                                <option value="檢查">檢查</option>
                            </select>
                        </div>
                        
                        <div class="form-group"><label>備註</label><textarea id="mNotes" rows="2"></textarea></div>
                        
                        <h3>項目清單</h3>
                        <div id="partsList"></div>
                        
                        <div class="form-group">
                            <label>快速加入</label>
                            <div id="maintTemplates" class="scroll-chips">
                                <!-- Templates via JS -->
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-success" id="addPartBtn" style="margin-bottom: 15px;">➕ 自訂項目</button>
                        
                        <div class="total-cost-bar">
                            <span>總費用</span>
                            <span class="cost">NT$ <span id="totalCost">0</span></span>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-full btn-lg">💾 儲存記錄</button>
                        <button type="button" class="btn btn-secondary btn-full btn-lg" id="cancelMaintEdit" style="display:none; margin-top:10px;">取消編輯</button>
                    </form>
                </div>
                
                <div class="filter-bar">
                    <select id="maintMonthFilter"><option value="">所有月份</option></select>
                    <select id="maintTypeFilter">
                        <option value="">所有類型</option>
                        <option value="定期保養">定期保養</option>
                        <option value="大保養">大保養</option>
                        <option value="維修">維修</option>
                    </select>
                </div>
                
                <div id="maintList" class="history-list"></div>
            </div>
            
            <!-- 其他頁面 -->
            <div id="expenseTab" class="tab-content">
                <div class="form-card">
                    <h3 id="expenseTitle">💰 記錄花費</h3>
                    <form id="expenseForm">
                        <input type="hidden" id="editingExpenseId">
                        <div class="row-group">
                            <div class="form-group half"><label>日期</label><input type="date" id="eDate" required></div>
                            <div class="form-group half"><label>時間</label><input type="time" id="eTime" required></div>
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm" id="expenseNowBtn">🕒 填入現在時間</button>
                        
                        <div class="form-group" style="margin-top:15px;">
                            <label>類別</label>
                            <select id="eCategory">
                                <option value="保險">保險</option>
                                <option value="牌照稅">牌照稅</option>
                                <option value="停車費">停車費</option>
                                <option value="配件">配件</option>
                                <option value="清潔">清潔</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>金額 (NT$)</label>
                            <input type="number" inputmode="numeric" id="eAmount" placeholder="0" required style="font-size: 1.2rem;">
                        </div>
                        <div class="form-group"><label>里程 (選填)</label><input type="number" inputmode="decimal" step="0.1" id="eOdo" placeholder="公里"></div>
                        <div class="form-group"><label>說明</label><textarea id="eDescription" rows="2"></textarea></div>
                        
                        <button type="submit" class="btn btn-primary btn-full btn-lg">💾 儲存記錄</button>
                        <button type="button" class="btn btn-secondary btn-full btn-lg" id="cancelExpenseEdit" style="display:none; margin-top:10px;">取消編輯</button>
                    </form>
                </div>
                
                <div class="filter-bar">
                    <select id="expenseCategoryFilter"><option value="">所有類別</option></select>
                    <select id="expenseMonthFilter"><option value="">所有月份</option></select>
                </div>
                
                <div id="expenseList" class="history-list"></div>
            </div>
            
            <div id="statisticsTab" class="tab-content">
                <div class="analytics-grid">
                    <div class="analytics-card"><h4>總里程</h4><p id="statTotalMileage">0 公里</p></div>
                    <div class="analytics-card"><h4>平均日里程</h4><p id="statAvgDaily">0 公里</p></div>
                    <div class="analytics-card"><h4>每公里成本</h4><p id="statCostPerKm">0 NT$</p></div>
                    <div class="analytics-card"><h4>總花費</h4><p id="statTotalCost">0 NT$</p></div>
                </div>
            </div>
            
            <div id="settingsTab" class="tab-content">
                <div class="form-card">
                    <h3>⚙️ 設定</h3>
                    <div id="settingsForm">
                        <div class="form-group">
                            <label>電費單價 (NT$/度)</label>
                            <input type="number" inputmode="decimal" step="0.1" id="electricRate" placeholder="例如: 3.5">
                            <small>用於自動計算公司或家裡的充電費用</small>
                        </div>
                        
                        <div class="form-group">
                            <label>外觀主題</label>
                            <select id="themeSelect">
                                <option value="light">🌞 亮色模式</option>
                                <option value="dark">🌙 深色模式</option>
                            </select>
                        </div>

                        <!-- API 欄位 -->
                        <div class="form-group">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                <label style="margin-bottom:0;">Google Sheets API</label>
                                <button type="button" id="showTutorialBtn" class="btn btn-text btn-sm" style="padding:4px 8px; font-size:0.9rem; color:var(--primary);">📖 設定教學</button>
                            </div>
                            <input type="text" id="gasUrl" placeholder="https://script.google.com/macros/s/..." style="font-size:0.8rem;">
                            <small>請輸入 GAS 發布後的 Web App URL 以啟用雲端同步</small>
                        </div>

                        <button type="button" class="btn btn-primary btn-block-setting btn-full" id="saveSettingsBtn">儲存設定</button>
                    </div>
                </div>
                
                <div class="data-management">
                    <h3>📦 資料備份與還原</h3>
                    
                    <div class="data-btns-stack" style="margin-bottom: 20px;">
                        <button class="btn btn-warning btn-block-setting" id="syncToCloudBtn">☁️ 同步到 Google Sheets</button>
                        <button class="btn btn-secondary btn-block-setting" id="restoreFromCloudBtn">📥 從雲端還原</button>
                    </div>

                    <input type="file" id="jsonImport" accept=".json" style="display:none;">
                    <div class="data-btns-stack">
                        <button class="btn btn-success btn-block-setting" id="exportAllBtn">📤 匯出備份檔 (JSON)</button>
                        <button class="btn btn-primary btn-block-setting" id="importBtn">📥 匯入備份檔</button>
                        <button class="btn btn-danger btn-block-setting" id="clearAllBtn">🗑️ 清除所有資料</button>
                    </div>
                </div>
                <!-- 版本顯示區塊 -->
                <div style="text-align: center; margin-top: 20px; color: var(--secondary);">
                   <small id="appVersion"></small>
                </div>
            </div>
        </div>
    </div>

    <!-- 編輯充電視窗 -->
    <div id="editChargeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>編輯充電</h3>
                <button class="btn btn-text" id="closeEditModal">關閉</button>
            </div>
            <form id="editChargeForm">
                <input type="hidden" id="editingChargeId">
                <div class="form-scroll-area">
                    <div class="form-group"><label>開始時間</label><input type="datetime-local" id="edit_cStartTime" required></div>
                    <div class="form-group"><label>結束時間</label><input type="datetime-local" id="edit_cEndTime" required></div>
                    <div class="form-group"><label>里程 (ODO)</label><input type="number" inputmode="decimal" step="0.1" id="edit_cOdo" required></div>
                    <div class="form-group"><label>充電站</label><input type="text" id="edit_cStation"></div>
                    <div class="row-group">
                        <div class="form-group half">
                            <label>開始電量</label>
                            <select id="edit_cBatteryStart">
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                        <div class="form-group half">
                            <label>結束電量</label>
                            <select id="edit_cBatteryEnd">
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    </div>
                    <div class="row-group">
                        <div class="form-group half"><label>度數 (kWh)</label><input type="number" inputmode="decimal" step="0.01" id="edit_cKwh"></div>
                        <div class="form-group half"><label>費用 (NT$)</label><input type="number" inputmode="numeric" id="edit_cCost"></div>
                    </div>
                    <div class="form-group"><label>備註</label><textarea id="edit_cNotes" rows="2"></textarea></div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary btn-full btn-lg">儲存變更</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 教學視窗 (Tutorial Modal) -->
    <div id="tutorialModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>☁️ 雲端同步教學</h3>
                <button class="btn btn-text" id="closeTutorialModal">關閉</button>
            </div>
            <div class="form-scroll-area tutorial-content">
                <h4>步驟 1：建立 Google 試算表</h4>
                <p>1. 建立一個空白的 Google 試算表。</p>
                <p>2. 在下方分頁籤，建立 4 個分頁，名稱請<b>完全一致</b>：</p>
                <ul style="margin-left:20px; margin-bottom:10px;">
                    <li><code>ChargeLog</code></li>
                    <li><code>MaintenanceLog</code></li>
                    <li><code>ExpenseLog</code></li>
                    <li><code>StatusLog</code></li>
                </ul>

                <h4>步驟 2：Apps Script</h4>
                <p>1. 點擊上方選單「擴充功能」>「Apps Script」。</p>
                <p>2. 刪除原有內容，貼上以下程式碼：</p>
                <pre><code>function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    
    if (data.action === 'sync') {
      saveToSheet(ss, 'ChargeLog', data.chargeLog);
      saveToSheet(ss, 'MaintenanceLog', data.maintenanceLog);
      saveToSheet(ss, 'ExpenseLog', data.expenseLog);
      saveToSheet(ss, 'StatusLog', data.statusLog);
      return ContentService.createTextOutput(JSON.stringify({status: 'success'}))
        .setMimeType(ContentService.MimeType.JSON);
    } else if (data.action === 'restore') {
      var result = {
        ChargeLog: readSheet(ss, 'ChargeLog'),
        MaintenanceLog: readSheet(ss, 'MaintenanceLog'),
        ExpenseLog: readSheet(ss, 'ExpenseLog'),
        StatusLog: readSheet(ss, 'StatusLog')
      };
      return ContentService.createTextOutput(JSON.stringify({status: 'success', data: result}))
        .setMimeType(ContentService.MimeType.JSON);
    }
  } catch (f) {
    return ContentService.createTextOutput(JSON.stringify({status: 'error', message: f.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}

function saveToSheet(ss, sheetName, dataArray) {
  var sheet = ss.getSheetByName(sheetName);
  if (!sheet || !dataArray || dataArray.length === 0) return;
  sheet.clear();
  var headers = Object.keys(dataArray[0]);
  sheet.appendRow(headers);
  var rows = dataArray.map(obj => headers.map(key => {
    var val = obj[key];
    if (typeof val === 'object') return JSON.stringify(val);
    return val;
  }));
  sheet.getRange(2, 1, rows.length, headers.length).setValues(rows);
}

function readSheet(ss, sheetName) {
  var sheet = ss.getSheetByName(sheetName);
  if (!sheet) return [];
  var rows = sheet.getDataRange().getValues();
  if (rows.length < 2) return [];
  var headers = rows[0];
  var data = [];
  for (var i = 1; i < rows.length; i++) {
    var obj = {};
    for (var j = 0; j < headers.length; j++) {
      var val = rows[i][j];
      try {
         if (typeof val === 'string' && (val.startsWith('[') || val.startsWith('{'))) {
             val = JSON.parse(val);
         }
      } catch(e) {}
      obj[headers[j]] = val;
    }
    data.push(obj);
  }
  return data;
}</code></pre>

                <h4>步驟 3：部署</h4>
                <p>1. 點擊右上角「部署」>「新增部署作業」。</p>
                <p>2. 類型選擇「網頁應用程式」。</p>
                <p>3. 設定：</p>
                <ul style="margin-left:20px;">
                    <li>執行身分：<b>我 (您的信箱)</b></li>
                    <li>誰可以存取：<b>所有人 (這很重要！)</b></li>
                </ul>
                <p>4. 點擊部署，授權時選擇「進階」>「前往... (不安全)」>「允許」。</p>
                <p>5. 複製產生的網址 (以 <code>/exec</code> 結尾)。</p>
                
                <h4>步驟 4：完成設定</h4>
                <p>回到本系統，將網址貼入「API 欄位」並儲存，即可開始同步！</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-full btn-lg" onclick="document.getElementById('closeTutorialModal').click()">我瞭解了</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    <script src="motolog.js" defer></script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then((reg) => console.log('Service Worker registered.', reg))
            .catch((err) => console.log('Service Worker registration failed.', err));
        });
      }
    </script>
</body>
</html>

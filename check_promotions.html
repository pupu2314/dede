<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>德德美體美容中心 - 促銷設定檢查頁面</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 20px; 
            line-height: 1.6;
            background-color: #f8f9fa;
            color: #212529;
        }
        .container {
            max-width: 960px;
            margin: auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        h1, h2 { 
            color: #0056b3;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        h1 { font-size: 1.8em; }
        h2 { font-size: 1.4em; }
        table { 
            border-collapse: collapse; 
            width: 100%; 
            margin-bottom: 25px; 
            font-size: 0.95em;
        }
        th, td { 
            border: 1px solid #dee2e6; 
            padding: 10px; 
            text-align: left; 
            vertical-align: middle;
        }
        th { 
            background-color: #e9ecef; 
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .status { 
            font-weight: bold; 
            padding: 3px 8px; 
            border-radius: 4px; 
            color: white;
            white-space: nowrap;
        }
        .status.active { background-color: #28a745; } /* 生效中 - 綠色 */
        .status.expired { background-color: #6c757d; } /* 已過期 - 灰色 */
        .status.upcoming { background-color: #fd7e14; } /* 尚未開始 - 橘色 */
        .no-promo {
            color: #6c757d;
            font-style: italic;
        }
        .note {
            background-color: #fff3cd;
            border-left: 5px solid #ffeeba;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="promo-container">
            </div>
    </div>

    <script src="dede.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('promo-container');
            
            // 檢查 serviceData 是否成功載入
            if (typeof serviceData === 'undefined' || typeof allServices === 'undefined') {
                container.innerHTML = '<h1>錯誤</h1><p class="note">找不到 serviceData 或 allServices 物件。<br>請確認此檔案 (check_promotions.html) 與 <strong>dede.js</strong> 放在同一個資料夾中。</p>';
                return;
            }

            // 再次宣告日期函式，以確保此頁面獨立運作的正確性
            function getTaipeiDateString() {
                const now = new Date();
                return new Intl.DateTimeFormat('en-CA', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    timeZone: 'Asia/Taipei'
                }).format(now);
            }

            function getPromoStatus(promo, todayString) {
                if (todayString < promo.start) return { text: '尚未開始', class: 'upcoming' };
                if (todayString > promo.end) return { text: '已過期', class: 'expired' };
                return { text: '生效中', class: 'active' };
            }

            const today = getTaipeiDateString();
            container.innerHTML += `<h1>促銷設定總覽</h1><p class="note">此報告僅供內部檢查設定使用。所有日期的判斷基準日 (台北時間): <strong>${today}</strong></p>`;

            // 處理一般服務項目
            serviceData.categories.forEach(category => {
                let tableHtml = `<h2>${category.name}</h2><table>
                                    <thead>
                                        <tr>
                                            <th style="width: 30%;">服務項目</th>
                                            <th style="width: 10%;">原價</th>
                                            <th>促銷活動</th>
                                            <th>促銷價</th>
                                            <th>開始日期</th>
                                            <th>結束日期</th>
                                            <th style="width: 10%;">狀態</th>
                                        </tr>
                                    </thead><tbody>`;
                category.items.forEach(item => {
                    if (!item.promotions || item.promotions.length === 0) {
                        tableHtml += `<tr>
                                        <td>${item.name}</td>
                                        <td>${item.price.toLocaleString()}</td>
                                        <td colspan="5" class="no-promo">無</td>
                                      </tr>`;
                    } else {
                        item.promotions.forEach((promo, index) => {
                            const status = getPromoStatus(promo, today);
                            tableHtml += `<tr>
                                            ${index === 0 ? `<td rowspan="${item.promotions.length}">${item.name}</td>` : ''}
                                            ${index === 0 ? `<td rowspan="${item.promotions.length}" style="text-align: right;">${item.price.toLocaleString()}</td>` : ''}
                                            <td>${promo.label}</td>
                                            <td style="text-align: right;">${promo.price.toLocaleString()}</td>
                                            <td>${promo.start}</td>
                                            <td>${promo.end}</td>
                                            <td><span class="status ${status.class}">${status.text}</span></td>
                                          </tr>`;
                        });
                    }
                });
                tableHtml += '</tbody></table>';
                container.innerHTML += tableHtml;
            });

            // 處理組合優惠
            let comboTableHtml = `<h2>組合優惠</h2><table>
                                    <thead>
                                        <tr>
                                            <th style="width: 25%;">組合名稱</th>
                                            <th>包含項目</th>
                                            <th>促銷活動</th>
                                            <th>促銷價</th>
                                            <th>開始日期</th>
                                            <th>結束日期</th>
                                            <th style="width: 10%;">狀態</th>
                                        </tr>
                                    </thead><tbody>`;
            serviceData.combos.forEach(combo => {
                 if (combo.promotions && combo.promotions.length > 0) {
                    const itemNames = combo.itemIds.map(id => allServices.get(id)?.name || '<span style="color:red;">錯誤ID</span>').join('<br>');
                    combo.promotions.forEach((promo, index) => {
                        const status = getPromoStatus(promo, today);
                        comboTableHtml += `<tr>
                                        ${index === 0 ? `<td rowspan="${combo.promotions.length}">${combo.name}</td>` : ''}
                                        ${index === 0 ? `<td rowspan="${combo.promotions.length}">${itemNames}</td>` : ''}
                                        <td>${promo.label}</td>
                                        <td style="text-align: right;">${promo.price.toLocaleString()}</td>
                                        <td>${promo.start}</td>
                                        <td>${promo.end}</td>
                                        <td><span class="status ${status.class}">${status.text}</span></td>
                                      </tr>`;
                    });
                 }
            });
            comboTableHtml += '</tbody></table>';
            container.innerHTML += comboTableHtml;
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‘©æ‰˜è»Šè¼›è³‡è¨Šè¨˜éŒ„</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d; --light-bg: #f8f9fa;
            --border-color: #dee2e6; --text-color: #343a40; --white: #fff;
            --danger-color: #dc3545; --success-color: #28a745; --warning-color: #ffc107;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 15px; background-color: var(--light-bg); color: var(--text-color);
        }
        .container {
            max-width: 800px; margin: 0 auto; background-color: var(--white);
            padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1, h2, h3 { color: var(--primary-color); text-align: center; }
        .summary {
            background-color: #e7f3ff; padding: 15px; border-radius: 8px;
            margin-bottom: 25px; border-left: 5px solid var(--primary-color);
        }
        .summary p { margin: 8px 0; font-size: 1em; }
        .summary span { font-weight: bold; color: #004085; }
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; flex-wrap: wrap; }
        .tab-button {
            padding: 10px 15px; cursor: pointer; border: none; background-color: transparent;
            font-size: 1.1em; margin-bottom: -2px; border-bottom: 3px solid transparent;
        }
        .tab-button.active { font-weight: bold; color: var(--primary-color); border-bottom: 3px solid var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-section { padding: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group small { color: var(--secondary-color); font-size: 0.8em; }
        input, textarea, select {
            width: 100%; padding: 10px; border: 1px solid var(--border-color);
            border-radius: 4px; box-sizing: border-box;
        }
        .now-btn {
            position: absolute; right: 5px; top: 28px; padding: 5px 8px;
            background-color: var(--secondary-color); color: var(--white); border: none;
            border-radius: 4px; cursor: pointer; font-size: 0.8em;
        }
        .main-btn {
            width: 100%; padding: 12px; background-color: var(--primary-color); color: var(--white);
            border: none; border-radius: 4px; cursor: pointer; font-size: 1.1em; margin-top: 10px;
        }
        .main-btn:hover { background-color: #0056b3; }
        #partsList .part-item { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; }
        #partsList .part-item input { margin-bottom: 0; }
        .remove-part-btn { padding: 8px 12px; background-color: var(--danger-color); color: var(--white); border: none; border-radius: 4px; cursor: pointer; }
        .add-part-btn { margin-top: 10px; background-color: var(--success-color); }
        .analytics-section {
            display: flex; flex-wrap: wrap; justify-content: space-around; background-color: var(--light-bg);
            padding: 15px; border-radius: 5px; margin: 20px 0; text-align: center; gap: 10px;
        }
        .analytics-item h4 { margin: 0 0 5px 0; color: var(--secondary-color); font-size: 0.9em; }
        .analytics-item p { margin: 0; font-size: 1.2em; font-weight: bold; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .history-table th, .history-table td { border: 1px solid var(--border-color); padding: 8px; text-align: left; vertical-align: middle;}
        .history-table th { background-color: var(--light-bg); }
        .table-container { overflow-x: auto; }
        .action-buttons button { font-size: 0.8em; padding: 4px 8px; margin-right: 5px; border-radius: 4px; cursor: pointer; border: none; color: white;}
        .edit-btn { background-color: var(--warning-color); }
        .delete-btn { background-color: var(--danger-color); }
        .data-management-section { margin-top: 30px; padding: 15px; border: 1px dashed var(--secondary-color); border-radius: 5px; }
        .data-management-section button {
            padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-right: 10px; margin-bottom: 10px;
            border: 1px solid var(--primary-color); background-color: var(--white); color: var(--primary-color);
        }
        .data-management-section button:hover { background-color: #e7f3ff; }
        #jsonImportInput { display: none; }
        .cancel-edit-btn { background-color: var(--secondary-color); display: none; }
        .filter-section { background-color: var(--light-bg); padding: 15px; border-radius: 5px; margin-bottom: 15px; }
        .filter-section input, .filter-section select { width: auto; display: inline-block; margin-right: 10px; }
        .search-box { width: 200px !important; }
        .statistics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h4 { margin: 0 0 10px 0; color: var(--secondary-color); font-size: 0.9em; }
        .stat-card p { margin: 0; font-size: 1.5em; font-weight: bold; color: var(--primary-color); }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸï¸ æ‘©æ‰˜è»Šè¼›è³‡è¨Šè¨˜éŒ„</h1>

    <div class="summary">
        <p>ä¸Šæ¬¡ä¿é¤Š: <span id="lastMaintenance">å°šæœªè¨˜éŒ„</span> | é‡Œç¨‹: <span id="lastMaintOdo">N/A</span></p>
        <p>ä¸Šæ¬¡å……é›»: <span id="lastCharge">å°šæœªè¨˜éŒ„</span> | é‡Œç¨‹: <span id="lastChargeOdo">N/A</span></p>
        <p>ä¸‹æ¬¡ä¿é¤Šé ä¼°: <span id="nextService">è«‹å…ˆè¨˜éŒ„ä¿é¤Š</span></p>
        <p>ç¸½é‡Œç¨‹: <span id="totalMileage">0</span> km | ç¸½èŠ±è²»: <span id="totalExpense">0</span> NT$</p>
    </div>

    <div class="tabs" id="formTabs">
        <button class="tab-button" onclick="openTab(event, 'chargeFormTab')">è¨˜éŒ„å……é›»</button>
        <button class="tab-button" onclick="openTab(event, 'maintenanceFormTab')">è¨˜éŒ„ä¿é¤Š</button>
        <button class="tab-button" onclick="openTab(event, 'expenseFormTab')">å…¶ä»–èŠ±è²»</button>
    </div>

    <div id="chargeFormTab" class="tab-content">
        <h3 id="chargeFormTitle">è¨˜éŒ„å……é›»</h3>
        <form id="chargeForm" class="form-section">
            <input type="hidden" id="editingChargeId">
            <div class="input-group"><label for="cDate">æ—¥æœŸ:</label><input type="date" id="cDate" required><button type="button" class="now-btn" onclick="fillNow('cDate', 'cTime')">ç¾åœ¨</button></div>
            <div class="input-group"><label for="cTime">æ™‚é–“:</label><input type="time" id="cTime" required></div>
            <div class="input-group"><label for="cOdo">ç¸½é‡Œç¨‹ (ODO):</label><input type="number" id="cOdo" placeholder="å…¬é‡Œ" required><small>è¨˜éŒ„ç•¶ä¸‹å„€è¡¨æ¿çš„ç¸½é‡Œç¨‹æ•¸</small></div>
            <div class="input-group"><label for="cKwh">å……é›»åº¦æ•¸ (kWh):</label><input type="number" step="0.01" id="cKwh" placeholder="ä¾‹å¦‚:1.5" required></div>
            <div class="input-group"><label for="cCost">å……é›»è²»ç”¨ (NT$):</label><input type="number" id="cCost" placeholder="ä¾‹å¦‚:30"></div>
            <div class="input-group"><label for="cStation">å……é›»ç«™/æ¨™è¨˜:</label><input type="text" id="cStation" placeholder="ä¾‹å¦‚:å®¶è£¡ã€å…¬å¸ã€Gogoroæ›é›»ç«™"></div>
            <div class="input-group"><label for="cBatteryStart">å……é›»å‰é›»é‡ (%):</label><input type="number" id="cBatteryStart" placeholder="ä¾‹å¦‚:20"></div>
            <div class="input-group"><label for="cBatteryEnd">å……é›»å¾Œé›»é‡ (%):</label><input type="number" id="cBatteryEnd" placeholder="ä¾‹å¦‚:100"></div>
            <div class="input-group"><label for="cTrip">æœ¬æ¬¡é‡Œç¨‹ (TRIP):</label><input type="number" id="cTrip" placeholder="å…¬é‡Œ"><small>éå¿…å¡«</small></div>
            <div class="input-group"><label for="cRange">é ä¼°é‡Œç¨‹ (RANGE):</label><input type="number" id="cRange" placeholder="å…¬é‡Œ"><small>éå¿…å¡«</small></div>
            <div class="input-group"><label for="cNotes">å‚™è¨»:</label><textarea id="cNotes" rows="2" placeholder="å…¶ä»–è¨˜éŒ„äº‹é …"></textarea></div>
            <button type="submit" class="main-btn">å„²å­˜è¨˜éŒ„</button>
            <button type="button" class="main-btn cancel-edit-btn" id="cancelChargeEdit" onclick="cancelEdit('charge')">å–æ¶ˆç·¨è¼¯</button>
        </form>
    </div>

    <div id="maintenanceFormTab" class="tab-content">
        <h3 id="maintFormTitle">è¨˜éŒ„ä¿é¤Š</h3>
        <form id="maintenanceForm" class="form-section">
            <input type="hidden" id="editingMaintId">
            <div class="input-group"><label for="mDate">æ—¥æœŸ:</label><input type="date" id="mDate" required><button type="button" class="now-btn" onclick="fillNow('mDate', 'mTime')">ç¾åœ¨</button></div>
            <div class="input-group"><label for="mTime">æ™‚é–“:</label><input type="time" id="mTime" required></div>
            <div class="input-group"><label for="mOdo">ç¸½é‡Œç¨‹ (ODO):</label><input type="number" id="mOdo" placeholder="å…¬é‡Œ" required></div>
            <div class="input-group"><label for="mLocation">åœ°é»:</label><input type="text" id="mLocation" placeholder="ä¿é¤Šåœ°é»"></div>
            <div class="input-group"><label for="mType">ä¿é¤Šé¡å‹:</label>
                <select id="mType">
                    <option value="å®šæœŸä¿é¤Š">å®šæœŸä¿é¤Š</option>
                    <option value="å¤§ä¿é¤Š">å¤§ä¿é¤Š</option>
                    <option value="å°ä¿é¤Š">å°ä¿é¤Š</option>
                    <option value="ç¶­ä¿®">ç¶­ä¿®</option>
                    <option value="æª¢æŸ¥">æª¢æŸ¥</option>
                </select>
            </div>
            <div class="input-group"><label for="mNotes">æœå‹™/å‚™è¨»:</label><textarea id="mNotes" rows="3" placeholder="ä¾‹å¦‚:å¤§ä¿é¤Šã€æª¢æŸ¥é›»è·¯"></textarea></div>
            <h3>ä¿é¤Šé …ç›®/é›¶ä»¶</h3>
            <div id="partsList"></div>
            <button type="button" class="main-btn add-part-btn" onclick="addPartItem()">æ–°å¢é …ç›®</button>
            <hr>
            <p style="text-align: right; font-size: 1.2em; font-weight: bold;">ç¸½è²»ç”¨: NT$ <span id="totalCost">0</span></p>
            <button type="submit" class="main-btn">å„²å­˜è¨˜éŒ„</button>
            <button type="button" class="main-btn cancel-edit-btn" id="cancelMaintEdit" onclick="cancelEdit('maint')">å–æ¶ˆç·¨è¼¯</button>
        </form>
    </div>

    <div id="expenseFormTab" class="tab-content">
        <h3 id="expenseFormTitle">è¨˜éŒ„å…¶ä»–èŠ±è²»</h3>
        <form id="expenseForm" class="form-section">
            <input type="hidden" id="editingExpenseId">
            <div class="input-group"><label for="eDate">æ—¥æœŸ:</label><input type="date" id="eDate" required><button type="button" class="now-btn" onclick="fillNow('eDate', 'eTime')">ç¾åœ¨</button></div>
            <div class="input-group"><label for="eTime">æ™‚é–“:</label><input type="time" id="eTime" required></div>
            <div class="input-group"><label for="eOdo">ç¸½é‡Œç¨‹ (ODO):</label><input type="number" id="eOdo" placeholder="å…¬é‡Œ"></div>
            <div class="input-group"><label for="eCategory">é¡åˆ¥:</label>
                <select id="eCategory">
                    <option value="ä¿éšª">ä¿éšª</option>
                    <option value="ç‰Œç…§ç¨…">ç‰Œç…§ç¨…</option>
                    <option value="åœè»Šè²»">åœè»Šè²»</option>
                    <option value="é…ä»¶">é…ä»¶</option>
                    <option value="æ¸…æ½”">æ¸…æ½”</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>
            <div class="input-group"><label for="eAmount">é‡‘é¡ (NT$):</label><input type="number" id="eAmount" placeholder="è²»ç”¨" required></div>
            <div class="input-group"><label for="eDescription">èªªæ˜:</label><textarea id="eDescription" rows="3" placeholder="è©³ç´°èªªæ˜"></textarea></div>
            <button type="submit" class="main-btn">å„²å­˜è¨˜éŒ„</button>
            <button type="button" class="main-btn cancel-edit-btn" id="cancelExpenseEdit" onclick="cancelEdit('expense')">å–æ¶ˆç·¨è¼¯</button>
        </form>
    </div>

    <h2 style="margin-top: 40px;">æ­·å²è¨˜éŒ„èˆ‡åˆ†æ</h2>
    <div class="tabs" id="historyTabs">
        <button class="tab-button" onclick="openTab(event, 'chargeHistoryTab')">å……é›»æ­·å²</button>
        <button class="tab-button" onclick="openTab(event, 'maintenanceHistoryTab')">ä¿é¤Šæ­·å²</button>
        <button class="tab-button" onclick="openTab(event, 'expenseHistoryTab')">èŠ±è²»è¨˜éŒ„</button>
        <button class="tab-button" onclick="openTab(event, 'statisticsTab')">çµ±è¨ˆåˆ†æ</button>
    </div>

    <div id="chargeHistoryTab" class="tab-content">
        <div class="filter-section">
            <input type="text" class="search-box" id="chargeSearch" placeholder="æœå°‹å……é›»ç«™..." onkeyup="filterTable('chargeHistoryTable', this.value)">
            <select id="chargeMonthFilter" onchange="filterByMonth('charge')">
                <option value="">æ‰€æœ‰æœˆä»½</option>
            </select>
        </div>
        <div class="analytics-section">
            <div class="analytics-item"><h4>å¹³å‡æ•ˆç‡</h4><p id="avgKwh">N/A</p></div>
            <div class="analytics-item"><h4>æœ€ä½³æ•ˆç‡</h4><p id="bestKwh">N/A</p></div>
            <div class="analytics-item"><h4>æœ€å·®æ•ˆç‡</h4><p id="worstKwh">N/A</p></div>
            <div class="analytics-item"><h4>ç¸½å……é›»æ¬¡æ•¸</h4><p id="totalCharges">0</p></div>
        </div>
        <div class="table-container">
            <table class="history-table">
                <thead><tr><th>æ—¥æœŸ</th><th>ODO</th><th>kWh</th><th>è²»ç”¨</th><th>æ•ˆç‡</th><th>é›»é‡</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="chargeHistoryTable"></tbody>
            </table>
        </div>
        <div class="chart-container" style="margin-top:20px;"><canvas id="chargeChart"></canvas></div>
    </div>

    <div id="maintenanceHistoryTab" class="tab-content">
        <div class="filter-section">
            <input type="text" class="search-box" id="maintSearch" placeholder="æœå°‹å…§å®¹..." onkeyup="filterTable('maintenanceHistoryTable', this.value)">
            <select id="maintMonthFilter" onchange="filterByMonth('maint')">
                <option value="">æ‰€æœ‰æœˆä»½</option>
            </select>
            <select id="maintTypeFilter" onchange="filterByType()">
                <option value="">æ‰€æœ‰é¡å‹</option>
                <option value="å®šæœŸä¿é¤Š">å®šæœŸä¿é¤Š</option>
                <option value="å¤§ä¿é¤Š">å¤§ä¿é¤Š</option>
                <option value="å°ä¿é¤Š">å°ä¿é¤Š</option>
                <option value="ç¶­ä¿®">ç¶­ä¿®</option>
                <option value="æª¢æŸ¥">æª¢æŸ¥</option>
            </select>
        </div>
        <div class="table-container">
            <table class="history-table">
                <thead><tr><th>æ—¥æœŸ</th><th>ODO</th><th>é¡å‹</th><th>é …ç›®/å‚™è¨»</th><th>è²»ç”¨</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="maintenanceHistoryTable"></tbody>
            </table>
        </div>
        <div class="chart-container" style="margin-top:20px;"><canvas id="maintenanceChart"></canvas></div>
    </div>

    <div id="expenseHistoryTab" class="tab-content">
        <div class="filter-section">
            <select id="expenseCategoryFilter" onchange="filterByCategory()">
                <option value="">æ‰€æœ‰é¡åˆ¥</option>
                <option value="ä¿éšª">ä¿éšª</option>
                <option value="ç‰Œç…§ç¨…">ç‰Œç…§ç¨…</option>
                <option value="åœè»Šè²»">åœè»Šè²»</option>
                <option value="é…ä»¶">é…ä»¶</option>
                <option value="æ¸…æ½”">æ¸…æ½”</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
            <select id="expenseMonthFilter" onchange="filterByMonth('expense')">
                <option value="">æ‰€æœ‰æœˆä»½</option>
            </select>
        </div>
        <div class="table-container">
            <table class="history-table">
                <thead><tr><th>æ—¥æœŸ</th><th>é¡åˆ¥</th><th>é‡‘é¡</th><th>èªªæ˜</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="expenseHistoryTable"></tbody>
            </table>
        </div>
        <div class="chart-container" style="margin-top:20px;"><canvas id="expenseChart"></canvas></div>
    </div>

    <div id="statisticsTab" class="tab-content">
        <h3>æ•´é«”çµ±è¨ˆ</h3>
        <div class="statistics-grid">
            <div class="stat-card"><h4>ç¸½é‡Œç¨‹</h4><p id="statTotalMileage">0 km</p></div>
            <div class="stat-card"><h4>å¹³å‡æ—¥é‡Œç¨‹</h4><p id="statAvgDaily">0 km</p></div>
            <div class="stat-card"><h4>ç¸½èŠ±è²»</h4><p id="statTotalCost">0 NT$</p></div>
            <div class="stat-card"><h4>æ¯å…¬é‡Œæˆæœ¬</h4><p id="statCostPerKm">0 NT$</p></div>
            <div class="stat-card"><h4>ä¿é¤Šæ¬¡æ•¸</h4><p id="statMaintCount">0</p></div>
            <div class="stat-card"><h4>å……é›»æ¬¡æ•¸</h4><p id="statChargeCount">0</p></div>
        </div>
        <h3>æœˆåº¦èŠ±è²»åˆ†æ</h3>
        <div class="chart-container"><canvas id="monthlyExpenseChart"></canvas></div>
        <h3>èŠ±è²»é¡åˆ¥åˆ†å¸ƒ</h3>
        <div class="chart-container"><canvas id="categoryPieChart"></canvas></div>
    </div>
    
    <div class="data-management-section">
        <h3>è³‡æ–™ç®¡ç†</h3>
        <input type="file" id="jsonImportInput" accept=".json" onchange="handleJsonImport(event)">
        <button onclick="document.getElementById('jsonImportInput').click();">åŒ¯å…¥ JSON</button>
        <button onclick="exportData('chargeLog', 'json')">åŒ¯å‡ºå……é›» JSON</button>
        <button onclick="exportData('maintenanceLog', 'json')">åŒ¯å‡ºä¿é¤Š JSON</button>
        <button onclick="exportData('expenseLog', 'json')">åŒ¯å‡ºèŠ±è²» JSON</button>
        <button onclick="exportAllData()">åŒ¯å‡ºå…¨éƒ¨è³‡æ–™</button>
        <button onclick="if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—?æ­¤æ“ä½œç„¡æ³•å¾©åŸ!')) { clearAllData(); }" style="color: var(--danger-color); border-color: var(--danger-color);">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
    </div>
</div>

<script>
const SERVICE_INTERVAL_KM = 1000;
const SERVICE_INTERVAL_DAYS = 60;
let chargeChartInstance, maintenanceChartInstance, expenseChartInstance, monthlyExpenseChartInstance, categoryPieChartInstance;

document.addEventListener('DOMContentLoaded', function() {
    document.querySelector('#formTabs .tab-button').click();
    document.querySelector('#historyTabs .tab-button').click();
    loadAllData();
    populateMonthFilters();
});

function loadAllData() {
    loadMaintenanceHistory();
    loadChargeHistory();
    loadExpenseHistory();
    updateSummary();
    updateAnalytics();
    renderCharts();
}

function openTab(evt, tabName) {
    const parentTabs = evt.currentTarget.parentElement;
    parentTabs.parentElement.querySelectorAll('.tab-content').forEach(tc => tc.style.display = "none");
    parentTabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove("active"));
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.classList.add("active");
}

function fillNow(dateId, timeId) {
    const now = new Date();
    const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString();
    document.getElementById(dateId).value = localDate.slice(0, 10);
    document.getElementById(timeId).value = localDate.slice(11, 16);
}

function addPartItem(name = '', cost = '') {
    const partsList = document.getElementById('partsList');
    const newItem = document.createElement('div');
    newItem.className = 'part-item';
    newItem.innerHTML = `
        <input type="text" class="part-name" placeholder="é …ç›®/é›¶ä»¶åç¨±" value="${name}" oninput="updateTotalCost()">
        <input type="number" class="part-cost" placeholder="è²»ç”¨" value="${cost}" oninput="updateTotalCost()">
        <button type="button" class="remove-part-btn" onclick="this.parentElement.remove(); updateTotalCost();">X</button>
    `;
    partsList.appendChild(newItem);
    updateTotalCost();
}

function updateTotalCost() {
    let total = 0;
    document.querySelectorAll('#partsList .part-cost').forEach(input => {
        total += parseFloat(input.value) || 0;
    });
    document.getElementById('totalCost').textContent = total;
}

document.getElementById('chargeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const editingId = document.getElementById('editingChargeId').value;
    const record = {
        id: editingId ? parseInt(editingId) : Date.now(),
        date: document.getElementById('cDate').value,
        time: document.getElementById('cTime').value,
        odo: parseFloat(document.getElementById('cOdo').value),
        kwh: parseFloat(document.getElementById('cKwh').value),
        cost: parseFloat(document.getElementById('cCost').value) || 0,
        station: document.getElementById('cStation').value,
        batteryStart: document.getElementById('cBatteryStart').value,
        batteryEnd: document.getElementById('cBatteryEnd').value,
        trip: document.getElementById('cTrip').value,
        range: document.getElementById('cRange').value,
        notes: document.getElementById('cNotes').value
    };
    saveData('chargeLog', record, !!editingId);
    cancelEdit('charge');
    alert('å……é›»è¨˜éŒ„å·²å„²å­˜!');
    loadAllData();
});

document.getElementById('maintenanceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const editingId = document.getElementById('editingMaintId').value;
    const parts = [];
    document.querySelectorAll('#partsList .part-item').forEach(item => {
        parts.push({
            name: item.querySelector('.part-name').value,
            cost: parseFloat(item.querySelector('.part-cost').value) || 0
        });
    });
    const record = {
        id: editingId ? parseInt(editingId) : Date.now(),
        date: document.getElementById('mDate').value,
        time: document.getElementById('mTime').value,
        odo: parseFloat(document.getElementById('mOdo').value),
        location: document.getElementById('mLocation').value,
        type: document.getElementById('mType').value,
        notes: document.getElementById('mNotes').value,
        parts: parts,
        totalCost: parseFloat(document.getElementById('totalCost').textContent)
    };
    saveData('maintenanceLog', record, !!editingId);
    cancelEdit('maint');
    alert('ä¿é¤Šè¨˜éŒ„å·²å„²å­˜!');
    loadAllData();
});

document.getElementById('expenseForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const editingId = document.getElementById('editingExpenseId').value;
    const record = {
        id: editingId ? parseInt(editingId) : Date.now(),
        date: document.getElementById('eDate').value,
        time: document.getElementById('eTime').value,
        odo: parseFloat(document.getElementById('eOdo').value) || 0,
        category: document.getElementById('eCategory').value,
        amount: parseFloat(document.getElementById('eAmount').value),
        description: document.getElementById('eDescription').value
    };
    saveData('expenseLog', record, !!editingId);
    cancelEdit('expense');
    alert('èŠ±è²»è¨˜éŒ„å·²å„²å­˜!');
    loadAllData();
});

function saveData(key, newRecord, isEdit = false) {
    let data = JSON.parse(localStorage.getItem(key)) || [];
    if (isEdit) {
        const index = data.findIndex(item => item.id === newRecord.id);
        if (index > -1) data[index] = newRecord;
    } else {
        data.push(newRecord);
    }
    data.sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
    localStorage.setItem(key, JSON.stringify(data));
}

function editRecord(key, id) {
    const data = JSON.parse(localStorage.getItem(key)) || [];
    const record = data.find(item => item.id === id);
    if (!record) return;

    if (key === 'chargeLog') {
        document.getElementById('editingChargeId').value = record.id;
        document.getElementById('cDate').value = record.date;
        document.getElementById('cTime').value = record.time;
        document.getElementById('cOdo').value = record.odo;
        document.getElementById('cKwh').value = record.kwh;
        document.getElementById('cCost').value = record.cost || '';
        document.getElementById('cStation').value = record.station || '';
        document.getElementById('cBatteryStart').value = record.batteryStart || '';
        document.getElementById('cBatteryEnd').value = record.batteryEnd || '';
        document.getElementById('cTrip').value = record.trip || '';
        document.getElementById('cRange').value = record.range || '';
        document.getElementById('cNotes').value = record.notes || '';
        document.getElementById('chargeFormTitle').textContent = 'ç·¨è¼¯å……é›»è¨˜éŒ„';
        document.getElementById('cancelChargeEdit').style.display = 'block';
        document.querySelector('#formTabs button:nth-child(1)').click();
        window.scrollTo(0, 0);
    } else if (key === 'maintenanceLog') {
        document.getElementById('editingMaintId').value = record.id;
        document.getElementById('mDate').value = record.date;
        document.getElementById('mTime').value = record.time;
        document.getElementById('mOdo').value = record.odo;
        document.getElementById('mLocation').value = record.location || '';
        document.getElementById('mType').value = record.type || 'å®šæœŸä¿é¤Š';
        document.getElementById('mNotes').value = record.notes || '';
        document.getElementById('partsList').innerHTML = '';
        if (record.parts) record.parts.forEach(p => addPartItem(p.name, p.cost));
        updateTotalCost();
        document.getElementById('maintFormTitle').textContent = 'ç·¨è¼¯ä¿é¤Šè¨˜éŒ„';
        document.getElementById('cancelMaintEdit').style.display = 'block';
        document.querySelector('#formTabs button:nth-child(2)').click();
        window.scrollTo(0, 0);
    } else if (key === 'expenseLog') {
        document.getElementById('editingExpenseId').value = record.id;
        document.getElementById('eDate').value = record.date;
        document.getElementById('eTime').value = record.time;
        document.getElementById('eOdo').value = record.odo || '';
        document.getElementById('eCategory').value = record.category;
        document.getElementById('eAmount').value = record.amount;
        document.getElementById('eDescription').value = record.description || '';
        document.getElementById('expenseFormTitle').textContent = 'ç·¨è¼¯èŠ±è²»è¨˜éŒ„';
        document.getElementById('cancelExpenseEdit').style.display = 'block';
        document.querySelector('#formTabs button:nth-child(3)').click();
        window.scrollTo(0, 0);
    }
}

function deleteRecord(key, id) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—?æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
    let data = JSON.parse(localStorage.getItem(key)) || [];
    data = data.filter(item => item.id !== id);
    localStorage.setItem(key, JSON.stringify(data));
    loadAllData();
}

function cancelEdit(type) {
    if (type === 'charge') {
        document.getElementById('chargeForm').reset();
        document.getElementById('editingChargeId').value = '';
        document.getElementById('chargeFormTitle').textContent = 'è¨˜éŒ„å……é›»';
        document.getElementById('cancelChargeEdit').style.display = 'none';
    } else if (type === 'maint') {
        document.getElementById('maintenanceForm').reset();
        document.getElementById('editingMaintId').value = '';
        document.getElementById('partsList').innerHTML = '';
        updateTotalCost();
        document.getElementById('maintFormTitle').textContent = 'è¨˜éŒ„ä¿é¤Š';
        document.getElementById('cancelMaintEdit').style.display = 'none';
    } else if (type === 'expense') {
        document.getElementById('expenseForm').reset();
        document.getElementById('editingExpenseId').value = '';
        document.getElementById('expenseFormTitle').textContent = 'è¨˜éŒ„å…¶ä»–èŠ±è²»';
        document.getElementById('cancelExpenseEdit').style.display = 'none';
    }
}

function loadChargeHistory() {
    const data = JSON.parse(localStorage.getItem('chargeLog')) || [];
    const tableBody = document.getElementById('chargeHistoryTable');
    tableBody.innerHTML = '';
    
    for(let i = 0; i < data.length; i++) {
        data[i].efficiency = (i > 0 && data[i].kwh > 0 && data[i].odo - data[i-1].odo > 0) 
            ? ((data[i].odo - data[i-1].odo) / data[i].kwh).toFixed(2) : 'N/A';
    }

    [...data].reverse().forEach(record => {
        const row = tableBody.insertRow();
        row.innerHTML = `
            <td>${record.date.slice(5)}</td>
            <td>${record.odo}</td>
            <td>${record.kwh}</td>
            <td>${record.cost || '-'}</td>
            <td>${record.efficiency}</td>
            <td>${record.batteryStart || ''}â†’${record.batteryEnd || ''}</td>
            <td class="action-buttons">
                <button class="edit-btn" onclick="editRecord('chargeLog', ${record.id})">ç·¨è¼¯</button>
                <button class="delete-btn" onclick="deleteRecord('chargeLog', ${record.id})">åˆªé™¤</button>
            </td>`;
    });
}

function loadMaintenanceHistory() {
    const data = JSON.parse(localStorage.getItem('maintenanceLog')) || [];
    const tableBody = document.getElementById('maintenanceHistoryTable');
    tableBody.innerHTML = '';
    
    [...data].reverse().forEach(record => {
        const row = tableBody.insertRow();
        let itemsDesc = record.parts && record.parts.length > 0 ? record.parts.map(p => p.name).join(', ') : record.notes;
        if (itemsDesc && itemsDesc.length > 30) itemsDesc = itemsDesc.substring(0, 30) + '...';
        row.innerHTML = `
            <td>${record.date.slice(5)}</td>
            <td>${record.odo}</td>
            <td>${record.type || '-'}</td>
            <td>${itemsDesc || '-'}</td>
            <td>${record.totalCost}</td>
            <td class="action-buttons">
                <button class="edit-btn" onclick="editRecord('maintenanceLog', ${record.id})">ç·¨è¼¯</button>
                <button class="delete-btn" onclick="deleteRecord('maintenanceLog', ${record.id})">åˆªé™¤</button>
            </td>`;
    });
}

function loadExpenseHistory() {
    const data = JSON.parse(localStorage.getItem('expenseLog')) || [];
    const tableBody = document.getElementById('expenseHistoryTable');
    tableBody.innerHTML = '';
    
    [...data].reverse().forEach(record => {
        const row = tableBody.insertRow();
        row.innerHTML = `
            <td>${record.date.slice(5)}</td>
            <td>${record.category}</td>
            <td>${record.amount}</td>
            <td>${record.description || '-'}</td>
            <td class="action-buttons">
                <button class="edit-btn" onclick="editRecord('expenseLog', ${record.id})">ç·¨è¼¯</button>
                <button class="delete-btn" onclick="deleteRecord('expenseLog', ${record.id})">åˆªé™¤</button>
            </td>`;
    });
}

function daysBetween(date1, date2) {
    return Math.round(Math.abs((new Date(date1) - new Date(date2)) / (24 * 60 * 60 * 1000)));
}

function updateSummary() {
    const maintData = JSON.parse(localStorage.getItem('maintenanceLog')) || [];
    const chargeData = JSON.parse(localStorage.getItem('chargeLog')) || [];
    const expenseData = JSON.parse(localStorage.getItem('expenseLog')) || [];
    const today = new Date().toISOString().slice(0, 10);

    let totalMileage = 0;
    const allOdoData = [...chargeData, ...maintData, ...expenseData].filter(d => d.odo > 0);
    if(allOdoData.length > 0) {
        totalMileage = Math.max(...allOdoData.map(d => d.odo));
    }
    document.getElementById('totalMileage').textContent = totalMileage;

    let totalExpense = 0;
    maintData.forEach(m => totalExpense += m.totalCost || 0);
    chargeData.forEach(c => totalExpense += c.cost || 0);
    expenseData.forEach(e => totalExpense += e.amount || 0);
    document.getElementById('totalExpense').textContent = totalExpense.toFixed(0);

    if (maintData.length > 0) {
        const last = maintData[maintData.length - 1];
        const daysAgo = daysBetween(last.date, today);
        document.getElementById('lastMaintenance').textContent = `${last.date} (${daysAgo}å¤©å‰)`;
        document.getElementById('lastMaintOdo').textContent = `${last.odo} km`;

        const currentOdo = totalMileage;
        const kmSince = currentOdo - last.odo;
        const kmLeft = SERVICE_INTERVAL_KM - kmSince;
        const daysLeft = SERVICE_INTERVAL_DAYS - daysAgo;

        if (kmLeft <= 0 || daysLeft <= 0) {
            document.getElementById('nextService').textContent = `å·²è¶…éä¿é¤Šé‡Œç¨‹/æ™‚é–“`;
            document.getElementById('nextService').style.color = 'var(--danger-color)';
        } else {
            document.getElementById('nextService').textContent = `ç´„ ${kmLeft.toFixed(0)} km æˆ– ${daysLeft} å¤©å¾Œ`;
            document.getElementById('nextService').style.color = 'var(--success-color)';
        }
    }

    if (chargeData.length > 0) {
        const last = chargeData[chargeData.length - 1];
        const daysAgo = daysBetween(last.date, today);
        document.getElementById('lastCharge').textContent = `${last.date} (${daysAgo}å¤©å‰)`;
        document.getElementById('lastChargeOdo').textContent = `${last.odo} km`;
    }

    document.getElementById('statTotalMileage').textContent = `${totalMileage} km`;
    document.getElementById('statTotalCost').textContent = `${totalExpense.toFixed(0)} NT$`;
    document.getElementById('statMaintCount').textContent = maintData.length;
    document.getElementById('statChargeCount').textContent = chargeData.length;
    
    if (totalMileage > 0) {
        document.getElementById('statCostPerKm').textContent = `${(totalExpense / totalMileage).toFixed(2)} NT$`;
    } else {
        document.getElementById('statCostPerKm').textContent = `0 NT$`;
    }
    
    const allData = [...chargeData, ...maintData, ...expenseData];
    if (allData.length > 1) {
        const firstDate = new Date(allData.sort((a,b) => new Date(a.date) - new Date(b.date))[0].date);
        const lastDate = new Date();
        const days = daysBetween(firstDate, lastDate) || 1;
        const avgDaily = totalMileage / days;
        document.getElementById('statAvgDaily').textContent = `${avgDaily.toFixed(1)} km`;
    } else {
        document.getElementById('statAvgDaily').textContent = `0 km`;
    }
}

function updateAnalytics() {
    const data = JSON.parse(localStorage.getItem('chargeLog')) || [];
    document.getElementById('totalCharges').textContent = data.length;
    
    if (data.length < 2) {
        document.getElementById('avgKwh').textContent = 'N/A';
        document.getElementById('bestKwh').textContent = 'N/A';
        document.getElementById('worstKwh').textContent = 'N/A';
        return;
    }
    
    let efficiencies = [];
    for(let i = 1; i < data.length; i++) {
        const odoDiff = data[i].odo - data[i-1].odo;
        const kwh = data[i].kwh;
        if (kwh > 0 && odoDiff > 0) efficiencies.push(odoDiff / kwh);
    }
    
    if (efficiencies.length > 0) {
        const total = efficiencies.reduce((a, b) => a + b, 0);
        document.getElementById('avgKwh').textContent = `${(total / efficiencies.length).toFixed(2)} km/kWh`;
        document.getElementById('bestKwh').textContent = `${Math.max(...efficiencies).toFixed(2)} km/kWh`;
        document.getElementById('worstKwh').textContent = `${Math.min(...efficiencies).toFixed(2)} km/kWh`;
    }
}

function populateMonthFilters() {
    const allData = [
        ...JSON.parse(localStorage.getItem('chargeLog') || '[]'),
        ...JSON.parse(localStorage.getItem('maintenanceLog') || '[]'),
        ...JSON.parse(localStorage.getItem('expenseLog') || '[]')
    ];
    
    const months = new Set();
    allData.forEach(record => {
        if (record.date) months.add(record.date.slice(0, 7));
    });
    
    const sortedMonths = Array.from(months).sort().reverse();
    
    ['chargeMonthFilter', 'maintMonthFilter', 'expenseMonthFilter'].forEach(filterId => {
        const select = document.getElementById(filterId);
        select.innerHTML = '<option value="">æ‰€æœ‰æœˆä»½</option>';
        sortedMonths.forEach(month => {
            const option = document.createElement('option');
            option.value = month;
            option.textContent = month;
            select.appendChild(option);
        });
    });
}

function filterTable(tableId, searchText) {
    const table = document.getElementById(tableId);
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchText.toLowerCase()) ? '' : 'none';
    }
}

function filterByMonth(type) {
    const tableIdMap = {
        charge: 'chargeHistoryTable',
        maint: 'maintenanceHistoryTable',
        expense: 'expenseHistoryTable'
    };
    const logKeyMap = {
        charge: 'chargeLog',
        maint: 'maintenanceLog',
        expense: 'expenseLog'
    };
    
    const filterId = `${type}MonthFilter`;
    const selectedMonth = document.getElementById(filterId).value;
    const tableBody = document.getElementById(tableIdMap[type]);
    const data = JSON.parse(localStorage.getItem(logKeyMap[type]) || '[]').reverse();

    for (let i = 0; i < tableBody.rows.length; i++) {
        const row = tableBody.rows[i];
        const record = data[i];
        if (record) {
             row.style.display = (!selectedMonth || record.date.startsWith(selectedMonth)) ? '' : 'none';
        }
    }
}

function filterByType() {
    const selectedType = document.getElementById('maintTypeFilter').value;
    const tableBody = document.getElementById('maintenanceHistoryTable');
    const data = JSON.parse(localStorage.getItem('maintenanceLog') || '[]').reverse();

     for (let i = 0; i < tableBody.rows.length; i++) {
        const row = tableBody.rows[i];
        const record = data[i];
        if (record) {
             row.style.display = (!selectedType || record.type === selectedType) ? '' : 'none';
        }
    }
}

function filterByCategory() {
    const selectedCategory = document.getElementById('expenseCategoryFilter').value;
    const tableBody = document.getElementById('expenseHistoryTable');
    const data = JSON.parse(localStorage.getItem('expenseLog') || '[]').reverse();
    
    for (let i = 0; i < tableBody.rows.length; i++) {
        const row = tableBody.rows[i];
        const record = data[i];
        if (record) {
             row.style.display = (!selectedCategory || record.category === selectedCategory) ? '' : 'none';
        }
    }
}

function handleJsonImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            if (importedData.type === 'all') {
                if (!confirm('ç¢ºå®šè¦åŒ¯å…¥å®Œæ•´è³‡æ–™å—?é€™å°‡æœƒè¦†è“‹ç¾æœ‰çš„æ‰€æœ‰è¨˜éŒ„ã€‚')) return;
                if (importedData.chargeLog) localStorage.setItem('chargeLog', JSON.stringify(importedData.chargeLog));
                if (importedData.maintenanceLog) localStorage.setItem('maintenanceLog', JSON.stringify(importedData.maintenanceLog));
                if (importedData.expenseLog) localStorage.setItem('expenseLog', JSON.stringify(importedData.expenseLog));
                alert('å®Œæ•´è³‡æ–™åŒ¯å…¥æˆåŠŸ!');
            } else if (importedData.type && Array.isArray(importedData.data)) {
                if (!confirm('ç¢ºå®šè¦åŒ¯å…¥è³‡æ–™å—?é€™å°‡æœƒè¦†è“‹ç¾æœ‰çš„åŒé¡å‹è¨˜éŒ„ã€‚')) return;
                localStorage.setItem(importedData.type, JSON.stringify(importedData.data));
                alert('è³‡æ–™åŒ¯å…¥æˆåŠŸ!');
            } else {
                alert('JSON æª”æ¡ˆæ ¼å¼ä¸ç¬¦!');
                return;
            }
            
            loadAllData();
            populateMonthFilters();
        } catch (error) {
            alert('è®€å–æª”æ¡ˆå¤±æ•—,è«‹ç¢ºèªæ˜¯å¦ç‚ºæ­£ç¢ºçš„ JSON æª”æ¡ˆã€‚');
        } finally {
            event.target.value = '';
        }
    };
    reader.readAsText(file);
}

function exportData(key, format) {
    const data = JSON.parse(localStorage.getItem(key) || '[]');
    if (data.length === 0) {
        alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º!');
        return;
    }
    const dataToExport = {
        type: key,
        version: '2.0',
        exportDate: new Date().toISOString(),
        data: data
    };
    const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${key}_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function exportAllData() {
    const allData = {
        type: 'all',
        version: '2.0',
        exportDate: new Date().toISOString(),
        chargeLog: JSON.parse(localStorage.getItem('chargeLog') || '[]'),
        maintenanceLog: JSON.parse(localStorage.getItem('maintenanceLog') || '[]'),
        expenseLog: JSON.parse(localStorage.getItem('expenseLog') || '[]')
    };
    
    const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `motorcycle_all_data_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function clearAllData() {
    localStorage.removeItem('chargeLog');
    localStorage.removeItem('maintenanceLog');
    localStorage.removeItem('expenseLog');
    loadAllData();
    alert('æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤!');
}

function renderCharts() {
    const maintData = JSON.parse(localStorage.getItem('maintenanceLog')) || [];
    const chargeData = JSON.parse(localStorage.getItem('chargeLog')) || [];
    const expenseData = JSON.parse(localStorage.getItem('expenseLog') || '[]');

    if (maintenanceChartInstance) maintenanceChartInstance.destroy();
    if (maintData.length > 0) {
        const ctx = document.getElementById('maintenanceChart').getContext('2d');
        maintenanceChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: maintData.map(d => `${d.date.slice(5)}`),
                datasets: [{
                    label: 'ä¿é¤Šè²»ç”¨ (NT$)',
                    data: maintData.map(d => d.totalCost),
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.1
                }]
            },
            options: { responsive: true, plugins: { legend: { display: true }}}
        });
    }

    if (chargeChartInstance) chargeChartInstance.destroy();
    if (chargeData.length > 1) {
        const efficiencies = [];
        for(let i = 1; i < chargeData.length; i++) {
            const odoDiff = chargeData[i].odo - chargeData[i-1].odo;
            const kwh = chargeData[i].kwh;
            efficiencies.push({
                label: chargeData[i].date.slice(5),
                value: (kwh > 0 && odoDiff > 0) ? (odoDiff / kwh) : 0
            });
        }
        const ctx = document.getElementById('chargeChart').getContext('2d');
        chargeChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: efficiencies.map(e => e.label),
                datasets: [{
                    label: 'å……é›»æ•ˆç‡ (km/kWh)',
                    data: efficiencies.map(e => e.value),
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, plugins: { legend: { display: true }}}
        });
    }

    if (expenseChartInstance) expenseChartInstance.destroy();
    if (expenseData.length > 0) {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        expenseChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: expenseData.map(d => `${d.date.slice(5)}`),
                datasets: [{
                    label: 'èŠ±è²»é‡‘é¡ (NT$)',
                    data: expenseData.map(d => d.amount),
                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, plugins: { legend: { display: true }}}
        });
    }

    renderMonthlyExpenseChart();
    renderCategoryPieChart();
}

function renderMonthlyExpenseChart() {
    const maintData = JSON.parse(localStorage.getItem('maintenanceLog') || '[]');
    const chargeData = JSON.parse(localStorage.getItem('chargeLog') || '[]');
    const expenseData = JSON.parse(localStorage.getItem('expenseLog') || '[]');
    
    const monthlyData = {};
    
    maintData.forEach(m => {
        const month = m.date.slice(0, 7);
        monthlyData[month] = (monthlyData[month] || 0) + (m.totalCost || 0);
    });
    
    chargeData.forEach(c => {
        const month = c.date.slice(0, 7);
        monthlyData[month] = (monthlyData[month] || 0) + (c.cost || 0);
    });
    
    expenseData.forEach(e => {
        const month = e.date.slice(0, 7);
        monthlyData[month] = (monthlyData[month] || 0) + (e.amount || 0);
    });
    
    const sortedMonths = Object.keys(monthlyData).sort();
    
    if (monthlyExpenseChartInstance) monthlyExpenseChartInstance.destroy();
    if (sortedMonths.length > 0) {
        const ctx = document.getElementById('monthlyExpenseChart').getContext('2d');
        monthlyExpenseChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedMonths,
                datasets: [{
                    label: 'æœˆåº¦ç¸½èŠ±è²» (NT$)',
                    data: sortedMonths.map(m => monthlyData[m]),
                    borderColor: 'rgb(153, 102, 255)',
                    backgroundColor: 'rgba(153, 102, 255, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: { responsive: true, plugins: { legend: { display: true }}}
        });
    }
}

function renderCategoryPieChart() {
    const maintData = JSON.parse(localStorage.getItem('maintenanceLog') || '[]');
    const chargeData = JSON.parse(localStorage.getItem('chargeLog') || '[]');
    const expenseData = JSON.parse(localStorage.getItem('expenseLog') || '[]');
    
    const categoryData = { 'ä¿é¤Š': 0, 'å……é›»': 0 };
    
    maintData.forEach(m => categoryData['ä¿é¤Š'] += m.totalCost || 0);
    chargeData.forEach(c => categoryData['å……é›»'] += c.cost || 0);
    expenseData.forEach(e => {
        categoryData[e.category] = (categoryData[e.category] || 0) + e.amount;
    });
    
    const categories = Object.keys(categoryData).filter(k => categoryData[k] > 0);
    const values = categories.map(k => categoryData[k]);
    
    if (categoryPieChartInstance) categoryPieChartInstance.destroy();
    if (categories.length > 0) {
        const ctx = document.getElementById('categoryPieChart').getContext('2d');
        categoryPieChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: categories,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 159, 64, 0.8)',
                        'rgba(199, 199, 199, 0.8)'
                    ]
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' }}}
        });
    }
}
</script>
</body>
</html>

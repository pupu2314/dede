<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‘©æ‰˜è»Šè¼›è³‡è¨Šè¨˜éŒ„</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d; --light-bg: #f8f9fa;
            --border-color: #dee2e6; --text-color: #343a40; --white: #fff;
            --danger-color: #dc3545; --success-color: #28a745; --warning-color: #ffc107;
            --info-bg: #e2f3ff; --info-border: #b8e2fc;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 15px; background-color: var(--light-bg); color: var(--text-color);
        }
        .container {
            max-width: 800px; margin: 0 auto; background-color: var(--white);
            padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1, h2, h3 { color: var(--primary-color); text-align: center; }
        .summary {
            background-color: #e7f3ff; padding: 15px; border-radius: 8px;
            margin-bottom: 25px; border-left: 5px solid var(--primary-color);
        }
        .summary p { margin: 8px 0; font-size: 1em; }
        .summary span { font-weight: bold; color: #004085; }
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; flex-wrap: wrap; }
        .tab-button {
            padding: 10px 15px; cursor: pointer; border: none; background-color: transparent;
            font-size: 1.1em; margin-bottom: -2px; border-bottom: 3px solid transparent;
        }
        .tab-button.active { font-weight: bold; color: var(--primary-color); border-bottom: 3px solid var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-section { padding: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group small { color: var(--secondary-color); font-size: 0.8em; }
        input, textarea, select {
            width: 100%; padding: 10px; border: 1px solid var(--border-color);
            border-radius: 4px; box-sizing: border-box;
        }
        .now-btn {
            position: absolute; right: 5px; top: 28px; padding: 5px 8px;
            background-color: var(--secondary-color); color: var(--white); border: none;
            border-radius: 4px; cursor: pointer; font-size: 0.8em;
        }
        .main-btn {
            width: 100%; padding: 12px; background-color: var(--primary-color); color: var(--white);
            border: none; border-radius: 4px; cursor: pointer; font-size: 1.1em; margin-top: 10px;
        }
        .main-btn:hover { background-color: #0056b3; }
        #partsList .part-item { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; }
        #partsList .part-item input { margin-bottom: 0; }
        .remove-part-btn { padding: 8px 12px; background-color: var(--danger-color); color: var(--white); border: none; border-radius: 4px; cursor: pointer; }
        .add-part-btn { margin-top: 10px; background-color: var(--success-color); }
        .analytics-section {
            display: flex; flex-wrap: wrap; justify-content: space-around; background-color: var(--light-bg);
            padding: 15px; border-radius: 5px; margin: 20px 0; text-align: center; gap: 10px;
        }
        .analytics-item h4 { margin: 0 0 5px 0; color: var(--secondary-color); font-size: 0.9em; }
        .analytics-item p { margin: 0; font-size: 1.2em; font-weight: bold; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .history-table th, .history-table td { border: 1px solid var(--border-color); padding: 8px; text-align: left; vertical-align: middle;}
        .history-table th { background-color: var(--light-bg); }
        .table-container { overflow-x: auto; }
        .action-buttons button { font-size: 0.8em; padding: 4px 8px; margin-right: 5px; border-radius: 4px; cursor: pointer; border: none; color: white;}
        .edit-btn { background-color: var(--warning-color); }
        .delete-btn { background-color: var(--danger-color); }
        .data-management-section { margin-top: 30px; padding: 15px; border: 1px dashed var(--secondary-color); border-radius: 5px; }
        .data-management-section button {
            padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-right: 10px; margin-bottom: 10px;
            border: 1px solid var(--primary-color); background-color: var(--white); color: var(--primary-color);
        }
        .data-management-section button:hover { background-color: #e7f3ff; }
        #jsonImportInput { display: none; }
        .cancel-edit-btn { background-color: var(--secondary-color); display: none; }
        .filter-section { background-color: var(--light-bg); padding: 15px; border-radius: 5px; margin-bottom: 15px; }
        .radio-group label { margin-bottom: 0; font-weight: normal; }
        .radio-group input[type="radio"] { width: auto; margin-right: 5px; }
        .radio-group-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; text-align: center; }
        .radio-group-grid label { margin-bottom: 0; font-weight: normal; display: block; cursor: pointer; padding: 5px; border-radius: 4px; border: 1px solid var(--border-color); }
        .radio-group-grid input[type="radio"] { display: none; }
        .radio-group-grid input[type="radio"]:checked + label { background-color: var(--primary-color); color: var(--white); border-color: var(--primary-color); }
        .current-charge-info {
            background-color: var(--info-bg);
            border: 1px solid var(--info-border);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .current-charge-info p { margin: 5px 0; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸï¸ æ‘©æ‰˜è»Šè¼›è³‡è¨Šè¨˜éŒ„</h1>

    <div class="summary">
        <p>ä¸Šæ¬¡ä¿é¤Š: <span id="lastMaintenance">å°šæœªè¨˜éŒ„</span> | é‡Œç¨‹: <span id="lastMaintOdo">N/A</span></p>
        <p>ä¸Šæ¬¡å……é›»: <span id="lastCharge">å°šæœªè¨˜éŒ„</span> | é‡Œç¨‹: <span id="lastChargeOdo">N/A</span></p>
        <p>ä¸‹æ¬¡ä¿é¤Šé ä¼°: <span id="nextService">è«‹å…ˆè¨˜éŒ„ä¿é¤Š</span></p>
        <p>ç¸½é‡Œç¨‹: <span id="totalMileage">0</span> km | ç¸½èŠ±è²»: <span id="totalExpense">0</span> NT$</p>
    </div>

    <div class="tabs" id="formTabs">
        <button class="tab-button" data-tab="chargeFormTab">è¨˜éŒ„å……é›»</button>
        <button class="tab-button" data-tab="maintenanceFormTab">è¨˜éŒ„ä¿é¤Š</button>
        <button class="tab-button" data-tab="expenseFormTab">å…¶ä»–èŠ±è²»</button>
    </div>

    <div id="chargeFormTab" class="tab-content">
        <div id="startChargeSection">
            <h3>é–‹å§‹å……é›»</h3>
            <form id="startChargeForm" class="form-section">
                <div class="input-group"><label for="cOdo">ç›®å‰ç¸½é‡Œç¨‹ (ODO):</label><input type="number" step="0.1" id="cOdo" placeholder="å…¬é‡Œ" required><small>è¨˜éŒ„ç•¶ä¸‹å„€è¡¨æ¿çš„ç¸½é‡Œç¨‹æ•¸</small></div>
                <div class="input-group"><label>å……é›»å‰é›»é‡ (æ ¼):</label>
                    <div class="radio-group-grid">
                        <input type="radio" id="bs0" name="cBatteryStart" value="0"><label for="bs0">0</label>
                        <input type="radio" id="bs1" name="cBatteryStart" value="1" checked><label for="bs1">1</label>
                        <input type="radio" id="bs2" name="cBatteryStart" value="2"><label for="bs2">2</label>
                        <input type="radio" id="bs3" name="cBatteryStart" value="3"><label for="bs3">3</label>
                        <input type="radio" id="bs4" name="cBatteryStart" value="4"><label for="bs4">4</label>
                        <input type="radio" id="bs5" name="cBatteryStart" value="5"><label for="bs5">5</label>
                    </div>
                </div>
                <div class="input-group">
                    <label>å……é›»ç«™/æ¨™è¨˜:</label>
                    <div class="radio-group">
                        <input type="radio" id="station_company" name="cStationRadio" value="å…¬å¸" checked><label for="station_company">å…¬å¸</label>
                        <input type="radio" id="station_public" name="cStationRadio" value="å……é›»ç«™"><label for="station_public">å……é›»ç«™</label>
                        <input type="radio" id="station_other" name="cStationRadio" value="å…¶ä»–"><label for="station_other">å…¶ä»–</label>
                    </div>
                    <input type="text" id="cStation" placeholder="è«‹è¼¸å…¥åœ°é»" style="display:none; margin-top: 10px;">
                </div>
                <div class="input-group"><label for="cTrip">æœ¬æ¬¡é‡Œç¨‹ (TRIP):</label><input type="number" step="0.1" id="cTrip" placeholder="å…¬é‡Œ"><small>ä¸Šæ¬¡å……é£½é›»å¾Œåˆ°ç¾åœ¨çš„é‡Œç¨‹</small></div>
                <div class="input-group"><label for="cNotes">å‚™è¨»:</label><textarea id="cNotes" rows="2" placeholder="å…¶ä»–è¨˜éŒ„äº‹é …"></textarea></div>
                <button type="submit" class="main-btn" style="background-color: var(--success-color);">é–‹å§‹å……é›»</button>
            </form>
        </div>

        <div id="endChargeSection" style="display: none;">
            <h3>å……é›»é€²è¡Œä¸­...</h3>
            <div id="currentChargeInfo" class="current-charge-info"></div>
            <form id="endChargeForm" class="form-section">
                <div class="input-group"><label>å……é›»å¾Œé›»é‡ (æ ¼):</label>
                    <div class="radio-group-grid">
                        <input type="radio" id="be0" name="cBatteryEnd" value="0"><label for="be0">0</label>
                        <input type="radio" id="be1" name="cBatteryEnd" value="1"><label for="be1">1</label>
                        <input type="radio" id="be2" name="cBatteryEnd" value="2"><label for="be2">2</label>
                        <input type="radio" id="be3" name="cBatteryEnd" value="3"><label for="be3">3</label>
                        <input type="radio" id="be4" name="cBatteryEnd" value="4"><label for="be4">4</label>
                        <input type="radio" id="be5" name="cBatteryEnd" value="5" checked><label for="be5">5</label>
                    </div>
                </div>
                 <div class="input-group" id="kwh-input-group"><label for="cKwh">å……é›»åº¦æ•¸ (kWh):</label><input type="number" step="0.01" id="cKwh" placeholder="ä¾‹å¦‚:1.5"><small>æ’åº§ç«¯é‡æ¸¬å€¼ï¼Œéå¿…å¡«</small></div>
                 <div class="input-group" id="cost-input-group"><label for="cCost">å……é›»è²»ç”¨ (NT$):</label><input type="number" id="cCost" placeholder="ä¾‹å¦‚:30"></div>
                <div class="input-group"><label for="cRange">é ä¼°é‡Œç¨‹ (RANGE):</label><input type="number" step="0.1" id="cRange" placeholder="å…¬é‡Œ"><small>å„€è¡¨æ¿é ä¼°å€¼ï¼Œéå¿…å¡«</small></div>
                <button type="submit" class="main-btn">çµæŸå……é›»ä¸¦å„²å­˜</button>
            </form>
        </div>
    </div>

    <div id="maintenanceFormTab" class="tab-content">
        <h3 id="maintFormTitle">è¨˜éŒ„ä¿é¤Š</h3>
        <form id="maintenanceForm" class="form-section">
            <input type="hidden" id="editingMaintId">
            <div class="input-group"><label for="mDate">æ—¥æœŸ:</label><input type="date" id="mDate" required><button type="button" class="now-btn" id="maintNowBtn">ç¾åœ¨</button></div>
            <div class="input-group"><label for="mTime">æ™‚é–“:</label><input type="time" id="mTime" required></div>
            <div class="input-group"><label for="mOdo">ç¸½é‡Œç¨‹ (ODO):</label><input type="number" step="0.1" id="mOdo" placeholder="å…¬é‡Œ" required></div>
            <div class="input-group"><label for="mLocation">åœ°é»:</label><input type="text" id="mLocation" placeholder="ä¿é¤Šåœ°é»"></div>
            <div class="input-group"><label for="mType">ä¿é¤Šé¡å‹:</label>
                <select id="mType">
                    <option value="å®šæœŸä¿é¤Š">å®šæœŸä¿é¤Š</option>
                    <option value="å¤§ä¿é¤Š">å¤§ä¿é¤Š</option>
                    <option value="å°ä¿é¤Š">å°ä¿é¤Š</option>
                    <option value="ç¶­ä¿®">ç¶­ä¿®</option>
                    <option value="æª¢æŸ¥">æª¢æŸ¥</option>
                </select>
            </div>
            <div class="input-group"><label for="mNotes">æœå‹™/å‚™è¨»:</label><textarea id="mNotes" rows="3" placeholder="ä¾‹å¦‚:å¤§ä¿é¤Šã€æª¢æŸ¥é›»è·¯"></textarea></div>
            <h3>ä¿é¤Šé …ç›®/é›¶ä»¶</h3>
            <div id="partsList"></div>
            <button type="button" class="main-btn add-part-btn" id="addPartBtn">æ–°å¢é …ç›®</button>
            <hr>
            <p style="text-align: right; font-size: 1.2em; font-weight: bold;">ç¸½è²»ç”¨: NT$ <span id="totalCost">0</span></p>
            <button type="submit" class="main-btn">å„²å­˜è¨˜éŒ„</button>
            <button type="button" class="main-btn cancel-edit-btn" id="cancelMaintEdit">å–æ¶ˆç·¨è¼¯</button>
        </form>
    </div>

    <div id="expenseFormTab" class="tab-content">
        <h3 id="expenseFormTitle">è¨˜éŒ„å…¶ä»–èŠ±è²»</h3>
        <form id="expenseForm" class="form-section">
            <input type="hidden" id="editingExpenseId">
            <div class="input-group"><label for="eDate">æ—¥æœŸ:</label><input type="date" id="eDate" required><button type="button" class="now-btn" id="expenseNowBtn">ç¾åœ¨</button></div>
            <div class="input-group"><label for="eTime">æ™‚é–“:</label><input type="time" id="eTime" required></div>
            <div class="input-group"><label for="eOdo">ç¸½é‡Œç¨‹ (ODO):</label><input type="number" step="0.1" id="eOdo" placeholder="å…¬é‡Œ"></div>
            <div class="input-group"><label for="eCategory">é¡åˆ¥:</label>
                <select id="eCategory">
                    <option value="ä¿éšª">ä¿éšª</option>
                    <option value="ç‰Œç…§ç¨…">ç‰Œç…§ç¨…</option>
                    <option value="åœè»Šè²»">åœè»Šè²»</option>
                    <option value="é…ä»¶">é…ä»¶</option>
                    <option value="æ¸…æ½”">æ¸…æ½”</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
            </div>
            <div class="input-group"><label for="eAmount">é‡‘é¡ (NT$):</label><input type="number" id="eAmount" placeholder="è²»ç”¨" required></div>
            <div class="input-group"><label for="eDescription">èªªæ˜:</label><textarea id="eDescription" rows="3" placeholder="è©³ç´°èªªæ˜"></textarea></div>
            <button type="submit" class="main-btn">å„²å­˜è¨˜éŒ„</button>
            <button type="button" class="main-btn cancel-edit-btn" id="cancelExpenseEdit">å–æ¶ˆç·¨è¼¯</button>
        </form>
    </div>

    <h2 style="margin-top: 40px;">æ­·å²è¨˜éŒ„èˆ‡åˆ†æ</h2>
    <div class="tabs" id="historyTabs">
        <button class="tab-button" data-tab="chargeHistoryTab">å……é›»æ­·å²</button>
        <button class="tab-button" data-tab="maintenanceHistoryTab">ä¿é¤Šæ­·å²</button>
        <button class="tab-button" data-tab="expenseHistoryTab">èŠ±è²»è¨˜éŒ„</button>
        <button class="tab-button" data-tab="statisticsTab">çµ±è¨ˆåˆ†æ</button>
    </div>

    <div id="chargeHistoryTab" class="tab-content">
        <div class="filter-section">
            <input type="text" class="search-box" id="chargeSearch" placeholder="æœå°‹å……é›»ç«™...">
            <select id="chargeMonthFilter">
                <option value="">æ‰€æœ‰æœˆä»½</option>
            </select>
        </div>
        <div class="analytics-section">
            <div class="analytics-item"><h4>å¹³å‡æ•ˆç‡</h4><p id="avgEfficiency">N/A</p></div>
            <div class="analytics-item"><h4>æœ€ä½³æ•ˆç‡</h4><p id="bestEfficiency">N/A</p></div>
            <div class="analytics-item"><h4>æœ€å·®æ•ˆç‡</h4><p id="worstEfficiency">N/A</p></div>
            <div class="analytics-item"><h4>ç¸½å……é›»æ¬¡æ•¸</h4><p id="totalCharges">0</p></div>
        </div>
        <div class="table-container">
            <table class="history-table">
                <thead><tr><th>æœŸé–“</th><th>åœ°é»</th><th>TRIP</th><th>è²»ç”¨</th><th>æ•ˆç‡<br>(km/kWh)</th><th>é›»é‡</th><th>æ™‚é•·</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="chargeHistoryTable"></tbody>
            </table>
        </div>
        <div class="chart-container" style="margin-top:20px;"><canvas id="chargeChart"></canvas></div>
    </div>

    <div id="maintenanceHistoryTab" class="tab-content">
        <div class="filter-section">
            <input type="text" class="search-box" id="maintSearch" placeholder="æœå°‹å…§å®¹...">
            <select id="maintMonthFilter">
                <option value="">æ‰€æœ‰æœˆä»½</option>
            </select>
            <select id="maintTypeFilter">
                <option value="">æ‰€æœ‰é¡å‹</option>
                <option value="å®šæœŸä¿é¤Š">å®šæœŸä¿é¤Š</option>
                <option value="å¤§ä¿é¤Š">å¤§ä¿é¤Š</option>
                <option value="å°ä¿é¤Š">å°ä¿é¤Š</option>
                <option value="ç¶­ä¿®">ç¶­ä¿®</option>
                <option value="æª¢æŸ¥">æª¢æŸ¥</option>
            </select>
        </div>
        <div class="table-container">
            <table class="history-table">
                <thead><tr><th>æ—¥æœŸ</th><th>ODO</th><th>é¡å‹</th><th>é …ç›®/å‚™è¨»</th><th>è²»ç”¨</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="maintenanceHistoryTable"></tbody>
            </table>
        </div>
        <div class="chart-container" style="margin-top:20px;"><canvas id="maintenanceChart"></canvas></div>
    </div>

    <div id="expenseHistoryTab" class="tab-content">
        <div class="filter-section">
            <select id="expenseCategoryFilter">
                <option value="">æ‰€æœ‰é¡åˆ¥</option>
                <option value="ä¿éšª">ä¿éšª</option>
                <option value="ç‰Œç…§ç¨…">ç‰Œç…§ç¨…</option>
                <option value="åœè»Šè²»">åœè»Šè²»</option>
                <option value="é…ä»¶">é…ä»¶</option>
                <option value="æ¸…æ½”">æ¸…æ½”</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
            <select id="expenseMonthFilter">
                <option value="">æ‰€æœ‰æœˆä»½</option>
            </select>
        </div>
        <div class="table-container">
            <table class="history-table">
                <thead><tr><th>æ—¥æœŸ</th><th>é¡åˆ¥</th><th>é‡‘é¡</th><th>èªªæ˜</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="expenseHistoryTable"></tbody>
            </table>
        </div>
        <div class="chart-container" style="margin-top:20px;"><canvas id="expenseChart"></canvas></div>
    </div>

    <div id="statisticsTab" class="tab-content">
        <h3>æ•´é«”çµ±è¨ˆ</h3>
        <div class="statistics-grid">
            <div class="stat-card"><h4>ç¸½é‡Œç¨‹</h4><p id="statTotalMileage">0 km</p></div>
            <div class="stat-card"><h4>å¹³å‡æ—¥é‡Œç¨‹</h4><p id="statAvgDaily">0 km</p></div>
            <div class="stat-card"><h4>ç¸½èŠ±è²»</h4><p id="statTotalCost">0 NT$</p></div>
            <div class="stat-card"><h4>æ¯å…¬é‡Œæˆæœ¬</h4><p id="statCostPerKm">0 NT$</p></div>
            <div class="stat-card"><h4>ä¿é¤Šæ¬¡æ•¸</h4><p id="statMaintCount">0</p></div>
            <div class="stat-card"><h4>å……é›»æ¬¡æ•¸</h4><p id="statChargeCount">0</p></div>
        </div>
        <h3>æœˆåº¦èŠ±è²»åˆ†æ</h3>
        <div class="chart-container"><canvas id="monthlyExpenseChart"></canvas></div>
        <h3>èŠ±è²»é¡åˆ¥åˆ†å¸ƒ</h3>
        <div class="chart-container"><canvas id="categoryPieChart"></canvas></div>
    </div>
    
    <div class="data-management-section">
        <h3>è³‡æ–™ç®¡ç†</h3>
        <input type="file" id="jsonImportInput" accept=".json">
        <button id="importBtn">åŒ¯å…¥ JSON</button>
        <button id="exportChargeBtn">åŒ¯å‡ºå……é›» JSON</button>
        <button id="exportMaintBtn">åŒ¯å‡ºä¿é¤Š JSON</button>
        <button id="exportExpenseBtn">åŒ¯å‡ºèŠ±è²» JSON</button>
        <button id="exportAllBtn">åŒ¯å‡ºå…¨éƒ¨è³‡æ–™</button>
        <button id="clearAllBtn" style="color: var(--danger-color); border-color: var(--danger-color);">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
    </div>
</div>

<!-- Edit Charge Modal -->
<div id="editChargeModal" class="modal">
    <div class="modal-content">
        <h3>ç·¨è¼¯å……é›»è¨˜éŒ„</h3>
        <form id="editChargeForm">
            <input type="hidden" id="editingChargeId">
            <div class="input-group"><label for="edit_cStartTime">é–‹å§‹æ™‚é–“:</label><input type="datetime-local" id="edit_cStartTime" required></div>
            <div class="input-group"><label for="edit_cEndTime">çµæŸæ™‚é–“:</label><input type="datetime-local" id="edit_cEndTime" required></div>
            <div class="input-group"><label for="edit_cOdo">ç¸½é‡Œç¨‹ (ODO):</label><input type="number" step="0.1" id="edit_cOdo" required></div>
            <div class="input-group"><label for="edit_cTrip">æœ¬æ¬¡é‡Œç¨‹ (TRIP):</label><input type="number" step="0.1" id="edit_cTrip"></div>
            <div class="input-group"><label for="edit_cStation">å……é›»ç«™:</label><input type="text" id="edit_cStation"></div>
            <div class="input-group"><label for="edit_cBatteryStart">é–‹å§‹é›»é‡ (æ ¼):</label><input type="number" id="edit_cBatteryStart"></div>
            <div class="input-group"><label for="edit_cBatteryEnd">çµæŸé›»é‡ (æ ¼):</label><input type="number" id="edit_cBatteryEnd"></div>
            <div class="input-group"><label for="edit_cKwh">å……é›»åº¦æ•¸ (kWh):</label><input type="number" step="0.01" id="edit_cKwh"></div>
            <div class="input-group"><label for="edit_cCost">å……é›»è²»ç”¨ (NT$):</label><input type="number" id="edit_cCost"></div>
            <div class="input-group"><label for="edit_cNotes">å‚™è¨»:</label><textarea id="edit_cNotes" rows="2"></textarea></div>
            <button type="submit" class="main-btn">å„²å­˜è®Šæ›´</button>
            <button type="button" class="main-btn" id="cancelEditChargeBtn" style="background-color: var(--secondary-color);">å–æ¶ˆ</button>
        </form>
    </div>
</div>


<script>
// --- ä¿é¤Šé€±æœŸè¨­å®š (æ ¹æ“šè»Šä¸»æ‰‹å†Š) ---
const FIRST_SERVICE_KM = 300;       // é¦–æ¬¡ä¿é¤Šé‡Œç¨‹
const FIRST_SERVICE_DAYS = 30;      // é¦–æ¬¡ä¿é¤Šæ™‚é–“ (ç´„1å€‹æœˆ)
const REGULAR_SERVICE_KM = 3000;    // å®šæœŸä¿é¤Šé‡Œç¨‹
const REGULAR_SERVICE_DAYS = 180;   // å®šæœŸä¿é¤Šæ™‚é–“ (ç´„6å€‹æœˆ)

let chargeChartInstance, maintenanceChartInstance, expenseChartInstance, monthlyExpenseChartInstance, categoryPieChartInstance;
let chargeTimerInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    // --- Event Listeners ---
    
    // Forms
    document.getElementById('startChargeForm').addEventListener('submit', startCharging);
    document.getElementById('endChargeForm').addEventListener('submit', endCharging);
    document.getElementById('maintenanceForm').addEventListener('submit', handleMaintenanceSubmit);
    document.getElementById('expenseForm').addEventListener('submit', handleExpenseSubmit);
    document.getElementById('editChargeForm').addEventListener('submit', handleChargeEditSubmit);

    // Tabs
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', (event) => {
            const tabName = button.dataset.tab;
            if (tabName) {
                openTab(event, tabName);
            }
        });
    });

    // Data Management
    document.getElementById('importBtn').addEventListener('click', () => document.getElementById('jsonImportInput').click());
    document.getElementById('jsonImportInput').addEventListener('change', handleJsonImport);
    document.getElementById('exportChargeBtn').addEventListener('click', () => exportData('chargeLog', 'json'));
    document.getElementById('exportMaintBtn').addEventListener('click', () => exportData('maintenanceLog', 'json'));
    document.getElementById('exportExpenseBtn').addEventListener('click', () => exportData('expenseLog', 'json'));
    document.getElementById('exportAllBtn').addEventListener('click', exportAllData);
    document.getElementById('clearAllBtn').addEventListener('click', () => {
        if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—?æ­¤æ“ä½œç„¡æ³•å¾©åŸ!')) {
            clearAllData();
        }
    });

    // Form interactions
    document.getElementById('maintNowBtn').addEventListener('click', () => fillNow('mDate', 'mTime'));
    document.getElementById('expenseNowBtn').addEventListener('click', () => fillNow('eDate', 'eTime'));
    document.getElementById('addPartBtn').addEventListener('click', () => addPartItem());
    document.getElementById('cancelMaintEdit').addEventListener('click', () => cancelEdit('maint'));
    document.getElementById('cancelExpenseEdit').addEventListener('click', () => cancelEdit('expense'));
    document.querySelectorAll('input[name="cStationRadio"]').forEach(radio => {
        radio.addEventListener('change', toggleStationInput);
    });

    // Modal
    document.getElementById('cancelEditChargeBtn').addEventListener('click', closeEditChargeModal);

    // Filters
    document.getElementById('chargeSearch').addEventListener('keyup', (e) => filterTable('chargeHistoryTable', e.target.value));
    document.getElementById('chargeMonthFilter').addEventListener('change', () => filterByMonth('charge'));
    document.getElementById('maintSearch').addEventListener('keyup', (e) => filterTable('maintenanceHistoryTable', e.target.value));
    document.getElementById('maintMonthFilter').addEventListener('change', () => filterByMonth('maint'));
    document.getElementById('maintTypeFilter').addEventListener('change', filterByType);
    document.getElementById('expenseCategoryFilter').addEventListener('change', filterByCategory);
    document.getElementById('expenseMonthFilter').addEventListener('change', () => filterByMonth('expense'));

    // --- Initial Load ---
    document.querySelector('#formTabs .tab-button').click();
    document.querySelector('#historyTabs .tab-button').click();
    loadAllData();
    populateMonthFilters();
});

function loadAllData() {
    updateChargeUI(); // Check for ongoing charge first
    loadMaintenanceHistory();
    loadChargeHistory();
    loadExpenseHistory();
    updateSummary();
    updateAnalytics();
    renderCharts();
}

function openTab(evt, tabName) {
    const parentTabs = evt.currentTarget.parentElement;
    let contentContainer = parentTabs.parentElement;
    contentContainer.querySelectorAll('.tab-content').forEach(tc => {
        if(tc.parentElement === contentContainer) {
            tc.style.display = "none";
        }
    });

    parentTabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove("active"));
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.classList.add("active");
}

function formatDateTime(isoString) {
    if (!isoString) return '';
    return new Date(isoString).toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }).replace(/\//g, '-');
}

function toggleStationInput() {
    const isOther = document.getElementById('station_other').checked;
    const input = document.getElementById('cStation');
    input.style.display = isOther ? 'block' : 'none';
    if (!isOther) {
        input.value = '';
    }
}

function fillNow(dateId, timeId) {
    const now = new Date();
    const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString();
    document.getElementById(dateId).value = localDate.slice(0, 10);
    if(timeId) document.getElementById(timeId).value = localDate.slice(11, 16);
}

function addPartItem(name = '', cost = '') {
    const partsList = document.getElementById('partsList');
    const newItem = document.createElement('div');
    newItem.className = 'part-item';
    newItem.innerHTML = `
        <input type="text" class="part-name" placeholder="é …ç›®/é›¶ä»¶åç¨±" value="${name}" oninput="updateTotalCost()">
        <input type="number" class="part-cost" placeholder="è²»ç”¨" value="${cost}" oninput="updateTotalCost()">
        <button type="button" class="remove-part-btn" onclick="this.parentElement.remove(); updateTotalCost();">X</button>
    `;
    partsList.appendChild(newItem);
    updateTotalCost();
}

function updateTotalCost() {
    let total = 0;
    document.querySelectorAll('#partsList .part-cost').forEach(input => {
        total += parseFloat(input.value) || 0;
    });
    document.getElementById('totalCost').textContent = total;
}

// --- Charging Flow ---
function startCharging(e) {
    e.preventDefault();
    const stationType = document.querySelector('input[name="cStationRadio"]:checked').value;
    let stationValue = stationType;
    if (stationType === 'å…¶ä»–') {
        stationValue = document.getElementById('cStation').value;
    }

    const session = {
        id: Date.now(),
        startTime: new Date().toISOString(),
        odo: parseFloat(document.getElementById('cOdo').value),
        batteryStart: parseInt(document.querySelector('input[name="cBatteryStart"]:checked').value),
        station: stationValue,
        stationType: stationType,
        trip: parseFloat(document.getElementById('cTrip').value) || 0,
        notes: document.getElementById('cNotes').value
    };

    localStorage.setItem('currentChargingSession', JSON.stringify(session));
    document.getElementById('startChargeForm').reset();
    toggleStationInput();
    updateChargeUI();
}

function endCharging(e) {
    e.preventDefault();
    if (chargeTimerInterval) {
        clearInterval(chargeTimerInterval);
        chargeTimerInterval = null;
    }
    
    const session = JSON.parse(localStorage.getItem('currentChargingSession'));
    if (!session) return;

    const endTime = new Date();
    const startTime = new Date(session.startTime);
    let diff = endTime - startTime;
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const duration = `${hours}å°æ™‚ ${minutes}åˆ†`;

    const record = {
        ...session,
        endTime: endTime.toISOString(),
        date: session.startTime.slice(0, 10),
        duration: duration,
        batteryEnd: parseInt(document.querySelector('input[name="cBatteryEnd"]:checked').value),
        kwh: parseFloat(document.getElementById('cKwh').value) || 0,
        cost: parseFloat(document.getElementById('cCost').value) || 0,
        range: document.getElementById('cRange').value,
    };

    saveData('chargeLog', record);
    localStorage.removeItem('currentChargingSession');
    document.getElementById('endChargeForm').reset();
    alert('å……é›»è¨˜éŒ„å·²å„²å­˜!');
    loadAllData();
}

function updateChargeUI() {
    const session = JSON.parse(localStorage.getItem('currentChargingSession'));
    const startSection = document.getElementById('startChargeSection');
    const endSection = document.getElementById('endChargeSection');

    if (chargeTimerInterval) {
        clearInterval(chargeTimerInterval);
        chargeTimerInterval = null;
    }

    if (session) {
        startSection.style.display = 'none';
        endSection.style.display = 'block';
        document.getElementById('currentChargeInfo').innerHTML = `
            <p><strong>é–‹å§‹æ™‚é–“:</strong> ${formatDateTime(session.startTime)}</p>
            <p><strong>é–‹å§‹é‡Œç¨‹:</strong> ${session.odo} km</p>
            <p><strong>é–‹å§‹é›»é‡:</strong> ${session.batteryStart} æ ¼</p>
            <p><strong>å……é›»ç«™:</strong> ${session.station}</p>
            <p><strong>å·²å……é›»æ™‚é•·:</strong> <span id="chargeDurationTimer">è¨ˆç®—ä¸­...</span></p>
        `;
        
        const kwhGroup = document.getElementById('kwh-input-group');
        const costGroup = document.getElementById('cost-input-group');
        const kwhInput = document.getElementById('cKwh');
        const costInput = document.getElementById('cCost');

        kwhInput.value = '';
        costInput.value = '';
        
        kwhInput.required = false; 

        switch (session.stationType) {
            case 'å…¬å¸':
                kwhGroup.style.display = 'block';
                costGroup.style.display = 'none';
                costInput.required = false;
                break;
            case 'å……é›»ç«™':
                kwhGroup.style.display = 'none';
                costGroup.style.display = 'block';
                costInput.required = true;
                break;
            default: // 'å…¶ä»–'
                kwhGroup.style.display = 'block';
                costGroup.style.display = 'block';
                costInput.required = false; 
                break;
        }

        const startTime = new Date(session.startTime);
        const timerElement = document.getElementById('chargeDurationTimer');

        chargeTimerInterval = setInterval(() => {
            const now = new Date();
            const diff = now - startTime;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);

            const formattedTime = [
                hours.toString().padStart(2, '0'),
                minutes.toString().padStart(2, '0'),
                seconds.toString().padStart(2, '0')
            ].join(':');
            
            if(timerElement) {
                timerElement.textContent = formattedTime;
            }
        }, 1000);

    } else {
        startSection.style.display = 'block';
        endSection.style.display = 'none';
    }
}

function handleChargeEditSubmit(e) {
    e.preventDefault();
    const editingId = parseInt(document.getElementById('editingChargeId').value);
    
    const endTime = new Date(document.getElementById('edit_cEndTime').value);
    const startTime = new Date(document.getElementById('edit_cStartTime').value);
    let diff = endTime - startTime;
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const duration = `${hours}å°æ™‚ ${minutes}åˆ†`;

    const record = {
        id: editingId,
        startTime: startTime.toISOString(),
        endTime: endTime.toISOString(),
        date: startTime.toISOString().slice(0, 10),
        duration: duration,
        odo: parseFloat(document.getElementById('edit_cOdo').value),
        trip: parseFloat(document.getElementById('edit_cTrip').value),
        station: document.getElementById('edit_cStation').value,
        batteryStart: parseInt(document.getElementById('edit_cBatteryStart').value),
        batteryEnd: parseInt(document.getElementById('edit_cBatteryEnd').value),
        kwh: parseFloat(document.getElementById('edit_cKwh').value),
        cost: parseFloat(document.getElementById('edit_cCost').value),
        notes: document.getElementById('edit_cNotes').value,
        range: 0 // Retain schema consistency
    };
    
    saveData('chargeLog', record, true);
    closeEditChargeModal();
    alert('å……é›»è¨˜éŒ„å·²æ›´æ–°!');
    loadAllData();
}

function closeEditChargeModal() {
    document.getElementById('editChargeModal').style.display = 'none';
}

function handleMaintenanceSubmit(e) {
    e.preventDefault();
    const editingId = document.getElementById('editingMaintId').value;
    const parts = [];
    document.querySelectorAll('#partsList .part-item').forEach(item => {
        parts.push({
            name: item.querySelector('.part-name').value,
            cost: parseFloat(item.querySelector('.part-cost').value) || 0
        });
    });
    const record = {
        id: editingId ? parseInt(editingId) : Date.now(),
        date: document.getElementById('mDate').value,
        time: document.getElementById('mTime').value,
        odo: parseFloat(document.getElementById('mOdo').value),
        location: document.getElementById('mLocation').value,
        type: document.getElementById('mType').value,
        notes: document.getElementById('mNotes').value,
        parts: parts,
        totalCost: parseFloat(document.getElementById('totalCost').textContent)
    };
    saveData('maintenanceLog', record, !!editingId);
    cancelEdit('maint');
    alert('ä¿é¤Šè¨˜éŒ„å·²å„²å­˜!');
    loadAllData();
}

function handleExpenseSubmit(e) {
    e.preventDefault();
    const editingId = document.getElementById('editingExpenseId').value;
    const record = {
        id: editingId ? parseInt(editingId) : Date.now(),
        date: document.getElementById('eDate').value,
        time: document.getElementById('eTime').value,
        odo: parseFloat(document.getElementById('eOdo').value) || 0,
        category: document.getElementById('eCategory').value,
        amount: parseFloat(document.getElementById('eAmount').value),
        description: document.getElementById('eDescription').value
    };
    saveData('expenseLog', record, !!editingId);
    cancelEdit('expense');
    alert('èŠ±è²»è¨˜éŒ„å·²å„²å­˜!');
    loadAllData();
}

function saveData(key, newRecord, isEdit = false) {
    let data = JSON.parse(localStorage.getItem(key)) || [];
    if (isEdit) {
        const index = data.findIndex(item => item.id === newRecord.id);
        if (index > -1) data[index] = newRecord;
    } else {
        data.push(newRecord);
    }
    data.sort((a, b) => new Date(b.date + 'T' + (b.time || b.startTime || '00:00')) - new Date(a.date + 'T' + (a.time || a.startTime || '00:00')));
    localStorage.setItem(key, JSON.stringify(data));
}

function editRecord(key, id) {
    const data = JSON.parse(localStorage.getItem(key)) || [];
    const record = data.find(item => item.id === id);
    if (!record) return;

    if (key === 'chargeLog') {
        document.getElementById('editingChargeId').value = record.id;
        
        const toLocalISO = (iso) => {
            if (!iso) return '';
            const d = new Date(iso);
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            return d.toISOString().slice(0, 16);
        };
        
        document.getElementById('edit_cStartTime').value = toLocalISO(record.startTime);
        document.getElementById('edit_cEndTime').value = toLocalISO(record.endTime);
        document.getElementById('edit_cOdo').value = record.odo;
        document.getElementById('edit_cTrip').value = record.trip;
        document.getElementById('edit_cStation').value = record.station;
        document.getElementById('edit_cBatteryStart').value = record.batteryStart;
        document.getElementById('edit_cBatteryEnd').value = record.batteryEnd;
        document.getElementById('edit_cKwh').value = record.kwh;
        document.getElementById('edit_cCost').value = record.cost;
        document.getElementById('edit_cNotes').value = record.notes || '';

        document.getElementById('editChargeModal').style.display = 'block';

    } else if (key === 'maintenanceLog') {
        document.getElementById('editingMaintId').value = record.id;
        document.getElementById('mDate').value = record.date;
        document.getElementById('mTime').value = record.time;
        document.getElementById('mOdo').value = record.odo;
        document.getElementById('mLocation').value = record.location || '';
        document.getElementById('mType').value = record.type || 'å®šæœŸä¿é¤Š';
        document.getElementById('mNotes').value = record.notes || '';
        document.getElementById('partsList').innerHTML = '';
        if (record.parts) record.parts.forEach(p => addPartItem(p.name, p.cost));
        updateTotalCost();
        document.getElementById('maintFormTitle').textContent = 'ç·¨è¼¯ä¿é¤Šè¨˜éŒ„';
        document.getElementById('cancelMaintEdit').style.display = 'block';
        document.querySelector('#formTabs button[data-tab="maintenanceFormTab"]').click();
        window.scrollTo(0, 0);
    } else if (key === 'expenseLog') {
        document.getElementById('editingExpenseId').value = record.id;
        document.getElementById('eDate').value = record.date;
        document.getElementById('eTime').value = record.time;
        document.getElementById('eOdo').value = record.odo || '';
        document.getElementById('eCategory').value = record.category;
        document.getElementById('eAmount').value = record.amount;
        document.getElementById('eDescription').value = record.description || '';
        document.getElementById('expenseFormTitle').textContent = 'ç·¨è¼¯èŠ±è²»è¨˜éŒ„';
        document.getElementById('cancelExpenseEdit').style.display = 'block';
        document.querySelector('#formTabs button[data-tab="expenseFormTab"]').click();
        window.scrollTo(0, 0);
    }
}

function deleteRecord(key, id) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—?æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
    let data = JSON.parse(localStorage.getItem(key)) || [];
    data = data.filter(item => item.id !== id);
    localStorage.setItem(key, JSON.stringify(data));
    loadAllData();
}

function cancelEdit(type) {
    if (type === 'maint') {
        document.getElementById('maintenanceForm').reset();
        document.getElementById('editingMaintId').value = '';
        document.getElementById('partsList').innerHTML = '';
        updateTotalCost();
        document.getElementById('maintFormTitle').textContent = 'è¨˜éŒ„ä¿é¤Š';
        document.getElementById('cancelMaintEdit').style.display = 'none';
    } else if (type === 'expense') {
        document.getElementById('expenseForm').reset();
        document.getElementById('editingExpenseId').value = '';
        document.getElementById('expenseFormTitle').textContent = 'è¨˜éŒ„å…¶ä»–èŠ±è²»';
        document.getElementById('cancelExpenseEdit').style.display = 'none';
    }
}

function calculateEfficiencies(data) {
    const chronologicalData = [...data].sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
    const efficiencyMap = {};

    for (let i = 1; i < chronologicalData.length; i++) {
        const currentRecord = chronologicalData[i];
        const prevRecord = chronologicalData[i - 1];

        const mileage = currentRecord.odo - prevRecord.odo;
        const kwh = currentRecord.kwh;

        if (mileage > 0 && kwh > 0) {
            efficiencyMap[currentRecord.id] = (mileage / kwh).toFixed(2);
        }
    }
    return efficiencyMap;
}

function loadChargeHistory() {
    const data = JSON.parse(localStorage.getItem('chargeLog')) || [];
    const tableBody = document.getElementById('chargeHistoryTable');
    tableBody.innerHTML = '';
    
    const sortedData = [...data].sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
    const efficiencyMap = calculateEfficiencies(data);

    sortedData.forEach(record => {
        const row = tableBody.insertRow();
        const efficiency = efficiencyMap[record.id] || 'N/A';
        const period = `${formatDateTime(record.startTime)}<br>~ ${formatDateTime(record.endTime)}`;

        row.innerHTML = `
            <td>${period}</td>
            <td>${record.station}</td>
            <td>${record.trip || '-'}</td>
            <td>${record.cost || '-'}</td>
            <td>${efficiency}</td>
            <td>${record.batteryStart || '?'}â†’${record.batteryEnd || '?'}æ ¼</td>
            <td>${record.duration || '-'}</td>
            <td class="action-buttons">
                <button class="edit-btn" onclick="editRecord('chargeLog', ${record.id})">ç·¨è¼¯</button>
                <button class="delete-btn" onclick="deleteRecord('chargeLog', ${record.id})">åˆªé™¤</button>
            </td>`;
    });
}


function loadMaintenanceHistory() {
    const data = JSON.parse(localStorage.getItem('maintenanceLog')) || [];
    const tableBody = document.getElementById('maintenanceHistoryTable');
    tableBody.innerHTML = '';
    
    const sortedData = [...data].sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));

    sortedData.forEach(record => {
        const row = tableBody.insertRow();
        let itemsDesc = record.parts && record.parts.length > 0 ? record.parts.map(p => p.name).join(', ') : record.notes;
        if (itemsDesc && itemsDesc.length > 30) itemsDesc = itemsDesc.substring(0, 30) + '...';
        row.innerHTML = `
            <td>${record.date.slice(5)}</td>
            <td>${record.odo}</td>
            <td>${record.type || '-'}</td>
            <td>${itemsDesc || '-'}</td>
            <td>${record.totalCost}</td>
            <td class="action-buttons">
                <button class="edit-btn" onclick="editRecord('maintenanceLog', ${record.id})">ç·¨è¼¯</button>
                <button class="delete-btn" onclick="deleteRecord('maintenanceLog', ${record.id})">åˆªé™¤</button>
            </td>`;
    });
}

function loadExpenseHistory() {
    const data = JSON.parse(localStorage.getItem('expenseLog')) || [];
    const tableBody = document.getElementById('expenseHistoryTable');
    tableBody.innerHTML = '';
    
    const sortedData = [...data].sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));

    sortedData.forEach(record => {
        const row = tableBody.insertRow();
        row.innerHTML = `
            <td>${record.date.slice(5)}</td>
            <td>${record.category}</td>
            <td>${record.amount}</td>
            <td>${record.description || '-'}</td>
            <td class="action-buttons">
                <button class="edit-btn" onclick="editRecord('expenseLog', ${record.id})">ç·¨è¼¯</button>
                <button class="delete-btn" onclick="deleteRecord('expenseLog', ${record.id})">åˆªé™¤</button>
            </td>`;
    });
}

function daysBetween(date1, date2) {
    if (!date1 || !date2) return 0;
    return Math.round(Math.abs((new Date(date1) - new Date(date2)) / (24 * 60 * 60 * 1000)));
}

function updateSummary() {
    const maintData = JSON.parse(localStorage.getItem('maintenanceLog')) || [];
    const chargeData = JSON.parse(localStorage.getItem('chargeLog')) || [];
    const expenseData = JSON.parse(localStorage.getItem('expenseLog')) || [];
    const today = new Date().toISOString().slice(0, 10);

    // --- ç¸½é‡Œç¨‹ & ç¸½èŠ±è²» ---
    let totalMileage = 0;
    const allOdoData = [...chargeData, ...maintData, ...expenseData].filter(d => d.odo > 0);
    if(allOdoData.length > 0) {
        totalMileage = Math.max(...allOdoData.map(d => d.odo));
    }
    document.getElementById('totalMileage').textContent = totalMileage;

    let totalExpense = 0;
    maintData.forEach(m => totalExpense += m.totalCost || 0);
    chargeData.forEach(c => totalExpense += c.cost || 0);
    expenseData.forEach(e => totalExpense += e.amount || 0);
    document.getElementById('totalExpense').textContent = totalExpense.toFixed(0);
    
    // --- ä¸‹æ¬¡ä¿é¤Šé ä¼° (æ–°é‚è¼¯) ---
    const maintDataSorted = [...maintData].sort((a,b) => new Date(a.date) - new Date(b.date));
    const currentOdo = totalMileage;

    if (maintData.length === 0) {
        // é¦–æ¬¡ä¿é¤Šé‚è¼¯ (300km / 1å€‹æœˆ)
        const allData = [...chargeData, ...expenseData];
        if (allData.length === 0) {
            document.getElementById('nextService').textContent = `é¦–æ¬¡ä¿é¤Š: 300 km æˆ– 1 å€‹æœˆ`;
            document.getElementById('nextService').style.color = 'inherit';
        } else {
            const firstRecord = allData.sort((a,b) => new Date(a.date || a.startTime) - new Date(b.date || b.startTime))[0];
            const firstRecordDate = firstRecord.date || firstRecord.startTime.slice(0,10);
            const daysSinceFirstRecord = daysBetween(firstRecordDate, today);
            
            const kmLeft = FIRST_SERVICE_KM - currentOdo;
            const daysLeft = FIRST_SERVICE_DAYS - daysSinceFirstRecord;

            if (kmLeft <= 0 || daysLeft <= 0) {
                document.getElementById('nextService').textContent = `å·²è¶…éé¦–æ¬¡ä¿é¤Šé‡Œç¨‹/æ™‚é–“`;
                document.getElementById('nextService').style.color = 'var(--danger-color)';
            } else {
                document.getElementById('nextService').textContent = `é¦–æ¬¡ä¿é¤Š: ç´„ ${kmLeft.toFixed(0)} km æˆ– ${daysLeft} å¤©å¾Œ`;
                document.getElementById('nextService').style.color = 'var(--success-color)';
            }
        }
        document.getElementById('lastMaintenance').textContent = `å°šæœªè¨˜éŒ„`;
        document.getElementById('lastMaintOdo').textContent = `N/A`;

    } else { // maintData.length >= 1
        // å®šæœŸä¿é¤Šé‚è¼¯ (æ¯ 3000km / 6å€‹æœˆ from last)
        const last = maintDataSorted[maintDataSorted.length - 1];
        const daysAgo = daysBetween(last.date, today);
        document.getElementById('lastMaintenance').textContent = `${last.date} (${daysAgo}å¤©å‰)`;
        document.getElementById('lastMaintOdo').textContent = `${last.odo} km`;

        const kmSince = currentOdo - last.odo;
        const kmLeft = REGULAR_SERVICE_KM - kmSince;
        const daysLeft = REGULAR_SERVICE_DAYS - daysAgo;

        if (kmLeft <= 0 || daysLeft <= 0) {
            document.getElementById('nextService').textContent = `å·²è¶…éå®šæœŸä¿é¤Šé‡Œç¨‹/æ™‚é–“`;
            document.getElementById('nextService').style.color = 'var(--danger-color)';
        } else {
            document.getElementById('nextService').textContent = `ä¸‹æ¬¡å®šæœŸä¿é¤Š: ç´„ ${kmLeft.toFixed(0)} km æˆ– ${daysLeft} å¤©å¾Œ`;
            document.getElementById('nextService').style.color = 'var(--success-color)';
        }
    }

    // --- ä¸Šæ¬¡å……é›» ---
    if (chargeData.length > 0) {
        const last = [...chargeData].sort((a,b) => new Date(a.startTime) - new Date(b.startTime)).pop();
        const daysAgo = daysBetween(last.date, today);
        document.getElementById('lastCharge').textContent = `${last.date} (${daysAgo}å¤©å‰)`;
        document.getElementById('lastChargeOdo').textContent = `${last.odo} km`;
    }

    // --- çµ±è¨ˆé é¢ ---
    document.getElementById('statTotalMileage').textContent = `${totalMileage} km`;
    document.getElementById('statTotalCost').textContent = `${totalExpense.toFixed(0)} NT$`;
    document.getElementById('statMaintCount').textContent = maintData.length;
    document.getElementById('statChargeCount').textContent = chargeData.length;
    
    if (totalMileage > 0) {
        document.getElementById('statCostPerKm').textContent = `${(totalExpense / totalMileage).toFixed(2)} NT$`;
    } else {
        document.getElementById('statCostPerKm').textContent = `0 NT$`;
    }
    
    const allRecordsWithDate = [...chargeData, ...maintData, ...expenseData].filter(d => d.date);
    if (allRecordsWithDate.length > 1) {
        const firstDate = new Date(allRecordsWithDate.sort((a,b) => new Date(a.date) - new Date(b.date))[0].date);
        const lastDate = new Date();
        const days = daysBetween(firstDate, lastDate) || 1;
        const avgDaily = totalMileage / days;
        document.getElementById('statAvgDaily').textContent = `${avgDaily.toFixed(1)} km`;
    } else {
        document.getElementById('statAvgDaily').textContent = `0 km`;
    }
}


function updateAnalytics() {
    const data = JSON.parse(localStorage.getItem('chargeLog')) || [];
    document.getElementById('totalCharges').textContent = data.length;
    
    const efficiencyMap = calculateEfficiencies(data);
    const efficiencies = Object.values(efficiencyMap).map(v => parseFloat(v));

    if (efficiencies.length > 0) {
        const total = efficiencies.reduce((a, b) => a + b, 0);
        document.getElementById('avgEfficiency').textContent = `${(total / efficiencies.length).toFixed(2)} km/kWh`;
        document.getElementById('bestEfficiency').textContent = `${Math.max(...efficiencies).toFixed(2)} km/kWh`;
        document.getElementById('worstEfficiency').textContent = `${Math.min(...efficiencies).toFixed(2)} km/kWh`;
    } else {
        document.getElementById('avgEfficiency').textContent = 'N/A';
        document.getElementById('bestEfficiency').textContent = 'N/A';
        document.getElementById('worstEfficiency').textContent = 'N/A';
    }
}


function populateMonthFilters() {
    const allData = [
        ...JSON.parse(localStorage.getItem('chargeLog') || '[]'),
        ...JSON.parse(localStorage.getItem('maintenanceLog') || '[]'),
        ...JSON.parse(localStorage.getItem('expenseLog') || '[]')
    ];
    
    const months = new Set();
    allData.forEach(record => {
        if (record.date) months.add(record.date.slice(0, 7));
    });
    
    const sortedMonths = Array.from(months).sort().reverse();
    
    ['chargeMonthFilter', 'maintMonthFilter', 'expenseMonthFilter'].forEach(filterId => {
        const select = document.getElementById(filterId);
        select.innerHTML = '<option value="">æ‰€æœ‰æœˆä»½</option>';
        sortedMonths.forEach(month => {
            const option = document.createElement('option');
            option.value = month;
            option.textContent = month;
            select.appendChild(option);
        });
    });
}

function filterTable(tableId, searchText) {
    const table = document.getElementById(tableId);
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchText.toLowerCase()) ? '' : 'none';
    }
}

function filterByMonth(type) {
    const tableIdMap = {
        charge: 'chargeHistoryTable',
        maint: 'maintenanceHistoryTable',
        expense: 'expenseHistoryTable'
    };
    
    const filterId = `${type}MonthFilter`;
    const selectedMonth = document.getElementById(filterId).value;
    const tableBody = document.getElementById(tableIdMap[type]);

    for (let i = 0; i < tableBody.rows.length; i++) {
        const row = tableBody.rows[i];
        const dateCellText = row.cells[0].textContent; 
        row.style.display = (!selectedMonth || dateCellText.includes(selectedMonth)) ? '' : 'none';
    }
}


function filterByType() {
    const selectedType = document.getElementById('maintTypeFilter').value;
    const tableBody = document.getElementById('maintenanceHistoryTable');
    const rows = tableBody.querySelectorAll('tr');
    rows.forEach(row => {
        const type = row.cells[2].textContent;
        if (!selectedType || type === selectedType) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function filterByCategory() {
    const selectedCategory = document.getElementById('expenseCategoryFilter').value;
    const tableBody = document.getElementById('expenseHistoryTable');
    const rows = tableBody.querySelectorAll('tr');
    rows.forEach(row => {
        const category = row.cells[1].textContent;
        if (!selectedCategory || category === selectedCategory) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function handleJsonImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            if (importedData.type === 'all') {
                if (!confirm('ç¢ºå®šè¦åŒ¯å…¥å®Œæ•´è³‡æ–™å—?é€™å°‡æœƒè¦†è“‹ç¾æœ‰çš„æ‰€æœ‰è¨˜éŒ„ã€‚')) return;
                if (importedData.chargeLog) localStorage.setItem('chargeLog', JSON.stringify(importedData.chargeLog));
                if (importedData.maintenanceLog) localStorage.setItem('maintenanceLog', JSON.stringify(importedData.maintenanceLog));
                if (importedData.expenseLog) localStorage.setItem('expenseLog', JSON.stringify(importedData.expenseLog));
                alert('å®Œæ•´è³‡æ–™åŒ¯å…¥æˆåŠŸ!');
            } else if (importedData.type && Array.isArray(importedData.data)) {
                if (!confirm('ç¢ºå®šè¦åŒ¯å…¥è³‡æ–™å—?é€™å°‡æœƒè¦†è“‹ç¾æœ‰çš„åŒé¡å‹è¨˜éŒ„ã€‚')) return;
                localStorage.setItem(importedData.type, JSON.stringify(importedData.data));
                alert('è³‡æ–™åŒ¯å…¥æˆåŠŸ!');
            } else {
                alert('JSON æª”æ¡ˆæ ¼å¼ä¸ç¬¦!');
                return;
            }
            
            loadAllData();
            populateMonthFilters();
        } catch (error) {
            alert('è®€å–æª”æ¡ˆå¤±æ•—,è«‹ç¢ºèªæ˜¯å¦ç‚ºæ­£ç¢ºçš„ JSON æª”æ¡ˆã€‚');
        } finally {
            event.target.value = '';
        }
    };
    reader.readAsText(file);
}

function exportData(key, format) {
    const data = JSON.parse(localStorage.getItem(key) || '[]');
    if (data.length === 0) {
        alert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º!');
        return;
    }
    const dataToExport = {
        type: key,
        version: '2.1',
        exportDate: new Date().toISOString(),
        data: data
    };
    const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${key}_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function exportAllData() {
    const allData = {
        type: 'all',
        version: '2.1',
        exportDate: new Date().toISOString(),
        chargeLog: JSON.parse(localStorage.getItem('chargeLog') || '[]'),
        maintenanceLog: JSON.parse(localStorage.getItem('maintenanceLog') || '[]'),
        expenseLog: JSON.parse(localStorage.getItem('expenseLog') || '[]')
    };
    
    const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `motorcycle_all_data_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function clearAllData() {
    localStorage.clear();
    loadAllData();
    alert('æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤!');
}

function renderCharts() {
    const maintData = JSON.parse(localStorage.getItem('maintenanceLog')) || [];
    const chargeData = JSON.parse(localStorage.getItem('chargeLog')) || [];
    const expenseData = JSON.parse(localStorage.getItem('expenseLog')) || [];

    if (maintenanceChartInstance) maintenanceChartInstance.destroy();
    if (maintData.length > 0) {
        const ctx = document.getElementById('maintenanceChart').getContext('2d');
        maintenanceChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: maintData.map(d => `${d.date.slice(5)}`).reverse(),
                datasets: [{
                    label: 'ä¿é¤Šè²»ç”¨ (NT$)',
                    data: [...maintData].map(d => d.totalCost).reverse(),
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.1
                }]
            },
            options: { responsive: true, plugins: { legend: { display: true }}}
        });
    }

    if (chargeChartInstance) chargeChartInstance.destroy();
    if (chargeData.length > 1) {
        const efficiencyMap = calculateEfficiencies(chargeData);
        const efficiencies = Object.entries(efficiencyMap).map(([id, value]) => ({
            id: parseInt(id),
            value: parseFloat(value)
        }));
        
        // Ensure chart data is also in chronological order
        const chronologicalData = [...chargeData].sort((a,b) => new Date(a.startTime) - new Date(b.startTime));
        const chartData = chronologicalData
            .map(record => {
                const efficiency = efficiencies.find(e => e.id === record.id);
                return efficiency ? { label: record.date.slice(5), value: efficiency.value } : null;
            })
            .filter(item => item !== null);

        const ctx = document.getElementById('chargeChart').getContext('2d');
        chargeChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.map(d => d.label),
                datasets: [{
                    label: 'æ•ˆç‡ (km/kWh)',
                    data: chartData.map(d => d.value),
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, plugins: { legend: { display: true }}}
        });
    }

    if (expenseChartInstance) expenseChartInstance.destroy();
    if (expenseData.length > 0) {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        expenseChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: expenseData.map(d => `${d.date.slice(5)}`).reverse(),
                datasets: [{
                    label: 'èŠ±è²»é‡‘é¡ (NT$)',
                    data: [...expenseData].map(d => d.amount).reverse(),
                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, plugins: { legend: { display: true }}}
        });
    }

    renderMonthlyExpenseChart();
    renderCategoryPieChart();
}

function renderMonthlyExpenseChart() {
    const maintData = JSON.parse(localStorage.getItem('maintenanceLog')) || [];
    const chargeData = JSON.parse(localStorage.getItem('chargeLog')) || [];
    const expenseData = JSON.parse(localStorage.getItem('expenseLog')) || [];
    
    const monthlyData = {};
    
    maintData.forEach(m => {
        const month = m.date.slice(0, 7);
        monthlyData[month] = (monthlyData[month] || 0) + (m.totalCost || 0);
    });
    
    chargeData.forEach(c => {
        const month = c.date.slice(0, 7);
        monthlyData[month] = (monthlyData[month] || 0) + (c.cost || 0);
    });
    
    expenseData.forEach(e => {
        const month = e.date.slice(0, 7);
        monthlyData[month] = (monthlyData[month] || 0) + (e.amount || 0);
    });
    
    const sortedMonths = Object.keys(monthlyData).sort();
    
    if (monthlyExpenseChartInstance) monthlyExpenseChartInstance.destroy();
    if (sortedMonths.length > 0) {
        const ctx = document.getElementById('monthlyExpenseChart').getContext('2d');
        monthlyExpenseChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedMonths,
                datasets: [{
                    label: 'æœˆåº¦ç¸½èŠ±è²» (NT$)',
                    data: sortedMonths.map(m => monthlyData[m]),
                    borderColor: 'rgb(153, 102, 255)',
                    backgroundColor: 'rgba(153, 102, 255, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: { responsive: true, plugins: { legend: { display: true }}}
        });
    }
}

function renderCategoryPieChart() {
    const maintData = JSON.parse(localStorage.getItem('maintenanceLog')) || [];
    const chargeData = JSON.parse(localStorage.getItem('chargeLog')) || [];
    const expenseData = JSON.parse(localStorage.getItem('expenseLog') || '[]');
    
    const categoryData = { 'ä¿é¤Š': 0, 'å……é›»': 0 };
    
    maintData.forEach(m => categoryData['ä¿é¤Š'] += m.totalCost || 0);
    chargeData.forEach(c => categoryData['å……é›»'] += c.cost || 0);
    expenseData.forEach(e => {
        categoryData[e.category] = (categoryData[e.category] || 0) + e.amount;
    });
    
    const categories = Object.keys(categoryData).filter(k => categoryData[k] > 0);
    const values = categories.map(k => categoryData[k]);
    
    if (categoryPieChartInstance) categoryPieChartInstance.destroy();
    if (categories.length > 0) {
        const ctx = document.getElementById('categoryPieChart').getContext('2d');
        categoryPieChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: categories,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 159, 64, 0.8)',
                        'rgba(199, 199, 199, 0.8)'
                    ]
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' }}}
        });
    }
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>摩托車輛資訊記錄</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d; --light-bg: #f8f9fa;
            --border-color: #dee2e6; --text-color: #343a40; --white: #fff;
            --danger-color: #dc3545; --success-color: #28a745; --warning-color: #ffc107;
            --info-bg: #e2f3ff; --info-border: #b8e2fc;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 15px; background-color: var(--light-bg); color: var(--text-color);
        }
        .container {
            max-width: 800px; margin: 0 auto; background-color: var(--white);
            padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1, h2, h3 { color: var(--primary-color); text-align: center; }
        .summary {
            background-color: #e7f3ff; padding: 15px; border-radius: 8px;
            margin-bottom: 25px; border-left: 5px solid var(--primary-color);
        }
        .summary p { margin: 8px 0; font-size: 1em; }
        .summary span { font-weight: bold; color: #004085; }
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; flex-wrap: wrap; }
        .tab-button {
            padding: 10px 15px; cursor: pointer; border: none; background-color: transparent;
            font-size: 1.1em; margin-bottom: -2px; border-bottom: 3px solid transparent;
        }
        .tab-button.active { font-weight: bold; color: var(--primary-color); border-bottom: 3px solid var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-section { padding: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group small { color: var(--secondary-color); font-size: 0.8em; }
        input, textarea, select {
            width: 100%; padding: 10px; border: 1px solid var(--border-color);
            border-radius: 4px; box-sizing: border-box;
        }
        .now-btn {
            position: absolute; right: 5px; top: 28px; padding: 5px 8px;
            background-color: var(--secondary-color); color: var(--white); border: none;
            border-radius: 4px; cursor: pointer; font-size: 0.8em;
        }
        .main-btn {
            width: 100%; padding: 12px; background-color: var(--primary-color); color: var(--white);
            border: none; border-radius: 4px; cursor: pointer; font-size: 1.1em; margin-top: 10px;
        }
        .main-btn:hover { background-color: #0056b3; }
        #partsList .part-item { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; }
        #partsList .part-item input { margin-bottom: 0; }
        .remove-part-btn { padding: 8px 12px; background-color: var(--danger-color); color: var(--white); border: none; border-radius: 4px; cursor: pointer; }
        .add-part-btn { margin-top: 10px; background-color: var(--success-color); }
        .analytics-section {
            display: flex; flex-wrap: wrap; justify-content: space-around; background-color: var(--light-bg);
            padding: 15px; border-radius: 5px; margin: 20px 0; text-align: center; gap: 10px;
        }
        .analytics-item h4 { margin: 0 0 5px 0; color: var(--secondary-color); font-size: 0.9em; }
        .analytics-item p { margin: 0; font-size: 1.2em; font-weight: bold; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .history-table th, .history-table td { border: 1px solid var(--border-color); padding: 8px; text-align: left; vertical-align: middle;}
        .history-table th { background-color: var(--light-bg); }
        .table-container { overflow-x: auto; }
        .action-buttons button { font-size: 0.8em; padding: 4px 8px; margin-right: 5px; border-radius: 4px; cursor: pointer; border: none; color: white;}
        .edit-btn { background-color: var(--warning-color); }
        .delete-btn { background-color: var(--danger-color); }
        .data-management-section { margin-top: 30px; padding: 15px; border: 1px dashed var(--secondary-color); border-radius: 5px; }
        .data-management-section button {
            padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-right: 10px; margin-bottom: 10px;
            border: 1px solid var(--primary-color); background-color: var(--white); color: var(--primary-color);
        }
        .data-management-section button:hover { background-color: #e7f3ff; }
        #jsonImportInput { display: none; }
        .cancel-edit-btn { background-color: var(--secondary-color); display: none; }
        .filter-section { background-color: var(--light-bg); padding: 15px; border-radius: 5px; margin-bottom: 15px; }
        .radio-group label { margin-bottom: 0; font-weight: normal; }
        .radio-group input[type="radio"] { width: auto; margin-right: 5px; }
        .radio-group-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; text-align: center; }
        .radio-group-grid label { margin-bottom: 0; font-weight: normal; display: block; cursor: pointer; padding: 5px; border-radius: 4px; border: 1px solid var(--border-color); }
        .radio-group-grid input[type="radio"] { display: none; }
        .radio-group-grid input[type="radio"]:checked + label { background-color: var(--primary-color); color: var(--white); border-color: var(--primary-color); }
        .current-charge-info {
            background-color: var(--info-bg);
            border: 1px solid var(--info-border);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .current-charge-info p { margin: 5px 0; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <h1>🏍️ 摩托車輛資訊記錄</h1>

    <div class="summary">
        <p>上次保養: <span id="lastMaintenance">尚未記錄</span> | 里程: <span id="lastMaintOdo">N/A</span></p>
        <p>上次充電: <span id="lastCharge">尚未記錄</span> | 里程: <span id="lastChargeOdo">N/A</span></p>
        <p>下次保養預估: <span id="nextService">請先記錄保養</span></p>
        <p>總里程: <span id="totalMileage">0</span> km | 總花費: <span id="totalExpense">0</span> NT$</p>
    </div>

    <div class="tabs" id="formTabs">
        <button class="tab-button" data-tab="chargeFormTab">記錄充電</button>
        <button class="tab-button" data-tab="maintenanceFormTab">記錄保養</button>
        <button class="tab-button" data-tab="expenseFormTab">其他花費</button>
    </div>

    <div id="chargeFormTab" class="tab-content">
        <div id="startChargeSection">
            <h3>開始充電</h3>
            <form id="startChargeForm" class="form-section">
                <div class="input-group"><label for="cOdo">目前總里程 (ODO):</label><input type="number" step="0.1" id="cOdo" placeholder="公里" required><small>記錄當下儀表板的總里程數</small></div>
                <div class="input-group"><label>充電前電量 (格):</label>
                    <div class="radio-group-grid">
                        <input type="radio" id="bs0" name="cBatteryStart" value="0"><label for="bs0">0</label>
                        <input type="radio" id="bs1" name="cBatteryStart" value="1" checked><label for="bs1">1</label>
                        <input type="radio" id="bs2" name="cBatteryStart" value="2"><label for="bs2">2</label>
                        <input type="radio" id="bs3" name="cBatteryStart" value="3"><label for="bs3">3</label>
                        <input type="radio" id="bs4" name="cBatteryStart" value="4"><label for="bs4">4</label>
                        <input type="radio" id="bs5" name="cBatteryStart" value="5"><label for="bs5">5</label>
                    </div>
                </div>
                <div class="input-group">
                    <label>充電站/標記:</label>
                    <div class="radio-group">
                        <input type="radio" id="station_company" name="cStationRadio" value="公司" checked><label for="station_company">公司</label>
                        <input type="radio" id="station_public" name="cStationRadio" value="充電站"><label for="station_public">充電站</label>
                        <input type="radio" id="station_other" name="cStationRadio" value="其他"><label for="station_other">其他</label>
                    </div>
                    <input type="text" id="cStation" placeholder="請輸入地點" style="display:none; margin-top: 10px;">
                </div>
                <div class="input-group"><label for="cTrip">本次里程 (TRIP):</label><input type="number" step="0.1" id="cTrip" placeholder="公里"><small>上次充飽電後到現在的里程</small></div>
                <div class="input-group"><label for="cNotes">備註:</label><textarea id="cNotes" rows="2" placeholder="其他記錄事項"></textarea></div>
                <button type="submit" class="main-btn" style="background-color: var(--success-color);">開始充電</button>
            </form>
        </div>

        <div id="endChargeSection" style="display: none;">
            <h3>充電進行中...</h3>
            <div id="currentChargeInfo" class="current-charge-info"></div>
            <form id="endChargeForm" class="form-section">
                <div class="input-group"><label>充電後電量 (格):</label>
                    <div class="radio-group-grid">
                        <input type="radio" id="be0" name="cBatteryEnd" value="0"><label for="be0">0</label>
                        <input type="radio" id="be1" name="cBatteryEnd" value="1"><label for="be1">1</label>
                        <input type="radio" id="be2" name="cBatteryEnd" value="2"><label for="be2">2</label>
                        <input type="radio" id="be3" name="cBatteryEnd" value="3"><label for="be3">3</label>
                        <input type="radio" id="be4" name="cBatteryEnd" value="4"><label for="be4">4</label>
                        <input type="radio" id="be5" name="cBatteryEnd" value="5" checked><label for="be5">5</label>
                    </div>
                </div>
                 <div class="input-group" id="kwh-input-group"><label for="cKwh">充電度數 (kWh):</label><input type="number" step="0.01" id="cKwh" placeholder="例如:1.5"><small>插座端量測值，非必填</small></div>
                 <div class="input-group" id="cost-input-group"><label for="cCost">充電費用 (NT$):</label><input type="number" id="cCost" placeholder="例如:30"></div>
                <div class="input-group"><label for="cRange">預估里程 (RANGE):</label><input type="number" step="0.1" id="cRange" placeholder="公里"><small>儀表板預估值，非必填</small></div>
                <button type="submit" class="main-btn">結束充電並儲存</button>
            </form>
        </div>
    </div>

    <div id="maintenanceFormTab" class="tab-content">
        <h3 id="maintFormTitle">記錄保養</h3>
        <form id="maintenanceForm" class="form-section">
            <input type="hidden" id="editingMaintId">
            <div class="input-group"><label for="mDate">日期:</label><input type="date" id="mDate" required><button type="button" class="now-btn" id="maintNowBtn">現在</button></div>
            <div class="input-group"><label for="mTime">時間:</label><input type="time" id="mTime" required></div>
            <div class="input-group"><label for="mOdo">總里程 (ODO):</label><input type="number" step="0.1" id="mOdo" placeholder="公里" required></div>
            <div class="input-group"><label for="mLocation">地點:</label><input type="text" id="mLocation" placeholder="保養地點"></div>
            <div class="input-group"><label for="mType">保養類型:</label>
                <select id="mType">
                    <option value="定期保養">定期保養</option>
                    <option value="大保養">大保養</option>
                    <option value="小保養">小保養</option>
                    <option value="維修">維修</option>
                    <option value="檢查">檢查</option>
                </select>
            </div>
            <div class="input-group"><label for="mNotes">服務/備註:</label><textarea id="mNotes" rows="3" placeholder="例如:大保養、檢查電路"></textarea></div>
            <h3>保養項目/零件</h3>
            <div id="partsList"></div>
            <button type="button" class="main-btn add-part-btn" id="addPartBtn">新增項目</button>
            <hr>
            <p style="text-align: right; font-size: 1.2em; font-weight: bold;">總費用: NT$ <span id="totalCost">0</span></p>
            <button type="submit" class="main-btn">儲存記錄</button>
            <button type="button" class="main-btn cancel-edit-btn" id="cancelMaintEdit">取消編輯</button>
        </form>
    </div>

    <div id="expenseFormTab" class="tab-content">
        <h3 id="expenseFormTitle">記錄其他花費</h3>
        <form id="expenseForm" class="form-section">
            <input type="hidden" id="editingExpenseId">
            <div class="input-group"><label for="eDate">日期:</label><input type="date" id="eDate" required><button type="button" class="now-btn" id="expenseNowBtn">現在</button></div>
            <div class="input-group"><label for="eTime">時間:</label><input type="time" id="eTime" required></div>
            <div class="input-group"><label for="eOdo">總里程 (ODO):</label><input type="number" step="0.1" id="eOdo" placeholder="公里"></div>
            <div class="input-group"><label for="eCategory">類別:</label>
                <select id="eCategory">
                    <option value="保險">保險</option>
                    <option value="牌照稅">牌照稅</option>
                    <option value="停車費">停車費</option>
                    <option value="配件">配件</option>
                    <option value="清潔">清潔</option>
                    <option value="其他">其他</option>
                </select>
            </div>
            <div class="input-group"><label for="eAmount">金額 (NT$):</label><input type="number" id="eAmount" placeholder="費用" required></div>
            <div class="input-group"><label for="eDescription">說明:</label><textarea id="eDescription" rows="3" placeholder="詳細說明"></textarea></div>
            <button type="submit" class="main-btn">儲存記錄</button>
            <button type="button" class="main-btn cancel-edit-btn" id="cancelExpenseEdit">取消編輯</button>
        </form>
    </div>

    <h2 style="margin-top: 40px;">歷史記錄與分析</h2>
    <div class="tabs" id="historyTabs">
        <button class="tab-button" data-tab="chargeHistoryTab">充電歷史</button>
        <button class="tab-button" data-tab="maintenanceHistoryTab">保養歷史</button>
        <button class="tab-button" data-tab="expenseHistoryTab">花費記錄</button>
        <button class="tab-button" data-tab="statisticsTab">統計分析</button>
    </div>

    <div id="chargeHistoryTab" class="tab-content">
        <div class="filter-section">
            <input type="text" class="search-box" id="chargeSearch" placeholder="搜尋充電站...">
            <select id="chargeMonthFilter">
                <option value="">所有月份</option>
            </select>
        </div>
        <div class="analytics-section">
            <div class="analytics-item"><h4>平均效率</h4><p id="avgEfficiency">N/A</p></div>
            <div class="analytics-item"><h4>最佳效率</h4><p id="bestEfficiency">N/A</p></div>
            <div class="analytics-item"><h4>最差效率</h4><p id="worstEfficiency">N/A</p></div>
            <div class="analytics-item"><h4>總充電次數</h4><p id="totalCharges">0</p></div>
        </div>
        <div class="table-container">
            <table class="history-table">
                <thead><tr><th>期間</th><th>地點</th><th>TRIP</th><th>費用</th><th>效率<br>(km/kWh)</th><th>電量</th><th>時長</th><th>操作</th></tr></thead>
                <tbody id="chargeHistoryTable"></tbody>
            </table>
        </div>
        <div class="chart-container" style="margin-top:20px;"><canvas id="chargeChart"></canvas></div>
    </div>

    <div id="maintenanceHistoryTab" class="tab-content">
        <div class="filter-section">
            <input type="text" class="search-box" id="maintSearch" placeholder="搜尋內容...">
            <select id="maintMonthFilter">
                <option value="">所有月份</option>
            </select>
            <select id="maintTypeFilter">
                <option value="">所有類型</option>
                <option value="定期保養">定期保養</option>
                <option value="大保養">大保養</option>
                <option value="小保養">小保養</option>
                <option value="維修">維修</option>
                <option value="檢查">檢查</option>
            </select>
        </div>
        <div class="table-container">
            <table class="history-table">
                <thead><tr><th>日期</th><th>ODO</th><th>類型</th><th>項目/備註</th><th>費用</th><th>操作</th></tr></thead>
                <tbody id="maintenanceHistoryTable"></tbody>
            </table>
        </div>
        <div class="chart-container" style="margin-top:20px;"><canvas id="maintenanceChart"></canvas></div>
    </div>

    <div id="expenseHistoryTab" class="tab-content">
        <div class="filter-section">
            <select id="expenseCategoryFilter">
                <option value="">所有類別</option>
                <option value="保險">保險</option>
                <option value="牌照稅">牌照稅</option>
                <option value="停車費">停車費</option>
                <option value="配件">配件</option>
                <option value="清潔">清潔</option>
                <option value="其他">其他</option>
            </select>
            <select id="expenseMonthFilter">
                <option value="">所有月份</option>
            </select>
        </div>
        <div class="table-container">
            <table class="history-table">
                <thead><tr><th>日期</th><th>類別</th><th>金額</th><th>說明</th><th>操作</th></tr></thead>
                <tbody id="expenseHistoryTable"></tbody>
            </table>
        </div>
        <div class="chart-container" style="margin-top:20px;"><canvas id="expenseChart"></canvas></div>
    </div>

    <div id="statisticsTab" class="tab-content">
        <h3>整體統計</h3>
        <div class="statistics-grid">
            <div class="stat-card"><h4>總里程</h4><p id="statTotalMileage">0 km</p></div>
            <div class="stat-card"><h4>平均日里程</h4><p id="statAvgDaily">0 km</p></div>
            <div class="stat-card"><h4>總花費</h4><p id="statTotalCost">0 NT$</p></div>
            <div class="stat-card"><h4>每公里成本</h4><p id="statCostPerKm">0 NT$</p></div>
            <div class="stat-card"><h4>保養次數</h4><p id="statMaintCount">0</p></div>
            <div class="stat-card"><h4>充電次數</h4><p id="statChargeCount">0</p></div>
        </div>
        <h3>月度花費分析</h3>
        <div class="chart-container"><canvas id="monthlyExpenseChart"></canvas></div>
        <h3>花費類別分布</h3>
        <div class="chart-container"><canvas id="categoryPieChart"></canvas></div>
    </div>
    
    <div class="data-management-section">
        <h3>資料管理</h3>
        <input type="file" id="jsonImportInput" accept=".json">
        <button id="importBtn">匯入 JSON</button>
        <button id="exportChargeBtn">匯出充電 JSON</button>
        <button id="exportMaintBtn">匯出保養 JSON</button>
        <button id="exportExpenseBtn">匯出花費 JSON</button>
        <button id="exportAllBtn">匯出全部資料</button>
        <button id="clearAllBtn" style="color: var(--danger-color); border-color: var(--danger-color);">清除所有資料</button>
    </div>
</div>

<!-- Edit Charge Modal -->
<div id="editChargeModal" class="modal">
    <div class="modal-content">
        <h3>編輯充電記錄</h3>
        <form id="editChargeForm">
            <input type="hidden" id="editingChargeId">
            <div class="input-group"><label for="edit_cStartTime">開始時間:</label><input type="datetime-local" id="edit_cStartTime" required></div>
            <div class="input-group"><label for="edit_cEndTime">結束時間:</label><input type="datetime-local" id="edit_cEndTime" required></div>
            <div class="input-group"><label for="edit_cOdo">總里程 (ODO):</label><input type="number" step="0.1" id="edit_cOdo" required></div>
            <div class="input-group"><label for="edit_cTrip">本次里程 (TRIP):</label><input type="number" step="0.1" id="edit_cTrip"></div>
            <div class="input-group"><label for="edit_cStation">充電站:</label><input type="text" id="edit_cStation"></div>
            <div class="input-group"><label for="edit_cBatteryStart">開始電量 (格):</label><input type="number" id="edit_cBatteryStart"></div>
            <div class="input-group"><label for="edit_cBatteryEnd">結束電量 (格):</label><input type="number" id="edit_cBatteryEnd"></div>
            <div class="input-group"><label for="edit_cKwh">充電度數 (kWh):</label><input type="number" step="0.01" id="edit_cKwh"></div>
            <div class="input-group"><label for="edit_cCost">充電費用 (NT$):</label><input type="number" id="edit_cCost"></div>
            <div class="input-group"><label for="edit_cNotes">備註:</label><textarea id="edit_cNotes" rows="2"></textarea></div>
            <button type="submit" class="main-btn">儲存變更</button>
            <button type="button" class="main-btn" id="cancelEditChargeBtn" style="background-color: var(--secondary-color);">取消</button>
        </form>
    </div>
</div>


<script>
// --- 保養週期設定 (根據車主手冊) ---
const FIRST_SERVICE_KM = 300;       // 首次保養里程
const FIRST_SERVICE_DAYS = 30;      // 首次保養時間 (約1個月)
const REGULAR_SERVICE_KM = 3000;    // 定期保養里程
const REGULAR_SERVICE_DAYS = 180;   // 定期保養時間 (約6個月)

let chargeChartInstance, maintenanceChartInstance, expenseChartInstance, monthlyExpenseChartInstance, categoryPieChartInstance;
let chargeTimerInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    // --- Event Listeners ---
    
    // Forms
    document.getElementById('startChargeForm').addEventListener('submit', startCharging);
    document.getElementById('endChargeForm').addEventListener('submit', endCharging);
    document.getElementById('maintenanceForm').addEventListener('submit', handleMaintenanceSubmit);
    document.getElementById('expenseForm').addEventListener('submit', handleExpenseSubmit);
    document.getElementById('editChargeForm').addEventListener('submit', handleChargeEditSubmit);

    // Tabs
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', (event) => {
            const tabName = button.dataset.tab;
            if (tabName) {
                openTab(event, tabName);
            }
        });
    });

    // Data Management
    document.getElementById('importBtn').addEventListener('click', () => document.getElementById('jsonImportInput').click());
    document.getElementById('jsonImportInput').addEventListener('change', handleJsonImport);
    document.getElementById('exportChargeBtn').addEventListener('click', () => exportData('chargeLog', 'json'));
    document.getElementById('exportMaintBtn').addEventListener('click', () => exportData('maintenanceLog', 'json'));
    document.getElementById('exportExpenseBtn').addEventListener('click', () => exportData('expenseLog', 'json'));
    document.getElementById('exportAllBtn').addEventListener('click', exportAllData);
    document.getElementById('clearAllBtn').addEventListener('click', () => {
        if(confirm('確定要清除所有資料嗎?此操作無法復原!')) {
            clearAllData();
        }
    });

    // Form interactions
    document.getElementById('maintNowBtn').addEventListener('click', () => fillNow('mDate', 'mTime'));
    document.getElementById('expenseNowBtn').addEventListener('click', () => fillNow('eDate', 'eTime'));
    document.getElementById('addPartBtn').addEventListener('click', () => addPartItem());
    document.getElementById('cancelMaintEdit').addEventListener('click', () => cancelEdit('maint'));
    document.getElementById('cancelExpenseEdit').addEventListener('click', () => cancelEdit('expense'));
    document.querySelectorAll('input[name="cStationRadio"]').forEach(radio => {
        radio.addEventListener('change', toggleStationInput);
    });

    // Modal
    document.getElementById('cancelEditChargeBtn').addEventListener('click', closeEditChargeModal);

    // Filters
    document.getElementById('chargeSearch').addEventListener('keyup', (e) => filterTable('chargeHistoryTable', e.target.value));
    document.getElementById('chargeMonthFilter').addEventListener('change', () => filterByMonth('charge'));
    document.getElementById('maintSearch').addEventListener('keyup', (e) => filterTable('maintenanceHistoryTable', e.target.value));
    document.getElementById('maintMonthFilter').addEventListener('change', () => filterByMonth('maint'));
    document.getElementById('maintTypeFilter').addEventListener('change', filterByType);
    document.getElementById('expenseCategoryFilter').addEventListener('change', filterByCategory);
    document.getElementById('expenseMonthFilter').addEventListener('change', () => filterByMonth('expense'));

    // --- Initial Load ---
    document.querySelector('#formTabs .tab-button').click();
    document.querySelector('#historyTabs .tab-button').click();
    loadAllData();
    populateMonthFilters();
});

function loadAllData() {
    updateChargeUI(); // Check for ongoing charge first
    loadMaintenanceHistory();
    loadChargeHistory();
    loadExpenseHistory();
    updateSummary();
    updateAnalytics();
    renderCharts();
}

function openTab(evt, tabName) {
    const parentTabs = evt.currentTarget.parentElement;
    let contentContainer = parentTabs.parentElement;
    contentContainer.querySelectorAll('.tab-content').forEach(tc => {
        if(tc.parentElement === contentContainer) {
            tc.style.display = "none";
        }
    });

    parentTabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove("active"));
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.classList.add("active");
}

function formatDateTime(isoString) {
    if (!isoString) return '';
    return new Date(isoString).toLocaleString('zh-TW', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }).replace(/\//g, '-');
}

function toggleStationInput() {
    const isOther = document.getElementById('station_other').checked;
    const input = document.getElementById('cStation');
    input.style.display = isOther ? 'block' : 'none';
    if (!isOther) {
        input.value = '';
    }
}

function fillNow(dateId, timeId) {
    const now = new Date();
    const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString();
    document.getElementById(dateId).value = localDate.slice(0, 10);
    if(timeId) document.getElementById(timeId).value = localDate.slice(11, 16);
}

function addPartItem(name = '', cost = '') {
    const partsList = document.getElementById('partsList');
    const newItem = document.createElement('div');
    newItem.className = 'part-item';
    newItem.innerHTML = `
        <input type="text" class="part-name" placeholder="項目/零件名稱" value="${name}" oninput="updateTotalCost()">
        <input type="number" class="part-cost" placeholder="費用" value="${cost}" oninput="updateTotalCost()">
        <button type="button" class="remove-part-btn" onclick="this.parentElement.remove(); updateTotalCost();">X</button>
    `;
    partsList.appendChild(newItem);
    updateTotalCost();
}

function updateTotalCost() {
    let total = 0;
    document.querySelectorAll('#partsList .part-cost').forEach(input => {
        total += parseFloat(input.value) || 0;
    });
    document.getElementById('totalCost').textContent = total;
}

// --- Charging Flow ---
function startCharging(e) {
    e.preventDefault();
    const stationType = document.querySelector('input[name="cStationRadio"]:checked').value;
    let stationValue = stationType;
    if (stationType === '其他') {
        stationValue = document.getElementById('cStation').value;
    }

    const session = {
        id: Date.now(),
        startTime: new Date().toISOString(),
        odo: parseFloat(document.getElementById('cOdo').value),
        batteryStart: parseInt(document.querySelector('input[name="cBatteryStart"]:checked').value),
        station: stationValue,
        stationType: stationType,
        trip: parseFloat(document.getElementById('cTrip').value) || 0,
        notes: document.getElementById('cNotes').value
    };

    localStorage.setItem('currentChargingSession', JSON.stringify(session));
    document.getElementById('startChargeForm').reset();
    toggleStationInput();
    updateChargeUI();
}

function endCharging(e) {
    e.preventDefault();
    if (chargeTimerInterval) {
        clearInterval(chargeTimerInterval);
        chargeTimerInterval = null;
    }
    
    const session = JSON.parse(localStorage.getItem('currentChargingSession'));
    if (!session) return;

    const endTime = new Date();
    const startTime = new Date(session.startTime);
    let diff = endTime - startTime;
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const duration = `${hours}小時 ${minutes}分`;

    const record = {
        ...session,
        endTime: endTime.toISOString(),
        date: session.startTime.slice(0, 10),
        duration: duration,
        batteryEnd: parseInt(document.querySelector('input[name="cBatteryEnd"]:checked').value),
        kwh: parseFloat(document.getElementById('cKwh').value) || 0,
        cost: parseFloat(document.getElementById('cCost').value) || 0,
        range: document.getElementById('cRange').value,
    };

    saveData('chargeLog', record);
    localStorage.removeItem('currentChargingSession');
    document.getElementById('endChargeForm').reset();
    alert('充電記錄已儲存!');
    loadAllData();
}

function updateChargeUI() {
    const session = JSON.parse(localStorage.getItem('currentChargingSession'));
    const startSection = document.getElementById('startChargeSection');
    const endSection = document.getElementById('endChargeSection');

    if (chargeTimerInterval) {
        clearInterval(chargeTimerInterval);
        chargeTimerInterval = null;
    }

    if (session) {
        startSection.style.display = 'none';
        endSection.style.display = 'block';
        document.getElementById('currentChargeInfo').innerHTML = `
            <p><strong>開始時間:</strong> ${formatDateTime(session.startTime)}</p>
            <p><strong>開始里程:</strong> ${session.odo} km</p>
            <p><strong>開始電量:</strong> ${session.batteryStart} 格</p>
            <p><strong>充電站:</strong> ${session.station}</p>
            <p><strong>已充電時長:</strong> <span id="chargeDurationTimer">計算中...</span></p>
        `;
        
        const kwhGroup = document.getElementById('kwh-input-group');
        const costGroup = document.getElementById('cost-input-group');
        const kwhInput = document.getElementById('cKwh');
        const costInput = document.getElementById('cCost');

        kwhInput.value = '';
        costInput.value = '';
        
        kwhInput.required = false; 

        switch (session.stationType) {
            case '公司':
                kwhGroup.style.display = 'block';
                costGroup.style.display = 'none';
                costInput.required = false;
                break;
            case '充電站':
                kwhGroup.style.display = 'none';
                costGroup.style.display = 'block';
                costInput.required = true;
                break;
            default: // '其他'
                kwhGroup.style.display = 'block';
                costGroup.style.display = 'block';
                costInput.required = false; 
                break;
        }

        const startTime = new Date(session.startTime);
        const timerElement = document.getElementById('chargeDurationTimer');

        chargeTimerInterval = setInterval(() => {
            const now = new Date();
            const diff = now - startTime;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);

            const formattedTime = [
                hours.toString().padStart(2, '0'),
                minutes.toString().padStart(2, '0'),
                seconds.toString().padStart(2, '0')
            ].join(':');
            
            if(timerElement) {
                timerElement.textContent = formattedTime;
            }
        }, 1000);

    } else {
        startSection.style.display = 'block';
        endSection.style.display = 'none';
    }
}

function handleChargeEditSubmit(e) {
    e.preventDefault();
    const editingId = parseInt(document.getElementById('editingChargeId').value);
    
    const endTime = new Date(document.getElementById('edit_cEndTime').value);
    const startTime = new Date(document.getElementById('edit_cStartTime').value);
    let diff = endTime - startTime;
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const duration = `${hours}小時 ${minutes}分`;

    const record = {
        id: editingId,
        startTime: startTime.toISOString(),
        endTime: endTime.toISOString(),
        date: startTime.toISOString().slice(0, 10),
        duration: duration,
        odo: parseFloat(document.getElementById('edit_cOdo').value),
        trip: parseFloat(document.getElementById('edit_cTrip').value),
        station: document.getElementById('edit_cStation').value,
        batteryStart: parseInt(document.getElementById('edit_cBatteryStart').value),
        batteryEnd: parseInt(document.getElementById('edit_cBatteryEnd').value),
        kwh: parseFloat(document.getElementById('edit_cKwh').value),
        cost: parseFloat(document.getElementById('edit_cCost').value),
        notes: document.getElementById('edit_cNotes').value,
        range: 0 // Retain schema consistency
    };
    
    saveData('chargeLog', record, true);
    closeEditChargeModal();
    alert('充電記錄已更新!');
    loadAllData();
}

function closeEditChargeModal() {
    document.getElementById('editChargeModal').style.display = 'none';
}

function handleMaintenanceSubmit(e) {
    e.preventDefault();
    const editingId = document.getElementById('editingMaintId').value;
    const parts = [];
    document.querySelectorAll('#partsList .part-item').forEach(item => {
        parts.push({
            name: item.querySelector('.part-name').value,
            cost: parseFloat(item.querySelector('.part-cost').value) || 0
        });
    });
    const record = {
        id: editingId ? parseInt(editingId) : Date.now(),
        date: document.getElementById('mDate').value,
        time: document.getElementById('mTime').value,
        odo: parseFloat(document.getElementById('mOdo').value),
        location: document.getElementById('mLocation').value,
        type: document.getElementById('mType').value,
        notes: document.getElementById('mNotes').value,
        parts: parts,
        totalCost: parseFloat(document.getElementById('totalCost').textContent)
    };
    saveData('maintenanceLog', record, !!editingId);
    cancelEdit('maint');
    alert('保養記錄已儲存!');
    loadAllData();
}

function handleExpenseSubmit(e) {
    e.preventDefault();
    const editingId = document.getElementById('editingExpenseId').value;
    const record = {
        id: editingId ? parseInt(editingId) : Date.now(),
        date: document.getElementById('eDate').value,
        time: document.getElementById('eTime').value,
        odo: parseFloat(document.getElementById('eOdo').value) || 0,
        category: document.getElementById('eCategory').value,
        amount: parseFloat(document.getElementById('eAmount').value),
        description: document.getElementById('eDescription').value
    };
    saveData('expenseLog', record, !!editingId);
    cancelEdit('expense');
    alert('花費記錄已儲存!');
    loadAllData();
}

function saveData(key, newRecord, isEdit = false) {
    let data = JSON.parse(localStorage.getItem(key)) || [];
    if (isEdit) {
        const index = data.findIndex(item => item.id === newRecord.id);
        if (index > -1) data[index] = newRecord;
    } else {
        data.push(newRecord);
    }
    data.sort((a, b) => new Date(b.date + 'T' + (b.time || b.startTime || '00:00')) - new Date(a.date + 'T' + (a.time || a.startTime || '00:00')));
    localStorage.setItem(key, JSON.stringify(data));
}

function editRecord(key, id) {
    const data = JSON.parse(localStorage.getItem(key)) || [];
    const record = data.find(item => item.id === id);
    if (!record) return;

    if (key === 'chargeLog') {
        document.getElementById('editingChargeId').value = record.id;
        
        const toLocalISO = (iso) => {
            if (!iso) return '';
            const d = new Date(iso);
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            return d.toISOString().slice(0, 16);
        };
        
        document.getElementById('edit_cStartTime').value = toLocalISO(record.startTime);
        document.getElementById('edit_cEndTime').value = toLocalISO(record.endTime);
        document.getElementById('edit_cOdo').value = record.odo;
        document.getElementById('edit_cTrip').value = record.trip;
        document.getElementById('edit_cStation').value = record.station;
        document.getElementById('edit_cBatteryStart').value = record.batteryStart;
        document.getElementById('edit_cBatteryEnd').value = record.batteryEnd;
        document.getElementById('edit_cKwh').value = record.kwh;
        document.getElementById('edit_cCost').value = record.cost;
        document.getElementById('edit_cNotes').value = record.notes || '';

        document.getElementById('editChargeModal').style.display = 'block';

    } else if (key === 'maintenanceLog') {
        document.getElementById('editingMaintId').value = record.id;
        document.getElementById('mDate').value = record.date;
        document.getElementById('mTime').value = record.time;
        document.getElementById('mOdo').value = record.odo;
        document.getElementById('mLocation').value = record.location || '';
        document.getElementById('mType').value = record.type || '定期保養';
        document.getElementById('mNotes').value = record.notes || '';
        document.getElementById('partsList').innerHTML = '';
        if (record.parts) record.parts.forEach(p => addPartItem(p.name, p.cost));
        updateTotalCost();
        document.getElementById('maintFormTitle').textContent = '編輯保養記錄';
        document.getElementById('cancelMaintEdit').style.display = 'block';
        document.querySelector('#formTabs button[data-tab="maintenanceFormTab"]').click();
        window.scrollTo(0, 0);
    } else if (key === 'expenseLog') {
        document.getElementById('editingExpenseId').value = record.id;
        document.getElementById('eDate').value = record.date;
        document.getElementById('eTime').value = record.time;
        document.getElementById('eOdo').value = record.odo || '';
        document.getElementById('eCategory').value = record.category;
        document.getElementById('eAmount').value = record.amount;
        document.getElementById('eDescription').value = record.description || '';
        document.getElementById('expenseFormTitle').textContent = '編輯花費記錄';
        document.getElementById('cancelExpenseEdit').style.display = 'block';
        document.querySelector('#formTabs button[data-tab="expenseFormTab"]').click();
        window.scrollTo(0, 0);
    }
}

function deleteRecord(key, id) {
    if (!confirm('確定要刪除這筆記錄嗎?此操作無法復原。')) return;
    let data = JSON.parse(localStorage.getItem(key)) || [];
    data = data.filter(item => item.id !== id);
    localStorage.setItem(key, JSON.stringify(data));
    loadAllData();
}

function cancelEdit(type) {
    if (type === 'maint') {
        document.getElementById('maintenanceForm').reset();
        document.getElementById('editingMaintId').value = '';
        document.getElementById('partsList').innerHTML = '';
        updateTotalCost();
        document.getElementById('maintFormTitle').textContent = '記錄保養';
        document.getElementById('cancelMaintEdit').style.display = 'none';
    } else if (type === 'expense') {
        document.getElementById('expenseForm').reset();
        document.getElementById('editingExpenseId').value = '';
        document.getElementById('expenseFormTitle').textContent = '記錄其他花費';
        document.getElementById('cancelExpenseEdit').style.display = 'none';
    }
}

function calculateEfficiencies(data) {
    const chronologicalData = [...data].sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
    const efficiencyMap = {};

    for (let i = 1; i < chronologicalData.length; i++) {
        const currentRecord = chronologicalData[i];
        const prevRecord = chronologicalData[i - 1];

        const mileage = currentRecord.odo - prevRecord.odo;
        const kwh = currentRecord.kwh;

        if (mileage > 0 && kwh > 0) {
            efficiencyMap[currentRecord.id] = (mileage / kwh).toFixed(2);
        }
    }
    return efficiencyMap;
}

function loadChargeHistory() {
    const data = JSON.parse(localStorage.getItem('chargeLog')) || [];
    const tableBody = document.getElementById('chargeHistoryTable');
    tableBody.innerHTML = '';
    
    const sortedData = [...data].sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
    const efficiencyMap = calculateEfficiencies(data);

    sortedData.forEach(record => {
        const row = tableBody.insertRow();
        const efficiency = efficiencyMap[record.id] || 'N/A';
        const period = `${formatDateTime(record.startTime)}<br>~ ${formatDateTime(record.endTime)}`;

        row.innerHTML = `
            <td>${period}</td>
            <td>${record.station}</td>
            <td>${record.trip || '-'}</td>
            <td>${record.cost || '-'}</td>
            <td>${efficiency}</td>
            <td>${record.batteryStart || '?'}→${record.batteryEnd || '?'}格</td>
            <td>${record.duration || '-'}</td>
            <td class="action-buttons">
                <button class="edit-btn" onclick="editRecord('chargeLog', ${record.id})">編輯</button>
                <button class="delete-btn" onclick="deleteRecord('chargeLog', ${record.id})">刪除</button>
            </td>`;
    });
}


function loadMaintenanceHistory() {
    const data = JSON.parse(localStorage.getItem('maintenanceLog')) || [];
    const tableBody = document.getElementById('maintenanceHistoryTable');
    tableBody.innerHTML = '';
    
    const sortedData = [...data].sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));

    sortedData.forEach(record => {
        const row = tableBody.insertRow();
        let itemsDesc = record.parts && record.parts.length > 0 ? record.parts.map(p => p.name).join(', ') : record.notes;
        if (itemsDesc && itemsDesc.length > 30) itemsDesc = itemsDesc.substring(0, 30) + '...';
        row.innerHTML = `
            <td>${record.date.slice(5)}</td>
            <td>${record.odo}</td>
            <td>${record.type || '-'}</td>
            <td>${itemsDesc || '-'}</td>
            <td>${record.totalCost}</td>
            <td class="action-buttons">
                <button class="edit-btn" onclick="editRecord('maintenanceLog', ${record.id})">編輯</button>
                <button class="delete-btn" onclick="deleteRecord('maintenanceLog', ${record.id})">刪除</button>
            </td>`;
    });
}

function loadExpenseHistory() {
    const data = JSON.parse(localStorage.getItem('expenseLog')) || [];
    const tableBody = document.getElementById('expenseHistoryTable');
    tableBody.innerHTML = '';
    
    const sortedData = [...data].sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));

    sortedData.forEach(record => {
        const row = tableBody.insertRow();
        row.innerHTML = `
            <td>${record.date.slice(5)}</td>
            <td>${record.category}</td>
            <td>${record.amount}</td>
            <td>${record.description || '-'}</td>
            <td class="action-buttons">
                <button class="edit-btn" onclick="editRecord('expenseLog', ${record.id})">編輯</button>
                <button class="delete-btn" onclick="deleteRecord('expenseLog', ${record.id})">刪除</button>
            </td>`;
    });
}

function daysBetween(date1, date2) {
    if (!date1 || !date2) return 0;
    return Math.round(Math.abs((new Date(date1) - new Date(date2)) / (24 * 60 * 60 * 1000)));
}

function updateSummary() {
    const maintData = JSON.parse(localStorage.getItem('maintenanceLog')) || [];
    const chargeData = JSON.parse(localStorage.getItem('chargeLog')) || [];
    const expenseData = JSON.parse(localStorage.getItem('expenseLog')) || [];
    const today = new Date().toISOString().slice(0, 10);

    // --- 總里程 & 總花費 ---
    let totalMileage = 0;
    const allOdoData = [...chargeData, ...maintData, ...expenseData].filter(d => d.odo > 0);
    if(allOdoData.length > 0) {
        totalMileage = Math.max(...allOdoData.map(d => d.odo));
    }
    document.getElementById('totalMileage').textContent = totalMileage;

    let totalExpense = 0;
    maintData.forEach(m => totalExpense += m.totalCost || 0);
    chargeData.forEach(c => totalExpense += c.cost || 0);
    expenseData.forEach(e => totalExpense += e.amount || 0);
    document.getElementById('totalExpense').textContent = totalExpense.toFixed(0);
    
    // --- 下次保養預估 (新邏輯) ---
    const maintDataSorted = [...maintData].sort((a,b) => new Date(a.date) - new Date(b.date));
    const currentOdo = totalMileage;

    if (maintData.length === 0) {
        // 首次保養邏輯 (300km / 1個月)
        const allData = [...chargeData, ...expenseData];
        if (allData.length === 0) {
            document.getElementById('nextService').textContent = `首次保養: 300 km 或 1 個月`;
            document.getElementById('nextService').style.color = 'inherit';
        } else {
            const firstRecord = allData.sort((a,b) => new Date(a.date || a.startTime) - new Date(b.date || b.startTime))[0];
            const firstRecordDate = firstRecord.date || firstRecord.startTime.slice(0,10);
            const daysSinceFirstRecord = daysBetween(firstRecordDate, today);
            
            const kmLeft = FIRST_SERVICE_KM - currentOdo;
            const daysLeft = FIRST_SERVICE_DAYS - daysSinceFirstRecord;

            if (kmLeft <= 0 || daysLeft <= 0) {
                document.getElementById('nextService').textContent = `已超過首次保養里程/時間`;
                document.getElementById('nextService').style.color = 'var(--danger-color)';
            } else {
                document.getElementById('nextService').textContent = `首次保養: 約 ${kmLeft.toFixed(0)} km 或 ${daysLeft} 天後`;
                document.getElementById('nextService').style.color = 'var(--success-color)';
            }
        }
        document.getElementById('lastMaintenance').textContent = `尚未記錄`;
        document.getElementById('lastMaintOdo').textContent = `N/A`;

    } else { // maintData.length >= 1
        // 定期保養邏輯 (每 3000km / 6個月 from last)
        const last = maintDataSorted[maintDataSorted.length - 1];
        const daysAgo = daysBetween(last.date, today);
        document.getElementById('lastMaintenance').textContent = `${last.date} (${daysAgo}天前)`;
        document.getElementById('lastMaintOdo').textContent = `${last.odo} km`;

        const kmSince = currentOdo - last.odo;
        const kmLeft = REGULAR_SERVICE_KM - kmSince;
        const daysLeft = REGULAR_SERVICE_DAYS - daysAgo;

        if (kmLeft <= 0 || daysLeft <= 0) {
            document.getElementById('nextService').textContent = `已超過定期保養里程/時間`;
            document.getElementById('nextService').style.color = 'var(--danger-color)';
        } else {
            document.getElementById('nextService').textContent = `下次定期保養: 約 ${kmLeft.toFixed(0)} km 或 ${daysLeft} 天後`;
            document.getElementById('nextService').style.color = 'var(--success-color)';
        }
    }

    // --- 上次充電 ---
    if (chargeData.length > 0) {
        const last = [...chargeData].sort((a,b) => new Date(a.startTime) - new Date(b.startTime)).pop();
        const daysAgo = daysBetween(last.date, today);
        document.getElementById('lastCharge').textContent = `${last.date} (${daysAgo}天前)`;
        document.getElementById('lastChargeOdo').textContent = `${last.odo} km`;
    }

    // --- 統計頁面 ---
    document.getElementById('statTotalMileage').textContent = `${totalMileage} km`;
    document.getElementById('statTotalCost').textContent = `${totalExpense.toFixed(0)} NT$`;
    document.getElementById('statMaintCount').textContent = maintData.length;
    document.getElementById('statChargeCount').textContent = chargeData.length;
    
    if (totalMileage > 0) {
        document.getElementById('statCostPerKm').textContent = `${(totalExpense / totalMileage).toFixed(2)} NT$`;
    } else {
        document.getElementById('statCostPerKm').textContent = `0 NT$`;
    }
    
    const allRecordsWithDate = [...chargeData, ...maintData, ...expenseData].filter(d => d.date);
    if (allRecordsWithDate.length > 1) {
        const firstDate = new Date(allRecordsWithDate.sort((a,b) => new Date(a.date) - new Date(b.date))[0].date);
        const lastDate = new Date();
        const days = daysBetween(firstDate, lastDate) || 1;
        const avgDaily = totalMileage / days;
        document.getElementById('statAvgDaily').textContent = `${avgDaily.toFixed(1)} km`;
    } else {
        document.getElementById('statAvgDaily').textContent = `0 km`;
    }
}


function updateAnalytics() {
    const data = JSON.parse(localStorage.getItem('chargeLog')) || [];
    document.getElementById('totalCharges').textContent = data.length;
    
    const efficiencyMap = calculateEfficiencies(data);
    const efficiencies = Object.values(efficiencyMap).map(v => parseFloat(v));

    if (efficiencies.length > 0) {
        const total = efficiencies.reduce((a, b) => a + b, 0);
        document.getElementById('avgEfficiency').textContent = `${(total / efficiencies.length).toFixed(2)} km/kWh`;
        document.getElementById('bestEfficiency').textContent = `${Math.max(...efficiencies).toFixed(2)} km/kWh`;
        document.getElementById('worstEfficiency').textContent = `${Math.min(...efficiencies).toFixed(2)} km/kWh`;
    } else {
        document.getElementById('avgEfficiency').textContent = 'N/A';
        document.getElementById('bestEfficiency').textContent = 'N/A';
        document.getElementById('worstEfficiency').textContent = 'N/A';
    }
}


function populateMonthFilters() {
    const allData = [
        ...JSON.parse(localStorage.getItem('chargeLog') || '[]'),
        ...JSON.parse(localStorage.getItem('maintenanceLog') || '[]'),
        ...JSON.parse(localStorage.getItem('expenseLog') || '[]')
    ];
    
    const months = new Set();
    allData.forEach(record => {
        if (record.date) months.add(record.date.slice(0, 7));
    });
    
    const sortedMonths = Array.from(months).sort().reverse();
    
    ['chargeMonthFilter', 'maintMonthFilter', 'expenseMonthFilter'].forEach(filterId => {
        const select = document.getElementById(filterId);
        select.innerHTML = '<option value="">所有月份</option>';
        sortedMonths.forEach(month => {
            const option = document.createElement('option');
            option.value = month;
            option.textContent = month;
            select.appendChild(option);
        });
    });
}

function filterTable(tableId, searchText) {
    const table = document.getElementById(tableId);
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchText.toLowerCase()) ? '' : 'none';
    }
}

function filterByMonth(type) {
    const tableIdMap = {
        charge: 'chargeHistoryTable',
        maint: 'maintenanceHistoryTable',
        expense: 'expenseHistoryTable'
    };
    
    const filterId = `${type}MonthFilter`;
    const selectedMonth = document.getElementById(filterId).value;
    const tableBody = document.getElementById(tableIdMap[type]);

    for (let i = 0; i < tableBody.rows.length; i++) {
        const row = tableBody.rows[i];
        const dateCellText = row.cells[0].textContent; 
        row.style.display = (!selectedMonth || dateCellText.includes(selectedMonth)) ? '' : 'none';
    }
}


function filterByType() {
    const selectedType = document.getElementById('maintTypeFilter').value;
    const tableBody = document.getElementById('maintenanceHistoryTable');
    const rows = tableBody.querySelectorAll('tr');
    rows.forEach(row => {
        const type = row.cells[2].textContent;
        if (!selectedType || type === selectedType) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function filterByCategory() {
    const selectedCategory = document.getElementById('expenseCategoryFilter').value;
    const tableBody = document.getElementById('expenseHistoryTable');
    const rows = tableBody.querySelectorAll('tr');
    rows.forEach(row => {
        const category = row.cells[1].textContent;
        if (!selectedCategory || category === selectedCategory) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function handleJsonImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            if (importedData.type === 'all') {
                if (!confirm('確定要匯入完整資料嗎?這將會覆蓋現有的所有記錄。')) return;
                if (importedData.chargeLog) localStorage.setItem('chargeLog', JSON.stringify(importedData.chargeLog));
                if (importedData.maintenanceLog) localStorage.setItem('maintenanceLog', JSON.stringify(importedData.maintenanceLog));
                if (importedData.expenseLog) localStorage.setItem('expenseLog', JSON.stringify(importedData.expenseLog));
                alert('完整資料匯入成功!');
            } else if (importedData.type && Array.isArray(importedData.data)) {
                if (!confirm('確定要匯入資料嗎?這將會覆蓋現有的同類型記錄。')) return;
                localStorage.setItem(importedData.type, JSON.stringify(importedData.data));
                alert('資料匯入成功!');
            } else {
                alert('JSON 檔案格式不符!');
                return;
            }
            
            loadAllData();
            populateMonthFilters();
        } catch (error) {
            alert('讀取檔案失敗,請確認是否為正確的 JSON 檔案。');
        } finally {
            event.target.value = '';
        }
    };
    reader.readAsText(file);
}

function exportData(key, format) {
    const data = JSON.parse(localStorage.getItem(key) || '[]');
    if (data.length === 0) {
        alert('沒有資料可以匯出!');
        return;
    }
    const dataToExport = {
        type: key,
        version: '2.1',
        exportDate: new Date().toISOString(),
        data: data
    };
    const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${key}_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function exportAllData() {
    const allData = {
        type: 'all',
        version: '2.1',
        exportDate: new Date().toISOString(),
        chargeLog: JSON.parse(localStorage.getItem('chargeLog') || '[]'),
        maintenanceLog: JSON.parse(localStorage.getItem('maintenanceLog') || '[]'),
        expenseLog: JSON.parse(localStorage.getItem('expenseLog') || '[]')
    };
    
    const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `motorcycle_all_data_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function clearAllData() {
    localStorage.clear();
    loadAllData();
    alert('所有資料已清除!');
}

function renderCharts() {
    const maintData = JSON.parse(localStorage.getItem('maintenanceLog')) || [];
    const chargeData = JSON.parse(localStorage.getItem('chargeLog')) || [];
    const expenseData = JSON.parse(localStorage.getItem('expenseLog')) || [];

    if (maintenanceChartInstance) maintenanceChartInstance.destroy();
    if (maintData.length > 0) {
        const ctx = document.getElementById('maintenanceChart').getContext('2d');
        maintenanceChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: maintData.map(d => `${d.date.slice(5)}`).reverse(),
                datasets: [{
                    label: '保養費用 (NT$)',
                    data: [...maintData].map(d => d.totalCost).reverse(),
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.1
                }]
            },
            options: { responsive: true, plugins: { legend: { display: true }}}
        });
    }

    if (chargeChartInstance) chargeChartInstance.destroy();
    if (chargeData.length > 1) {
        const efficiencyMap = calculateEfficiencies(chargeData);
        const efficiencies = Object.entries(efficiencyMap).map(([id, value]) => ({
            id: parseInt(id),
            value: parseFloat(value)
        }));
        
        // Ensure chart data is also in chronological order
        const chronologicalData = [...chargeData].sort((a,b) => new Date(a.startTime) - new Date(b.startTime));
        const chartData = chronologicalData
            .map(record => {
                const efficiency = efficiencies.find(e => e.id === record.id);
                return efficiency ? { label: record.date.slice(5), value: efficiency.value } : null;
            })
            .filter(item => item !== null);

        const ctx = document.getElementById('chargeChart').getContext('2d');
        chargeChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.map(d => d.label),
                datasets: [{
                    label: '效率 (km/kWh)',
                    data: chartData.map(d => d.value),
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, plugins: { legend: { display: true }}}
        });
    }

    if (expenseChartInstance) expenseChartInstance.destroy();
    if (expenseData.length > 0) {
        const ctx = document.getElementById('expenseChart').getContext('2d');
        expenseChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: expenseData.map(d => `${d.date.slice(5)}`).reverse(),
                datasets: [{
                    label: '花費金額 (NT$)',
                    data: [...expenseData].map(d => d.amount).reverse(),
                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, plugins: { legend: { display: true }}}
        });
    }

    renderMonthlyExpenseChart();
    renderCategoryPieChart();
}

function renderMonthlyExpenseChart() {
    const maintData = JSON.parse(localStorage.getItem('maintenanceLog')) || [];
    const chargeData = JSON.parse(localStorage.getItem('chargeLog')) || [];
    const expenseData = JSON.parse(localStorage.getItem('expenseLog')) || [];
    
    const monthlyData = {};
    
    maintData.forEach(m => {
        const month = m.date.slice(0, 7);
        monthlyData[month] = (monthlyData[month] || 0) + (m.totalCost || 0);
    });
    
    chargeData.forEach(c => {
        const month = c.date.slice(0, 7);
        monthlyData[month] = (monthlyData[month] || 0) + (c.cost || 0);
    });
    
    expenseData.forEach(e => {
        const month = e.date.slice(0, 7);
        monthlyData[month] = (monthlyData[month] || 0) + (e.amount || 0);
    });
    
    const sortedMonths = Object.keys(monthlyData).sort();
    
    if (monthlyExpenseChartInstance) monthlyExpenseChartInstance.destroy();
    if (sortedMonths.length > 0) {
        const ctx = document.getElementById('monthlyExpenseChart').getContext('2d');
        monthlyExpenseChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedMonths,
                datasets: [{
                    label: '月度總花費 (NT$)',
                    data: sortedMonths.map(m => monthlyData[m]),
                    borderColor: 'rgb(153, 102, 255)',
                    backgroundColor: 'rgba(153, 102, 255, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: { responsive: true, plugins: { legend: { display: true }}}
        });
    }
}

function renderCategoryPieChart() {
    const maintData = JSON.parse(localStorage.getItem('maintenanceLog')) || [];
    const chargeData = JSON.parse(localStorage.getItem('chargeLog')) || [];
    const expenseData = JSON.parse(localStorage.getItem('expenseLog') || '[]');
    
    const categoryData = { '保養': 0, '充電': 0 };
    
    maintData.forEach(m => categoryData['保養'] += m.totalCost || 0);
    chargeData.forEach(c => categoryData['充電'] += c.cost || 0);
    expenseData.forEach(e => {
        categoryData[e.category] = (categoryData[e.category] || 0) + e.amount;
    });
    
    const categories = Object.keys(categoryData).filter(k => categoryData[k] > 0);
    const values = categories.map(k => categoryData[k]);
    
    if (categoryPieChartInstance) categoryPieChartInstance.destroy();
    if (categories.length > 0) {
        const ctx = document.getElementById('categoryPieChart').getContext('2d');
        categoryPieChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: categories,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 159, 64, 0.8)',
                        'rgba(199, 199, 199, 0.8)'
                    ]
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom' }}}
        });
    }
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾·å¾·å·¥ä½œå®¤æ¶ˆè²»è¨ˆç®— (114å¹´9æœˆç‰ˆ)</title>
    <style>
        :root {
            --bar-height: 85px; /* å¢åŠ åŸºç¤é«˜åº¦ä»¥å®¹ç´æŠ˜æ‰£èªªæ˜ */
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 20px 20px 0 20px;
            line-height: 1.6;
            background-color: #f4f4f9;
            color: #333;
            transition: padding-bottom 0.3s ease-in-out;
        }
        .container {
            max-width: 800px;
            margin: auto;
            padding: 20px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h2 {
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            color: #0056b3;
        }
        fieldset {
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 20px;
            padding: 15px;
        }
        legend {
            font-weight: bold;
            color: #333;
            padding: 0 10px;
        }
        .service-item {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }
        .service-item input[type="checkbox"] {
            margin-right: 10px;
        }
        .service-item label {
            font-weight: normal;
        }
        .price-info {
            margin-left: auto;
            text-align: right;
        }
        .promotion-price { color: #dc3545; font-weight: bold; }
        .original-price { text-decoration: line-through; color: #999; font-size: 0.9em; margin-left: 5px; }
        .toast-notification {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7); color: white; padding: 10px 20px;
            border-radius: 5px; z-index: 2000; opacity: 0; pointer-events: none;
            transition: opacity 0.5s ease;
        }
        .toast-notification.show { opacity: 1; }

        /* --- æ‡¸æµ®è¦–çª—æ¨£å¼ --- */
        #floating-summary {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: #fff; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000; display: flex; flex-direction: column-reverse;
        }
        #summary-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; /* æ”¹ç”¨ padding å¢åŠ å½ˆæ€§ */
            cursor: pointer; 
            min-height: var(--bar-height); /* æ”¹ç‚º min-height ä»¥ä¾¿è‡ªå‹•å¢é«˜ */
            border-top: 1px solid #eee; flex-shrink: 0;
        }
        #toggle-details { display: flex; align-items: center; font-weight: bold; color: #007bff; }
        .arrow { display: inline-block; margin-left: 8px; transition: transform 0.3s ease-in-out; }
        #floating-summary.partial-expand .arrow,
        #floating-summary.full-expand .arrow { transform: rotate(180deg); }

        #summary-details {
            max-height: 0; overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            display: flex; flex-direction: column;
        }
        #floating-summary.partial-expand #summary-details { max-height: 35vh; }
        #floating-summary.full-expand #summary-details { max-height: calc(100vh - var(--bar-height)); }
        
        .details-content {
            padding: 15px 20px; display: flex; flex-direction: column;
            flex-grow: 1; min-height: 0;
            overflow: hidden; /* é—œéµï¼šç¢ºä¿æ­¤å®¹å™¨ä¸æº¢å‡º */
        }
        .details-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 10px;
            flex-shrink: 0; /* ç¢ºä¿æ¨™é¡Œåˆ—ä¸æœƒè¢«å£“ç¸® */
        }
        .details-header h3 { margin: 0; padding: 0; border: none; color: #0056b3; }
        .header-actions { display: flex; gap: 8px; }
        .header-actions button {
            background: #e9ecef; border: 1px solid #ced4da; border-radius: 5px; cursor: pointer;
            padding: 0; width: 32px; height: 32px; font-size: 16px; line-height: 32px;
            text-align: center; color: #495057;
        }
        .header-actions button:hover { background: #dee2e6; }
        
        #floating-selected-items-list { 
            overflow-y: auto; /* é—œéµï¼šè®“æ­¤åˆ—è¡¨ç¨ç«‹æ²å‹• */
            flex-grow: 1; 
           max-height:65vh;
        }
        #floating-selected-items-list ul { list-style: none; padding: 0; }
        #floating-selected-items-list li {
            padding: 8px 0; border-bottom: 1px dotted #eee;
            display: flex; justify-content: space-between;
        }
        .item-name { flex-grow: 1; }
        .item-price-detail { white-space: nowrap; margin-left: 15px}
        .final-totals { text-align: right; }
        .final-totals p { font-size: 0.9em; font-weight: bold; margin: 2px 0; }
        .final-totals #floating-discounted-total { color: #dc3545; font-size: 1.2em; }
        .discount-note { color: #28a745; font-weight: bold; font-size: 0.8em; }
    </style>
</head>
<body>

<div id="toast-notification" class="toast-notification"></div>

<div class="container">
    <h2>å¾·å¾·å·¥ä½œå®¤æ¶ˆè²»è¨ˆç®— (114å¹´9æœˆç‰ˆ)</h2>

    <div id="service-list"></div>
    
    <fieldset>
        <legend>å®¢æˆ¶èº«åˆ†</legend>
        <div class="service-item">
            <input type="checkbox" id="isBirthdayPerson">
            <label for="isBirthdayPerson">ç•¶æœˆå£½æ˜Ÿ (åŸåƒ¹ 5 æŠ˜)</label>
        </div>
        <div class="service-item">
            <input type="checkbox" id="isStudent">
            <label for="isStudent">å­¸ç”Ÿ (åŸåƒ¹ 8 æŠ˜)</label>
        </div>
    </fieldset>
</div>

<div id="floating-summary">
    <div id="summary-bar">
        <div id="toggle-details">
            <span>æŸ¥çœ‹æ˜ç´°</span>
            <span class="arrow">â–²</span>
        </div>
        <div class="final-totals">
            <div id="discount-note-container" style="display: none;">
                <span class="discount-note"></span>
            </div>
            <p>åŸå§‹ç¸½é‡‘é¡ï¼š<span id="floating-original-total">0</span> å…ƒ</p>
            <p>æŠ˜æ‰£å¾Œç¸½é‡‘é¡ï¼š<span id="floating-discounted-total">0</span> å…ƒ</p>
        </div>
    </div>
    <div id="summary-details">
        <div class="details-content">
            <div class="details-header">
                <h3>æ¶ˆè²»æ˜ç´°</h3>
                <div class="header-actions">
                    <button id="save-btn" title="å„²å­˜ç•¶å‰é¸æ“‡">ğŸ’¾</button>
                    <button id="load-btn" title="è¼‰å…¥ä¸Šæ¬¡é¸æ“‡">ğŸ“‚</button>
                    <button id="clear-btn" title="æ¸…é™¤æ‰€æœ‰é¸é …">ğŸ—‘ï¸</button>
                    <button id="fullscreen-toggle-btn" title="åˆ‡æ›å…¨è¢å¹•">â›¶</button>
                </div>
            </div>
            <div id="floating-selected-items-list">
                <ul></ul>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const serviceData = {
        categories: [
            {
                name: 'ç”·å£«å°ˆå±¬é™¤æ¯›',
                items: [
                    { id: 'private_full', name: 'ç§å¯†è™•é™¤æ¯› (å…¨é™¤)', price: 1900 },
                    { id: 'nose', name: 'é¼»æ¯›', price: 200 },
                    { id: 'private_shape', name: 'ç§å¯†è™•é™¤æ¯› (å±€éƒ¨/é€ å‹)', price: 1900 },
                    { id: 'private_trim', name: 'ç§å¯†è™•æ¯›ä¿®å‰ª-ä¸€èˆ¬ä¿®å‰ªç„¡ç—›(ä¿®å‰ª+æ²æµ´)', price: 300 },
                    { id: 'belly_lower', name: 'ä¸‰è§’è™•(ä¸‹è…¹æ¯›ä»¥ä¸‹,æ ¹éƒ¨ä»¥ä¸Š)', price: 800 },
                    { id: 'armpit', name: 'è…‹ä¸‹æ¯›', price: 600 },
                    { id: 'belly_upper', name: 'ä¸Šè…¹éƒ¨æ¯›(è‚šè‡ä»¥ä¸Šèƒ¸éƒ¨ä»¥ä¸‹)', price: 600 },
                    { id: 'belly_middle', name: 'ä¸‹è…¹éƒ¨æ¯›(è‚šè‡ä»¥ä¸‹é™°æ¯›ä»¥ä¸Š)', price: 600 },
                    { id: 'arm_half', name: 'åŠæ‰‹è‡‚', price: 1600 },
                    { id: 'arm_full', name: 'å…¨æ‰‹è‡‚', price: 3000 },
                    { id: 'finger', name: 'æ‰‹æŒ‡', price: 300 },
                    { id: 'hand_back', name: 'æ‰‹èƒŒ', price: 300 },
                    { id: 'toe', name: 'è…³è¶¾', price: 300 },
                    { id: 'foot_back', name: 'è…³èƒŒ', price: 300 },
                    { id: 'leg_calf', name: 'å°è…¿', price: 1900 },
                    { id: 'leg_thigh', name: 'å¤§è…¿', price: 1900 },
                    { id: 'leg_full', name: 'å…¨è…¿', price: 3500, promoPrice: 3000 },
                    { id: 'nipple', name: 'å¥¶é ­æ¯›', price: 200 },
                    { id: 'chest', name: 'èƒ¸æ¯›', price: 600 },
                    { id: 'private_area', name: 'å€åŸŸå–®ç¨é™¤æ¯›', price: 600 },
                    { id: 'beard', name: 'é¬å­ç†±è Ÿé™¤æ¯›(å…«å­—é¬èˆ‡ä¸‹å·´)', price: 1000, promoPrice: 900 },
                    // { id: 'health_check', name: 'å¥åº·æª¢æ¸¬(å…¬ç›Šå…è²»)', price: 0 },
                    { id: 'private_combo_part', name: 'ç§å¯†è™•å–®ä¸€å€åŸŸä»»é¸2éƒ¨ä½', price: 1200, promoPrice: 1000 }
                ]
            },
            {
                name: 'ç”·å£«å°ˆå±¬æ²¹å£“',
                items: [
                    { id: 'oil_massage_1hr', name: '[æ²¹æ¨]èƒ½é‡ç²¾æ²¹ å¥åº·èª¿ç† /1hr(å«æ©Ÿèƒ½ä¿é¤Š)', price: 1200 },
                    // { id: 'oil_massage_1.5hr_home', name: '(åˆ°åºœ)[æ²¹æ¨]å¤©ç„¶æ¤ç²¹èƒ½é‡ç²¾æ²¹ æ°£è„ˆå¥åº·èª¿ç† /1.5hr', price: 3000 },
                    // { id: 'oil_massage_1hr_home', name: '(åˆ°åºœ)[æ²¹æ¨]å¤©ç„¶æ¤ç²¹èƒ½é‡ç²¾æ²¹ æ°£è„ˆå¥åº·èª¿ç† /1hr', price: 2000 },
                    // { id: 'oil_massage_double', name: '[æ²¹æ¨]é›™äººå››æ‰‹èƒ½é‡ç²¾æ²¹å¥åº·èª¿ç† /1hr(è«‹è¯ç¹«å®¢æœ)', price: 2200 },
                    { id: 'oil_massage_1.5hr', name: '[æ²¹æ¨]èƒ½é‡ç²¾æ²¹å¥åº·èª¿ç† /1.5hr(å«æ©Ÿèƒ½ä¿é¤Š)', price: 1800, promoPrice: 1500 }
                ]
            },
            {
                name: 'ç”·å£«å°ˆå±¬æŒ‡å£“',
                items: [
                    { id: 'acupressure_1hr', name: '[æŒ‡å£“]èƒ½é‡å¥åº·èª¿ç† /1hr', price: 1000 },
                    { id: 'acupressure_1.5hr', name: '[æŒ‡å£“]èƒ½é‡å¥åº·èª¿ç† /1.5hr', price: 1500 }
                ]
            },
            {
                name: 'ç”·å£«å°ˆå±¬ç­‹è†œåˆ€é«”é›•',
                items: [
                    { id: 'fascia_knife_1hr', name: 'ç­‹è†œåˆ€é«”é›• æ°£è„ˆå¥åº·èª¿ç† /1hr', price: 1600 },
                    { id: 'fascia_knife_1.5hr', name: 'ç­‹è†œåˆ€é«”é›• æ°£è„ˆå¥åº·èª¿ç† /1.5hr', price: 2200 }
                ]
            },
            {
                name: 'ç”·å£«å°ˆå±¬SPA',
                items: [
                    { id: 'spa_face', name: 'ã€è‡‰éƒ¨ã€‘æ›´æ–°æ²¹ç¾ç™½ç…¥è†šè¬å¹´ç¤¦æ³¥è‡‰éƒ¨è‚Œè†šèª¿ç† /1hr', price: 1800 },
                    { id: 'spa_private', name: 'ã€ç§å¯†è™•ã€‘æ›´æ–°æ²¹ç¾ç™½æ›è†šè¬å¹´ç¤¦æ³¥ å±è‚¡+ç§å¯†è™• è‚Œè†šèª¿ç† /1hr', price: 2200, promoPrice: 1800 },
                    { id: 'spa_body', name: 'ã€å…¨èº«ã€‘æ›´æ–°æ²¹å…¨èº«æ·±å±¤æ•·é«”æ·¨åŒ– /1.5hr', price: 3000, promoPrice: 2600 }
                ]
            }
        ],
        combos: [
            {
                id: 'combo_private_armpit',
                name: 'ç§å¯†è™•å…¨é™¤ + è…‹ä¸‹æ¯› çµ„åˆå„ªæƒ ',
                itemIds: ['private_full', 'armpit'],
                price: 2200
            }
        ]
    };

    const allServices = new Map(serviceData.categories.flatMap(cat => cat.items).map(item => [item.id, item]));
    const STORAGE_KEY = 'serviceCalculatorState_v3';
    
    // DOM å…ƒç´ 
    const serviceListContainer = document.getElementById('service-list');
    const isBirthdayPerson = document.getElementById('isBirthdayPerson');
    const isStudent = document.getElementById('isStudent');
    const toast = document.getElementById('toast-notification');
    
    // æ‡¸æµ®è¦–çª—å…§çš„å…ƒç´ 
    const floatingSummary = document.getElementById('floating-summary');
    const summaryBar = document.getElementById('summary-bar');
    const fullscreenToggleBtn = document.getElementById('fullscreen-toggle-btn');
    const saveBtn = document.getElementById('save-btn');
    const loadBtn = document.getElementById('load-btn');
    const clearBtn = document.getElementById('clear-btn');
    
    const originalTotalSpan = document.getElementById('floating-original-total');
    const discountedTotalSpan = document.getElementById('floating-discounted-total');
    const selectedItemsListUl = document.querySelector('#floating-selected-items-list ul');
    const discountNoteContainer = document.getElementById('discount-note-container');
    const discountNoteSpan = discountNoteContainer.querySelector('.discount-note');

    // --- å‡½æ•¸å€‘ (å…§å®¹ä¸è®Š) ---

    function renderServices() {
        serviceData.categories.forEach(category => {
            const fieldset = document.createElement('fieldset');
            const legend = document.createElement('legend');
            legend.textContent = category.name;
            fieldset.appendChild(legend);
            category.items.forEach(service => {
                const div = document.createElement('div');
                div.className = 'service-item';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox'; checkbox.id = service.id; checkbox.value = service.id;
                const label = document.createElement('label');
                label.htmlFor = service.id; label.textContent = service.name;
                const priceDiv = document.createElement('div');
                priceDiv.className = 'price-info';
                priceDiv.innerHTML = (service.promoPrice !== undefined) ?
                    `<span class="promotion-price">$${service.promoPrice.toLocaleString()}</span> <span class="original-price">$${service.price.toLocaleString()}</span>` :
                    `<span>$${service.price.toLocaleString()}</span>`;
                div.appendChild(checkbox); div.appendChild(label); div.appendChild(priceDiv);
                fieldset.appendChild(div);
            });
            serviceListContainer.appendChild(fieldset);
        });
    }

    function calculatePrices() {
        const selectedIds = new Set(Array.from(document.querySelectorAll('#service-list input:checked')).map(cb => cb.value));
        let originalTotal = 0, promoTotal = 0;
        const processedIds = new Set(), displayItems = [];
        serviceData.combos.forEach(combo => {
            if (combo.itemIds.every(id => selectedIds.has(id))) {
                const comboOriginalPrice = combo.itemIds.reduce((sum, id) => sum + allServices.get(id).price, 0);
                originalTotal += comboOriginalPrice; promoTotal += combo.price;
                displayItems.push({ type: 'combo', comboInfo: combo, originalPrice: comboOriginalPrice });
                combo.itemIds.forEach(id => processedIds.add(id));
            }
        });
        selectedIds.forEach(id => {
            if (!processedIds.has(id)) {
                const service = allServices.get(id);
                if (service) {
                    originalTotal += service.price; promoTotal += service.promoPrice ?? service.price;
                    displayItems.push({ type: 'service', serviceInfo: service });
                }
            }
        });
        let finalPrice = promoTotal, discountType = displayItems.length > 0 ? 'ä¿ƒéŠ·/çµ„åˆåƒ¹' : 'ç„¡';
        const birthdayDiscount = originalTotal * 0.5;
        const studentDiscount = originalTotal * 0.8;
        if (isBirthdayPerson.checked && birthdayDiscount < finalPrice) {
            finalPrice = birthdayDiscount; discountType = 'å£½æ˜ŸåŸåƒ¹ 5 æŠ˜';
        }
        if (isStudent.checked && studentDiscount < finalPrice) {
            finalPrice = studentDiscount; discountType = 'å­¸ç”ŸåŸåƒ¹ 8 æŠ˜';
        }
        return { originalTotal: Math.round(originalTotal), finalTotal: Math.round(finalPrice), appliedDiscount: discountType, displayItems };
    }
    
    function updateDisplay(result) {
        originalTotalSpan.textContent = result.originalTotal.toLocaleString();
        discountedTotalSpan.textContent = result.finalTotal.toLocaleString();
        discountNoteContainer.style.display = (result.appliedDiscount !== 'ç„¡' && result.finalTotal < result.originalTotal) ? 'block' : 'none';
        if (discountNoteContainer.style.display === 'block') {
            discountNoteSpan.textContent = `å·²å¥—ç”¨æœ€å„ªæƒ æŠ˜æ‰£: ${result.appliedDiscount}`;
        }
        selectedItemsListUl.innerHTML = '';
        const isIdentityDiscount = result.appliedDiscount.includes('å£½æ˜Ÿ') || result.appliedDiscount.includes('å­¸ç”Ÿ');
        result.displayItems.forEach(item => {
            if (item.type === 'combo' && !isIdentityDiscount) {
                const li = document.createElement('li');
                li.innerHTML = `<span class="item-name">${item.comboInfo.name}</span><span class="item-price-detail"><span class="promotion-price">$${item.comboInfo.price.toLocaleString()}</span> <span class="original-price">$${item.originalPrice.toLocaleString()}</span></span>`;
                selectedItemsListUl.appendChild(li);
            } else {
                const servicesToRender = (item.type === 'service') ? [item.serviceInfo] : item.comboInfo.itemIds.map(id => allServices.get(id));
                servicesToRender.forEach(service => {
                    const li = document.createElement('li');
                    const priceHtml = isIdentityDiscount ? `<span>$${service.price.toLocaleString()}</span>` :
                        (service.promoPrice !== undefined ?
                        `<span class="promotion-price">$${service.promoPrice.toLocaleString()}</span> <span class="original-price">$${service.price.toLocaleString()}</span>` :
                        `<span>$${service.price.toLocaleString()}</span>`);
                    li.innerHTML = `<span class="item-name">${service.name}</span><span class="item-price-detail">${priceHtml}</span>`;
                    selectedItemsListUl.appendChild(li);
                });
            }
        });
    }

    function showToast(message) {
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function saveState() {
        const state = {
            selectedIds: Array.from(document.querySelectorAll('#service-list input:checked')).map(cb => cb.id),
            isBirthday: isBirthdayPerson.checked,
            isStudent: isStudent.checked
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        showToast('å·²å„²å­˜ç•¶å‰é¸æ“‡ï¼');
    }

    function loadState() {
        const savedState = localStorage.getItem(STORAGE_KEY);
        if (savedState) {
            clearSelections(false);
            const state = JSON.parse(savedState);
            state.selectedIds.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = true;
            });
            isBirthdayPerson.checked = state.isBirthday;
            isStudent.checked = state.isStudent;
            handleInteraction();
            showToast('å·²è¼‰å…¥ä¸Šæ¬¡é¸æ“‡ï¼');
        } else {
            showToast('æ²’æœ‰æ‰¾åˆ°å„²å­˜çš„ç´€éŒ„ã€‚');
        }
    }
    
    function handleInteraction() {
        const result = calculatePrices();
        updateDisplay(result);
    }
    
    function clearSelections(showMsg = true) {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        handleInteraction();
        if (showMsg) showToast('å·²æ¸…é™¤æ‰€æœ‰é¸é …ã€‚');
    }

    // --- å‹•æ…‹ Padding ---
    const observer = new ResizeObserver(entries => {
        for (let entry of entries) {
            const height = entry.contentRect.height;
            document.body.style.paddingBottom = `${height}px`;
        }
    });
    observer.observe(floatingSummary);

    // --- äº‹ä»¶ç›£è½ ---
    serviceListContainer.addEventListener('change', handleInteraction);
isBirthdayPerson.addEventListener('change', handleInteraction);
    isStudent.addEventListener('change', handleInteraction);
    
    summaryBar.addEventListener('click', () => {
        if(floatingSummary.classList.contains('full-expand')) {
            floatingSummary.classList.remove('full-expand');
        }
        floatingSummary.classList.toggle('partial-expand');
    });

    fullscreenToggleBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        floatingSummary.classList.toggle('full-expand');
    });
    
    saveBtn.addEventListener('click', saveState);
    loadBtn.addEventListener('click', loadState);
    clearBtn.addEventListener('click', () => clearSelections(true));

    // --- åˆå§‹è¼‰å…¥ ---
    renderServices();
    handleInteraction();
});
</script>
</body>
</html>

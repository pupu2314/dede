<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>德德工作室服務消費計算器</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 20px 20px 0 20px; /* 移除底部 margin */
            line-height: 1.6;
            background-color: #f4f4f9;
            color: #333;
            padding-bottom: 120px; /* 增加底部空間，防止內容被懸浮窗遮擋 */
        }
        .container {
            max-width: 800px;
            margin: auto;
            padding: 20px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h2, h3 {
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            color: #0056b3;
        }
        fieldset {
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 20px;
            padding: 15px;
        }
        legend {
            font-weight: bold;
            color: #333;
            padding: 0 10px;
        }
        .service-item {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }
        .service-item input[type="checkbox"] {
            margin-right: 10px;
        }
        .service-item label {
            font-weight: normal;
        }
        .price-info {
            margin-left: auto;
            text-align: right;
        }
        .promotion-price {
            color: #dc3545;
            font-weight: bold;
        }
        .original-price {
            text-decoration: line-through;
            color: #999;
            font-size: 0.9em;
            margin-left: 5px;
        }
        #clear-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            margin-bottom: 20px;
        }
        #clear-btn:hover {
            background-color: #5a6268;
        }

        /* --- 懸浮視窗樣式 --- */
        #floating-summary {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #fff;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column-reverse; /* 讓 bar 在 detail 下面 */
        }
        #summary-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            cursor: pointer;
            border-top: 1px solid #eee;
        }
        #toggle-details {
            display: flex;
            align-items: center;
            font-weight: bold;
            color: #007bff;
        }
        .arrow {
            display: inline-block;
            margin-left: 8px;
            transition: transform 0.3s ease-in-out;
        }
        #floating-summary.expanded .arrow {
            transform: rotate(180deg);
        }
        #summary-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
            padding: 0 20px;
        }
        #floating-summary.expanded #summary-details {
            max-height: 50vh; /* 展開高度最多為視窗的一半 */
            overflow-y: auto;
            padding: 15px 20px;
        }
        #floating-selected-items-list ul {
            list-style: none;
            padding: 0;
        }
        #floating-selected-items-list li {
            padding: 8px 0;
            border-bottom: 1px dotted #eee;
            display: flex;
            justify-content: space-between;
        }
        .item-name {
            flex-grow: 1;
        }
        .item-price-detail {
            white-space: nowrap;
            margin-left: 15px;
        }
        .final-totals {
            text-align: right;
        }
        .final-totals p {
            font-size: 0.9em;
            font-weight: bold;
            margin: 2px 0;
        }
        .final-totals #floating-discounted-total {
            color: #dc3545;
            font-size: 1.2em;
        }
        .discount-note {
             color: #28a745;
             font-weight: bold;
             font-size: 0.8em;
        }

    </style>
</head>
<body>

<div class="container">
    <h2>德德工作室服務消費計算器</h2>

    <div id="service-list"></div>
    
    <fieldset>
        <legend>客戶身分</legend>
        <div class="service-item">
            <input type="checkbox" id="isBirthdayPerson">
            <label for="isBirthdayPerson">當月壽星 (原價項目享 5 折)</label>
        </div>
        <div class="service-item">
            <input type="checkbox" id="isStudent">
            <label for="isStudent">學生 (原價項目享 8 折)</label>
        </div>
    </fieldset>

    <button id="clear-btn">清除所有選項</button>

</div>

<div id="floating-summary">
    <div id="summary-bar">
        <div id="toggle-details">
            <span>查看明細</span>
            <span class="arrow">▲</span>
        </div>
        <div class="final-totals">
            <div id="discount-note-container" style="display: none;">
                <span class="discount-note"></span>
            </div>
            <p>原始總金額：<span id="floating-original-total">0</span> 元</p>
            <p>折扣後總金額：<span id="floating-discounted-total">0</span> 元</p>
        </div>
    </div>
    <div id="summary-details">
        <h3>消費明細</h3>
        <div id="floating-selected-items-list">
            <ul></ul>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const serviceData = {
        categories: [
            {
                name: '男士專屬除毛',
                items: [
                    { id: 'private_full', name: '私密處除毛 (全除)', price: 1900 },
                    { id: 'nose', name: '鼻毛', price: 200 },
                    { id: 'private_shape', name: '私密處除毛 (局部/造型)', price: 1900 },
                    { id: 'private_trim', name: '私密處毛修剪-一般修剪無痛(修剪+沐浴)', price: 300 },
                    { id: 'belly_lower', name: '三角處(下腹毛以下,根部以上)', price: 800 },
                    { id: 'armpit', name: '腋下毛', price: 600 },
                    { id: 'belly_upper', name: '上腹部毛(肚臍以上胸部以下)', price: 600 },
                    { id: 'belly_middle', name: '下腹部毛(肚臍以下陰毛以上)', price: 600 },
                    { id: 'arm_half', name: '半手臂', price: 1600 },
                    { id: 'arm_full', name: '全手臂', price: 3000 },
                    { id: 'finger', name: '手指', price: 300 },
                    { id: 'hand_back', name: '手背', price: 300 },
                    { id: 'toe', name: '腳趾', price: 300 },
                    { id: 'foot_back', name: '腳背', price: 300 },
                    { id: 'leg_calf', name: '小腿', price: 1900 },
                    { id: 'leg_thigh', name: '大腿', price: 1900 },
                    { id: 'leg_full', name: '全腿', price: 3500, promoPrice: 3000 },
                    { id: 'nipple', name: '奶頭毛', price: 200 },
                    { id: 'chest', name: '胸毛', price: 600 },
                    { id: 'private_area', name: '區域單獨除毛', price: 600 },
                    { id: 'beard', name: '鬍子熱蠟除毛(八字鬍與下巴)', price: 1000, promoPrice: 900 },
                //  { id: 'health_check', name: '健康檢測(公益免費)', price: 0 },
                    { id: 'private_combo_part', name: '私密處單一區域任選2部位', price: 1200, promoPrice: 1000 }
                ]
            },
            {
                name: '男士專屬油壓',
                items: [
                    { id: 'oil_massage_1hr', name: '[油推]能量精油 健康調理 /1hr(含機能保養)', price: 1200 },
                //  { id: 'oil_massage_1.5hr_home', name: '(到府)[油推]天然植粹能量精油 氣脈健康調理 /1.5hr', price: 3000 },
                //  { id: 'oil_massage_1hr_home', name: '(到府)[油推]天然植粹能量精油 氣脈健康調理 /1hr', price: 2000 },
                //  { id: 'oil_massage_double', name: '[油推]雙人四手能量精油健康調理 /1hr(請聯繫客服)', price: 2200 },
                    { id: 'oil_massage_1.5hr', name: '[油推]能量精油健康調理 /1.5hr(含機能保養)', price: 1800, promoPrice: 1500 }
                ]
            },
            {
                name: '男士專屬指壓',
                items: [
                    { id: 'acupressure_1hr', name: '[指壓]能量健康調理 /1hr', price: 1000 },
                    { id: 'acupressure_1.5hr', name: '[指壓]能量健康調理 /1.5hr', price: 1500 }
                ]
            },
            {
                name: '男士專屬筋膜刀體雕',
                items: [
                    { id: 'fascia_knife_1hr', name: '筋膜刀體雕 氣脈健康調理 /1hr', price: 1600 },
                    { id: 'fascia_knife_1.5hr', name: '筋膜刀體雕 氣脈健康調理 /1.5hr', price: 2200 }
                ]
            },
            {
                name: '男士專屬SPA',
                items: [
                    { id: 'spa_face', name: '【臉部】更新油美白煥膚萬年礦泥臉部肌膚調理 /1hr', price: 1800 },
                    { id: 'spa_private', name: '【私密處】更新油美白換膚萬年礦泥 屁股+私密處 肌膚調理 /1hr', price: 2200, promoPrice: 1800 },
                    { id: 'spa_body', name: '【全身】更新油全身深層敷體淨化 /1.5hr', price: 3000, promoPrice: 2600 }
                ]
            }
        ],
        combos: [
            {
                id: 'combo_private_armpit',
                name: '私密處全除 + 腋下毛 組合優惠',
                itemIds: ['private_full', 'armpit'],
                price: 2200
            }
        ]
    };

    const allServices = new Map(serviceData.categories.flatMap(cat => cat.items).map(item => [item.id, item]));
    
    // 更新 DOM 元素選擇器
    const serviceListContainer = document.getElementById('service-list');
    const isBirthdayPerson = document.getElementById('isBirthdayPerson');
    const isStudent = document.getElementById('isStudent');
    const clearBtn = document.getElementById('clear-btn');
    
    const floatingSummary = document.getElementById('floating-summary');
    const summaryBar = document.getElementById('summary-bar');
    const originalTotalSpan = document.getElementById('floating-original-total');
    const discountedTotalSpan = document.getElementById('floating-discounted-total');
    const selectedItemsListUl = document.querySelector('#floating-selected-items-list ul');
    const discountNoteContainer = document.getElementById('discount-note-container');
    const discountNoteSpan = discountNoteContainer.querySelector('.discount-note');

    function renderServices() {
        serviceData.categories.forEach(category => {
            const fieldset = document.createElement('fieldset');
            const legend = document.createElement('legend');
            legend.textContent = category.name;
            fieldset.appendChild(legend);

            category.items.forEach(service => {
                const div = document.createElement('div');
                div.className = 'service-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = service.id;
                checkbox.value = service.id;

                const label = document.createElement('label');
                label.htmlFor = service.id;
                label.textContent = service.name;

                const priceDiv = document.createElement('div');
                priceDiv.className = 'price-info';
                
                if (service.promoPrice !== undefined) {
                    priceDiv.innerHTML = `<span class="promotion-price">$${service.promoPrice.toLocaleString()}</span> <span class="original-price">$${service.price.toLocaleString()}</span>`;
                } else {
                    priceDiv.innerHTML = `<span>$${service.price.toLocaleString()}</span>`;
                }
                
                div.appendChild(checkbox);
                div.appendChild(label);
                div.appendChild(priceDiv);
                fieldset.appendChild(div);
            });
            serviceListContainer.appendChild(fieldset);
        });
    }

    function calculatePrices() {
        const selectedIds = new Set(Array.from(document.querySelectorAll('#service-list input:checked')).map(cb => cb.value));
        
        let originalTotal = 0;
        let promoTotal = 0;
        const processedIds = new Set();
        const displayItems = [];

        serviceData.combos.forEach(combo => {
            const isComboMatch = combo.itemIds.every(id => selectedIds.has(id));
            if (isComboMatch) {
                const comboOriginalPrice = combo.itemIds.reduce((sum, id) => sum + allServices.get(id).price, 0);
                originalTotal += comboOriginalPrice;
                promoTotal += combo.price;
                displayItems.push({
                    type: 'combo',
                    comboInfo: combo,
                    originalPrice: comboOriginalPrice
                });
                combo.itemIds.forEach(id => processedIds.add(id));
            }
        });

        selectedIds.forEach(id => {
            if (!processedIds.has(id)) {
                const service = allServices.get(id);
                if (service) {
                    originalTotal += service.price;
                    promoTotal += service.promoPrice ?? service.price;
                    displayItems.push({
                        type: 'service',
                        serviceInfo: service
                    });
                }
            }
        });

        let finalPrice = promoTotal;
        let discountType = '促銷/組合價';
        if (displayItems.length === 0) discountType = '無';

        const birthdayDiscount = originalTotal * 0.5;
        const studentDiscount = originalTotal * 0.8;

        if (isBirthdayPerson.checked && birthdayDiscount < finalPrice) {
            finalPrice = birthdayDiscount;
            discountType = '壽星原價 5 折';
        }
        
        if (isStudent.checked && studentDiscount < finalPrice) {
            finalPrice = studentDiscount;
            discountType = '學生原價 8 折';
        }

        return {
            originalTotal: Math.round(originalTotal),
            finalTotal: Math.round(finalPrice),
            appliedDiscount: discountType,
            displayItems: displayItems
        };
    }
    
    function updateDisplay(result) {
        originalTotalSpan.textContent = result.originalTotal.toLocaleString();
        discountedTotalSpan.textContent = result.finalTotal.toLocaleString();
        
        if (result.appliedDiscount !== '無' && result.finalTotal < result.originalTotal) {
            discountNoteSpan.textContent = `已套用最優惠折扣: ${result.appliedDiscount}`;
            discountNoteContainer.style.display = 'block';
        } else {
            discountNoteContainer.style.display = 'none';
        }
        
        selectedItemsListUl.innerHTML = '';
        const isIdentityDiscount = result.appliedDiscount === '壽星原價 5 折' || result.appliedDiscount === '學生原價 8 折';

        result.displayItems.forEach(item => {
            if (item.type === 'combo' && !isIdentityDiscount) {
                const li = document.createElement('li');
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'item-name';
                nameSpan.textContent = item.comboInfo.name;

                const priceSpan = document.createElement('span');
                priceSpan.className = 'item-price-detail';
                priceSpan.innerHTML = `<span class="promotion-price">$${item.comboInfo.price.toLocaleString()}</span> <span class="original-price">$${item.originalPrice.toLocaleString()}</span>`;

                li.appendChild(nameSpan);
                li.appendChild(priceSpan);
                selectedItemsListUl.appendChild(li);
            } else {
                let servicesToRender = [];
                if (item.type === 'service') {
                    servicesToRender.push(item.serviceInfo);
                } else { 
                    servicesToRender = item.comboInfo.itemIds.map(id => allServices.get(id));
                }

                servicesToRender.forEach(service => {
                    const li = document.createElement('li');
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'item-name';
                    nameSpan.textContent = service.name;

                    const priceSpan = document.createElement('span');
                    priceSpan.className = 'item-price-detail';

                    if (isIdentityDiscount) {
                        priceSpan.innerHTML = `<span>$${service.price.toLocaleString()}</span>`;
                    } else {
                        if (service.promoPrice !== undefined) {
                            priceSpan.innerHTML = `<span class="promotion-price">$${service.promoPrice.toLocaleString()}</span> <span class="original-price">$${service.price.toLocaleString()}</span>`;
                        } else {
                            priceSpan.innerHTML = `<span>$${service.price.toLocaleString()}</span>`;
                        }
                    }
                    
                    li.appendChild(nameSpan);
                    li.appendChild(priceSpan);
                    selectedItemsListUl.appendChild(li);
                });
            }
        });
    }

    function handleInteraction() {
        const result = calculatePrices();
        updateDisplay(result);
    }
    
    function clearSelections() {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        handleInteraction();
    }

    // --- 事件監聽 ---
    serviceListContainer.addEventListener('change', handleInteraction);
    isBirthdayPerson.addEventListener('change', handleInteraction);
    isStudent.addEventListener('change', handleInteraction);
    clearBtn.addEventListener('click', clearSelections);

    // 懸浮視窗的點擊事件
    summaryBar.addEventListener('click', () => {
        floatingSummary.classList.toggle('expanded');
    });

    // 初始載入
    renderServices();
    handleInteraction();
});
</script>
</body>
</html>



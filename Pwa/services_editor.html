<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服務資料編輯器</title>
    <link rel="stylesheet" href="dede.css">
    <style>
        /* Editor-specific styles */
        :root { --toast-height: 50px; }
        body { padding-bottom: 120px; }
        .container { max-width: 1000px; }
        h1, h2 { text-align: center; }
        h3 { font-size: 1.2em; font-weight: bold; color: #333; margin-top: 1.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem; }
        .btn { display: inline-block; width: auto; padding: 10px 15px; border-radius: 5px; font-weight: bold; text-align: center; cursor: pointer; border: none; color: #fff; background-color: #007bff; transition: background-color 0.2s; font-size: 0.9em; margin-top: 5px; box-sizing: border-box; }
        .btn.btn-block { width: 100%; }
        .btn.btn-sm { padding: 5px 10px; font-size: 0.8em; }
        .btn.btn-danger { background-color: #dc3545; }
        .btn.btn-danger:hover { background-color: #c82333; }
        .btn.btn-secondary { background-color: #6c757d; }
        .btn.btn-secondary:hover { background-color: #5a6268; }
        .btn:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        
        /* Table Styles for Desktop */
        .table-view { display: none; }
        @media (min-width: 768px) {
            .table-view { display: table; width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
            .table-view th, .table-view td { border: 1px solid #dee2e6; padding: 12px; text-align: left; vertical-align: middle; }
            .table-view thead { background-color: #e9ecef; }
            .original-view { display: none; }
        }
        
        .detailed-edit-input { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .original-view .detailed-edit-group { margin-bottom: 10px; }
        .original-view .detailed-edit-group label { font-weight: normal; font-size: 0.9em; }

        .promo-item, .combo-item-display { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 8px; margin-top: 8px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .actions-group { display: flex; gap: 8px; flex-shrink: 0; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.top-level { z-index: 1010; }
        .modal-content { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 600px; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dee2e6; padding-bottom: 15px; margin-bottom: 15px; }
        .modal-header h4 { margin: 0; color: #0056b3; }
        .modal-body { flex-grow: 1; overflow-y: auto; }
        .modal-body .form-group { margin-bottom: 15px; }
        .modal-body .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .modal-body .form-group input, .modal-body .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .modal-footer { flex-shrink: 0; display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .modal-error, .promo-calculation { color: #dc3545; margin-top: 10px; font-size: 0.9em; font-weight: bold; }
        .promo-calculation { color: #28a745; }
        .promo-calculation.strong-discount { color: #ffc107; }
        #changes-list { list-style-type: disc; padding-left: 20px; background: #f8f9fa; border: 1px solid #eee; padding: 10px; border-radius: 4px; max-height: 40vh; overflow-y: auto; }
        #changes-list li { margin-bottom: 5px; }
        select[multiple] { height: 200px; }

        .bottom-actions { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .bottom-actions .container { display: flex; gap: 15px; padding: 0; }

        .detailed-edit-toggle { background-color: #f0f0f0; padding: 15px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #ddd; }
        
        .original-view .item { border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .original-view .item-header { font-weight: bold; margin-bottom: 10px; }

    </style>
    <script src="https://unpkg.com/vue@2"></script>
</head>
<body>

<div id="app" class="container">
    <h1>服務資料編輯器</h1>

    <div class="detailed-edit-toggle">
        <label><input type="checkbox" v-model="detailedEditEnabled" @change="handleDirtyState"> <strong>啟用服務項目詳細編輯 (ID、名稱、價格)</strong></label>
    </div>

    <!-- 服務項目編輯區塊 -->
    <div v-for="(category, ci) in data.categories" :key="'cat-table-'+ci">
        <h3>{{ category.name }}</h3>
        <table class="table-view">
            <thead>
                <tr>
                    <th v-if="detailedEditEnabled">ID</th>
                    <th>項目名稱</th>
                    <th style="width: 15%;">原價</th>
                    <th>優惠活動</th>
                    <th style="width: 15%;">操作</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(item, ii) in category.items" :key="item.id">
                    <td v-if="detailedEditEnabled"><input type="text" v-model="item.id" class="detailed-edit-input"></td>
                    <td><input v-if="detailedEditEnabled" type="text" v-model="item.name" class="detailed-edit-input"><span v-else>{{ item.name }}</span></td>
                    <td style="text-align: right;"><input v-if="detailedEditEnabled" type="number" v-model.number="item.price" class="detailed-edit-input"><span v-else>{{ item.price.toLocaleString() }}</span></td>
                    <td>
                        <div v-if="!item.promotions || item.promotions.length === 0" style="color: #6c757d;">無</div>
                        <div v-for="(promo, pi) in item.promotions" class="promo-item" :key="'promo-'+ii+'-'+pi">
                           <div><strong>{{ promo.label }}</strong>: ${{ promo.price.toLocaleString() }} <br><small>{{ promo.start }} ~ {{ promo.end }}</small></div>
                           <div class="actions-group"><button @click="openModal(item, pi)" class="btn btn-secondary btn-sm">編輯</button><button @click="removePromotion(item, pi)" class="btn btn-danger btn-sm">刪除</button></div>
                        </div>
                    </td>
                    <td><button @click="openModal(item, -1)" class="btn btn-sm">新增優惠</button><button v-if="detailedEditEnabled" @click="deleteItem(category, ii)" class="btn btn-danger btn-sm">刪除項目</button></td>
                </tr>
            </tbody>
        </table>
        <div class="original-view">
            <div v-for="(item, ii) in category.items" class="item" :key="'item-orig-'+ii">
                <div v-if="!detailedEditEnabled">
                    <div class="item-header">{{ item.name }} (原價: {{ item.price }})</div>
                </div>
                <div v-else>
                    <div class="detailed-edit-group"><label>ID</label><input type="text" v-model="item.id" class="detailed-edit-input"></div>
                    <div class="detailed-edit-group"><label>名稱</label><input type="text" v-model="item.name" class="detailed-edit-input"></div>
                    <div class="detailed-edit-group"><label>價格</label><input type="number" v-model.number="item.price" class="detailed-edit-input"></div>
                </div>

                <div v-for="(promo, pi) in item.promotions" class="promo-item" :key="'promo-orig-'+ii+'-'+pi">
                     <div><strong>{{ promo.label }}</strong>: ${{ promo.price }}<br><small>{{ promo.start }} ~ {{ promo.end }}</small></div>
                     <div class="actions-group"><button @click="openModal(item, pi)" class="btn btn-secondary btn-sm">編輯</button><button @click="removePromotion(item, pi)" class="btn btn-danger btn-sm">刪除</button></div>
                </div>
                <button @click="openModal(item, -1)" class="btn btn-sm">新增優惠</button>
                <button v-if="detailedEditEnabled" @click="deleteItem(category, ii)" class="btn btn-danger btn-sm">刪除項目</button>
            </div>
        </div>
    </div>

    <!-- 組合優惠編輯區塊 -->
    <h2>組合優惠編輯</h2>
    <div v-if="!data.combos || data.combos.length === 0" style="color: #6c757d; text-align: center; padding: 20px;">目前沒有組合優惠</div>
    <div v-for="(combo, cbi) in data.combos" :key="'combo-'+cbi" class="combo-item-display">
        <div><strong>{{ combo.name }}</strong> ({{ combo.itemIds.length }}個項目)<br><small>原價: {{ calculateComboOriginalPrice(combo).toLocaleString() }}</small></div>
        <div class="actions-group"><button @click="openComboModal(cbi)" class="btn btn-secondary btn-sm">編輯</button><button @click="deleteCombo(cbi)" class="btn btn-danger btn-sm">刪除</button></div>
    </div>
    <button @click="openComboModal(-1)" class="btn">新增組合優惠</button>
    

    <!-- 單項/組合 優惠編輯 Modal -->
    <div v-if="isModalVisible" class="modal-overlay" :class="{ 'top-level': isEditingComboPromo }">
         <div class="modal-content">
            <div class="modal-header"><h4>{{ modalTitle }}</h4><button @click="closeModal" style="background:none; border:none; font-size: 1.5rem; cursor:pointer;">&times;</button></div>
            <div class="modal-body">
                <p><strong>項目:</strong> {{ currentItem.name }} (原價: {{ (currentItem.price || calculateComboOriginalPrice(currentItem)).toLocaleString() }})</p>
                <div class="form-group"><label>活動標籤</label><input type="text" v-model="currentPromotion.label" placeholder="例如：新優惠"></div>
                <div class="form-group"><label>優惠價</label><input type="number" v-model.number="currentPromotion.price" @input="calculateDiscount"><div v-if="promoCalculationText" :class="['promo-calculation', { 'strong-discount': isStrongDiscount }]">{{ promoCalculationText }}</div></div>
                <div class="form-group"><label>開始/結束日期</label><div style="display: flex; gap: 10px;"><input type="date" v-model="currentPromotion.start" style="flex: 1;"><input type="date" v-model="currentPromotion.end" style="flex: 1;"></div><div style="display: flex; gap: 10px; margin-top: 10px;"><button @click="setThisMonth" class="btn btn-sm btn-secondary">設為本月</button><button @click="setNextMonth" class="btn btn-sm btn-secondary">設為次月</button></div></div>
                <p v-if="modalError" class="modal-error">{{ modalError }}</p>
            </div>
            <div class="modal-footer"><button @click="closeModal" class="btn btn-secondary">取消</button><button @click="savePromotion" class="btn">儲存</button></div>
        </div>
    </div>
    <!-- 組合優惠主體編輯 Modal -->
    <div v-if="isComboModalVisible" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h4>編輯組合優惠</h4><button @click="closeComboModal" style="background:none; border:none; font-size: 1.5rem; cursor:pointer;">&times;</button></div>
            <div class="modal-body">
                <div class="form-group">
                    <label>組合名稱</label>
                    <input type="text" v-model="currentCombo.name">
                    <small v-if="suggestedComboName" style="display: block; margin-top: 5px; color: #6c757d;">建議名稱: {{ suggestedComboName }}</small>
                </div>
                <div class="form-group"><label>包含的服務項目 (原價合計: {{ calculateComboOriginalPrice(currentCombo).toLocaleString() }})</label><select multiple v-model="currentCombo.itemIds"><option v-for="item in allItems" :value="item.id">{{ item.name }}</option></select></div>
                <hr>
                <label style="font-weight: bold;">組合專屬優惠</label>
                <div v-if="!currentCombo.promotions || currentCombo.promotions.length === 0" style="color: #6c757d; margin-top: 10px;">無</div>
                <div v-for="(promo, pi) in currentCombo.promotions" class="promo-item" :key="'combo-promo-'+pi">
                    <div><strong>{{ promo.label }}</strong>: ${{ promo.price.toLocaleString() }} <br><small>{{ promo.start }} ~ {{ promo.end }}</small></div>
                    <div class="actions-group"><button @click="openModal(currentCombo, pi, true)" class="btn btn-secondary btn-sm">編輯</button><button @click="removePromotion(currentCombo, pi)" class="btn btn-danger btn-sm">刪除</button></div>
                </div>
                 <button @click="openModal(currentCombo, -1, true)" class="btn btn-sm" style="margin-top:10px;">新增組合優惠</button>
            </div>
            <div class="modal-footer"><button @click="closeComboModal" class="btn btn-secondary">關閉</button><button @click="saveCombo" class="btn">儲存組合</button></div>
        </div>
    </div>
    <!-- 變更確認 Modal -->
     <div v-if="isChangesModalVisible" class="modal-overlay top-level">
        <div class="modal-content">
            <div class="modal-header"><h4>變更確認</h4><button @click="isChangesModalVisible=false" style="background:none; border:none; font-size: 1.5rem; cursor:pointer;">&times;</button></div>
            <div class="modal-body"><p>請確認以下變更項目：</p><ul id="changes-list"><li v-for="change in changesList" v-html="change"></li></ul></div>
            <div class="modal-footer"><button @click="isChangesModalVisible=false" class="btn btn-secondary">關閉視窗</button><button @click="copyJson()" class="btn">複製JSON</button></div>
        </div>
    </div>


    <!-- 底部操作按鈕 -->
    <div class="bottom-actions">
        <div class="container">
            <button @click="discardAndReload" class="btn btn-secondary btn-block">放棄暫存並重載</button>
            <button @click="openChangesModal" :disabled="!isDirty" class="btn btn-block">產生JSON</button>
        </div>
    </div>
</div>

<script>
    new Vue({
        el: '#app',
        data: {
            data: { categories: [], combos: [] },
            originalData: null,
            isDirty: false,
            initialLoadComplete: false,
            detailedEditEnabled: false,
            isModalVisible: false,
            modalTitle: '',
            currentItem: null,
            currentPromotion: {},
            originalPromotionState: '',
            editingPromoIndex: -1,
            modalError: '',
            promoCalculationText: '',
            isStrongDiscount: false,
            isComboModalVisible: false,
            currentCombo: { name: '', itemIds: [], promotions: [] },
            originalComboState: '',
            editingComboIndex: -1,
            isChangesModalVisible: false,
            changesList: [],
            isEditingComboPromo: false
        },
        computed: {
            allItems: function() {
                return (this.data.categories || []).flatMap(cat => cat.items || []);
            },
            suggestedComboName: function() {
                if (!this.isComboModalVisible || !this.currentCombo.itemIds || this.currentCombo.itemIds.length === 0) {
                    return '';
                }
                const selectedNames = this.currentCombo.itemIds.map(id => {
                    const item = this.allItems.find(i => i.id === id);
                    return item ? item.name : '';
                }).filter(name => name);
                if (selectedNames.length > 0) {
                    return selectedNames.join(' + ') + ' 組合優惠';
                }
                return '';
            }
        },
        watch: {
            data: {
                handler: function() {
                    if (this.initialLoadComplete) {
                        localStorage.setItem('autosavedData', JSON.stringify(this.data));
                        this.handleDirtyState();
                    }
                },
                deep: true
            }
        },
        methods: {
            handleDirtyState: function() {
                this.isDirty = JSON.stringify(this.data) !== JSON.stringify(this.originalData);
            },
            // --- 組合優惠方法 ---
            openComboModal: function(index) {
                this.editingComboIndex = index;
                if (index === -1) {
                    this.currentCombo = { name: '', itemIds: [], promotions: [] };
                } else {
                    this.currentCombo = JSON.parse(JSON.stringify(this.data.combos[index]));
                }
                this.originalComboState = JSON.stringify(this.currentCombo);
                this.isComboModalVisible = true;
            },
            closeComboModal: function() {
                if (this.originalComboState !== JSON.stringify(this.currentCombo)) {
                    if (!confirm('組合資料已被修改，確定要放棄嗎？')) {
                        return;
                    }
                }
                this.isComboModalVisible = false;
            },
            saveCombo: function() {
                if (!this.currentCombo.name.trim()) { alert('組合名稱不可為空'); return; }
                if (this.currentCombo.itemIds.length < 2) { alert('組合至少需包含 2 個服務項目'); return; }

                if (this.editingComboIndex === -1) {
                    if (!this.data.combos) this.$set(this.data, 'combos', []);
                    this.data.combos.push(this.currentCombo);
                } else {
                    this.$set(this.data.combos, this.editingComboIndex, this.currentCombo);
                }
                this.isComboModalVisible = false;
            },
            deleteCombo: function(index) {
                if (confirm('確定要刪除「' + this.data.combos[index].name + '」這個組合嗎？')) {
                    this.data.combos.splice(index, 1);
                }
            },
            calculateComboOriginalPrice: function(combo) {
                if (!combo || !combo.itemIds) return 0;
                return combo.itemIds.reduce((sum, id) => {
                    const item = this.allItems.find(i => i.id === id);
                    return sum + (item ? item.price : 0);
                }, 0);
            },
            
            // --- 全新變更提交流程 ---
            openChangesModal: function() {
                this.generateChangesList();
                if (this.changesList.length === 0) {
                    this.showToast('沒有偵測到任何變更。');
                    this.isDirty = false; // Reset dirty state if no changes found
                    return;
                }
                this.isChangesModalVisible = true;
            },
            generateChangesList: function() {
                let changes = [];
                const originalItemsMap = new Map((this.originalData.categories || []).flatMap(c => c.items).map(i => [i.id, i]));
                const currentItemsMap = new Map((this.data.categories || []).flatMap(c => c.items).map(i => [i.id, i]));
                const originalCombosMap = new Map((this.originalData.combos || []).map(c => [c.name, c]));
                const currentCombosMap = new Map((this.data.combos || []).map(c => [c.name, c]));

                const getPromoChangeString = (currentPromo, originalPromo, parentName, originalParentPrice) => {
                    if (!originalPromo) {
                        let detail = `為 '<b>${parentName}</b>' 新增優惠 '<b>${currentPromo.label}</b>' (價格: ${currentPromo.price}, 期間: ${currentPromo.start} ~ ${currentPromo.end})`;
                        if (originalParentPrice > 0 && (currentPromo.price / originalParentPrice) < 0.8) {
                            detail += ` <span style="color:red; font-weight:bold;">【注意】此促銷低於八折優惠！</span>`;
                        }
                        return detail;
                    }
                    let promoChanges = [];
                    if (currentPromo.price !== originalPromo.price) promoChanges.push(`價格: ${originalPromo.price} -> <b>${currentPromo.price}</b>`);
                    if (currentPromo.start !== originalPromo.start) promoChanges.push(`開始日期: ${originalPromo.start} -> <b>${currentPromo.start}</b>`);
                    if (currentPromo.end !== originalPromo.end) promoChanges.push(`結束日期: ${originalPromo.end} -> <b>${currentPromo.end}</b>`);
                    if (promoChanges.length > 0) return `修改了 '<b>${parentName}</b>' 的優惠 '<b>${currentPromo.label}</b>' (${promoChanges.join(', ')})`;
                    return null;
                };

                currentItemsMap.forEach((currentItem, id) => {
                    const originalItem = originalItemsMap.get(id);
                    if (!originalItem) {
                        changes.push(`新增項目：<b>${currentItem.name}</b>`);
                    } else {
                        if (currentItem.name !== originalItem.name) changes.push(`項目 '<b>${originalItem.name}</b>' 更名為 '<b>${currentItem.name}</b>'`);
                        if (currentItem.price !== originalItem.price) changes.push(`項目 '<b>${currentItem.name}</b>' 價格由 <b>${originalItem.price}</b> 改為 <b>${currentItem.price}</b>`);
                        
                        const originalPromosMap = new Map((originalItem.promotions || []).map(p => [p.label, p]));
                        (currentItem.promotions || []).forEach(p => {
                            const changeStr = getPromoChangeString(p, originalPromosMap.get(p.label), currentItem.name, originalItem.price);
                            if (changeStr) changes.push(changeStr);
                        });
                        originalPromosMap.forEach((p, label) => {
                           if (!(currentItem.promotions || []).find(cp => cp.label === label)) changes.push(`刪除了 '<b>${currentItem.name}</b>' 的優惠 '<b>${label}</b>'`);
                        });
                    }
                });
                originalItemsMap.forEach((originalItem, id) => {
                    if (!currentItemsMap.has(id)) changes.push(`刪除項目：<b>${originalItem.name}</b>`);
                });

                currentCombosMap.forEach((currentCombo, name) => {
                    const originalCombo = originalCombosMap.get(name);
                    if (!originalCombo) {
                        changes.push(`新增組合：<b>${name}</b>`);
                    } else {
                        const originalIds = [...originalCombo.itemIds].sort().join(',');
                        const currentIds = [...currentCombo.itemIds].sort().join(',');
                        if(originalIds !== currentIds) changes.push(`修改了組合 '<b>${name}</b>' 的包含項目`);
                        
                        const originalPromosMap = new Map((originalCombo.promotions || []).map(p => [p.label, p]));
                        (currentCombo.promotions || []).forEach(p => {
                            const changeStr = getPromoChangeString(p, originalPromosMap.get(p.label), currentCombo.name, this.calculateComboOriginalPrice(originalCombo));
                            if (changeStr) changes.push(changeStr);
                        });
                        originalPromosMap.forEach((p, label) => {
                           if (!(currentCombo.promotions || []).find(cp => cp.label === label)) changes.push(`刪除了組合 '<b>${name}</b>' 的優惠 '<b>${label}</b>'`);
                        });
                    }
                });
                originalCombosMap.forEach((originalCombo, name) => {
                    if (!currentCombosMap.has(name)) changes.push(`刪除組合：<b>${originalCombo.name}</b>`);
                });

                this.changesList = changes;
            },

            copyJson: function() {
                var outputData = JSON.parse(JSON.stringify(this.data));
                (outputData.categories || []).forEach(cat => (cat.items || []).forEach(item => { if (item.promotions && item.promotions.length === 0) delete item.promotions; }));
                (outputData.combos || []).forEach(combo => { if (combo.promotions && combo.promotions.length === 0) delete combo.promotions; });
                var jsonString = JSON.stringify(outputData, null, 2);
                 navigator.clipboard.writeText(jsonString).then(() => {
                    this.showToast('JSON 已複製到剪貼簿，請傳送給管理者更新伺服器資料才會生效。');
                    if(this.isChangesModalVisible) this.isChangesModalVisible = false;
                    this.originalData = JSON.parse(JSON.stringify(this.data));
                    this.handleDirtyState();
                }, () => {
                    alert('複製失敗!');
                });
            },
            loadDataFromServer: async function() {
                try {
                    var response = await fetch('services.json?t=' + new Date().getTime());
                    const data = await response.json();
                    this.data = JSON.parse(JSON.stringify(data));
                    this.originalData = JSON.parse(JSON.stringify(data));
                    this.handleDirtyState();
                } catch (error) {
                    alert('無法載入資料!');
                } finally {
                    this.initialLoadComplete = true;
                }
            },
            discardAndReload: function() {
                 if (this.isDirty && !confirm('您確定要放棄所有未儲存的變更嗎？')) {
                    return;
                }
                localStorage.removeItem('autosavedData');
                this.loadDataFromServer().then(() => {
                     this.showToast('已從伺服器重新載入資料。');
                });
            },

            openModal: function(itemOrCombo, promoIndex, isCombo = false) {
                this.isEditingComboPromo = isCombo;
                this.currentItem = itemOrCombo;
                this.editingPromoIndex = promoIndex;
                this.modalError = '';
                if (promoIndex === -1) {
                    this.modalTitle = isCombo ? '新增組合優惠' : '新增優惠';
                    this.currentPromotion = { label: '新優惠', price: null, start: '', end: '' };
                } else {
                    this.modalTitle = isCombo ? '編輯組合優惠' : '編輯優惠';
                    this.currentPromotion = JSON.parse(JSON.stringify(itemOrCombo.promotions[promoIndex]));
                }
                this.originalPromotionState = JSON.stringify(this.currentPromotion);
                this.calculateDiscount();
                this.isModalVisible = true;
            },
             closeModal: function() {
                 if (this.originalPromotionState !== JSON.stringify(this.currentPromotion)) {
                    if (!confirm('您有未儲存的變更，確定要放棄嗎？')) {
                        return;
                    }
                }
                this.isModalVisible = false;
                this.currentItem = null;
                this.promoCalculationText = '';
            },
            setThisMonth: function() {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                this.currentPromotion.start = this.formatDate(firstDay);
                this.currentPromotion.end = this.formatDate(lastDay);
                if (this.currentPromotion.label === '新優惠') {
                    this.currentPromotion.label = `${month + 1}月優惠`;
                }
            },
            setNextMonth: function() {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                const firstDay = new Date(year, month + 1, 1);
                const lastDay = new Date(year, month + 2, 0);
                this.currentPromotion.start = this.formatDate(firstDay);
                this.currentPromotion.end = this.formatDate(lastDay);
                if (this.currentPromotion.label === '新優惠') {
                    this.currentPromotion.label = `${firstDay.getMonth() + 1}月優惠`;
                }
            },
            savePromotion: function() {
                this.modalError = '';
                var p = this.currentPromotion;
                var originalPrice = this.currentItem.price || this.calculateComboOriginalPrice(this.currentItem);

                if (!p.start || !p.end) { this.modalError = '錯誤: 開始與結束日期不可為空。'; return; }

                if (this.currentItem.promotions && this.currentItem.promotions.length > 0) {
                    const newStart = new Date(p.start);
                    const newEnd = new Date(p.end);
                    for (let i = 0; i < this.currentItem.promotions.length; i++) {
                        if (i === this.editingPromoIndex) continue;
                        const existingPromo = this.currentItem.promotions[i];
                        const existingStart = new Date(existingPromo.start);
                        const existingEnd = new Date(existingPromo.end);
                        if (newStart <= existingEnd && newEnd >= existingStart) {
                            this.modalError = `錯誤: 優惠期間與現有的 '${existingPromo.label}' 優惠重疊。`;
                            return;
                        }
                    }
                }

                if (!p.label || p.label.trim() === '') { this.modalError = '錯誤: 活動標籤不可為空。'; return; }
                if (typeof p.price !== 'number' || p.price <= 0) { this.modalError = '錯誤: 優惠價需為大於 0 的數字。'; return; }
                if (p.price >= originalPrice) { this.modalError = `錯誤: 優惠價 (${p.price}) 需低於原價 (${originalPrice})。`; return; }
                if (p.start > p.end) { this.modalError = '錯誤: 結束日期不可早於開始日期。'; return; }

                if (!this.currentItem.promotions) {
                    this.$set(this.currentItem, 'promotions', []);
                }
                
                if (this.editingPromoIndex === -1) {
                    this.currentItem.promotions.push(p);
                } else {
                    this.currentItem.promotions.splice(this.editingPromoIndex, 1, p);
                }
                this.isModalVisible = false;
                if(this.isEditingComboPromo) {
                    this.$set(this.data.combos, this.editingComboIndex, this.currentCombo);
                }
            },
             calculateDiscount: function() {
                const promoPrice = this.currentPromotion.price;
                const originalPrice = this.currentItem.price || this.calculateComboOriginalPrice(this.currentItem);
                if (!promoPrice || promoPrice <= 0 || promoPrice >= originalPrice) {
                    this.promoCalculationText = '';
                    return;
                }
                const savings = originalPrice - promoPrice;
                const discountRatio = (promoPrice / originalPrice) * 10;
                this.promoCalculationText = `省 ${savings.toLocaleString()} 元 (約 ${discountRatio.toFixed(1)} 折)`;
                this.isStrongDiscount = discountRatio < 8.0;
                 if (this.isStrongDiscount) {
                    this.promoCalculationText += ' - 低於八折優惠！';
                }
            },
             removePromotion: function(parent, index) {
                if (confirm('確定要刪除這個優惠嗎？')) {
                    parent.promotions.splice(index, 1);
                }
            },
            deleteItem: function(category, itemIndex) {
                if (confirm('您確定要永久刪除這個服務項目嗎？此操作無法復原。')) {
                    category.items.splice(itemIndex, 1);
                }
            },
             showToast: function(message) {
                var toast = document.createElement('div');
                toast.textContent = message;
                toast.style.cssText = 'position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background-color: #333; color: #fff; padding: 10px 20px; border-radius: 5px; z-index: 1010;';
                document.body.appendChild(toast);
                setTimeout(function() { document.body.removeChild(toast); }, 3000);
            },
             formatDate: function(date) {
                const y = date.getFullYear();
                const m = ('0' + (date.getMonth() + 1)).slice(-2);
                const d = ('0' + date.getDate()).slice(-2);
                return `${y}-${m}-${d}`;
            }
        },
        mounted: function() {
            const savedData = localStorage.getItem('autosavedData');
            this.loadDataFromServer().then(() => { 
                if (savedData) {
                    this.data = JSON.parse(savedData);
                    this.showToast('已載入上次未儲存的編輯內容。');
                }
            });
        }
    });
</script>

</body>
</html>

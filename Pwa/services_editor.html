<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服務資料編輯器</title>
    <link rel="stylesheet" href="dede.css">
    <style>
        /* services_editor.html 獨有樣式 */
        .editable-details { display: none; }
        body.detail-edit-mode .editable-details { display: block; }
        .readonly-details p { margin: 0 0 8px 0; color: #555; }
        .readonly-details p strong { color: #333; min-width: 70px; display: inline-block; }
        body.detail-edit-mode .readonly-details { display: none; }
        
        #diff-container { font-family: monospace; white-space: pre-wrap; font-size: 0.9em; }
        .diff-section { border: 1px solid #eee; border-radius: 5px; padding: 10px; margin-bottom: 15px; }
        .diff-title { font-weight: bold; margin-bottom: 5px; color: #0056b3; }
        .diff-title.added { color: #28a745; }
        .diff-title.removed { color: #dc3545; }
        .diff-subtitle { font-weight: bold; margin-top: 10px; margin-bottom: 5px; color: #555; border-bottom: 1px dotted #ccc; padding-bottom: 2px; }
        .diff-line { display: flex; align-items: baseline; }
        .diff-line .label { min-width: 100px; font-weight: bold; color: #666; flex-shrink: 0; }
        .diff-line .change ins { color: #28a745; text-decoration: none; font-weight: bold; }
        .diff-line .change del { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div id="editor-container">
        <div id="storage-toast" class="toast-notification">
            <span>已載入上次未儲存的編輯內容。</span>
            <button id="discard-storage-btn">放棄暫存並重載</button>
        </div>

        <div class="container" style="max-width: 1000px;">
            <h1>服務與促銷編輯器</h1>
            <p class="note">在此頁面編輯服務項目、促銷活動與組合。所有修改都會自動暫存，產生 JSON 前會提供預覽。</p>
            <div style="text-align: center; margin: 20px 0; padding: 10px; background: #f0f0f0; border-radius: 8px;">
                <label style="display: inline-block; cursor: pointer; user-select: none;">
                    <input type="checkbox" id="toggle-edit-mode"> 
                    啟用服務項目詳細編輯 (ID、名稱、價格)
                </label>
            </div>
            <div id="main-container"></div>
            <button type="button" class="btn btn-secondary" id="add-combo-btn">＋ 新增組合優惠</button>
        </div>

        <div class="footer-actions">
            <button type="button" class="btn" id="generate-btn" style="display: none;">產生 JSON</button>
            <button type="button" class="btn btn-secondary" id="copy-btn" style="display: none;">複製 JSON</button>
            <div id="validation-message-container"><pre id="validation-message"></pre></div>
        </div>
        
        <div class="modal-overlay" id="diff-modal-overlay">
            <div class="modal-content">
                <div class="modal-header"><h2>變更確認</h2><button id="modal-close-btn" class="modal-close-btn">&times;</button></div>
                <div id="diff-container"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="modal-cancel-btn">關閉</button>
                    <button type="button" class="btn" id="modal-confirm-btn">確認產生 JSON</button>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // 此頁面獨有的應用程式邏輯
        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                data: null, originalData: null, allServiceItems: [], isDirty: false, generatedJson: '', modifiedPaths: new Set(),
                STORAGE_KEY: 'servicesEditorUnsaved',
                elements: { /* ... 此處為所有 getElementById 的宣告 ... */ },

                init: async function() {
                    this.addEventListeners();
                    try {
                        const freshData = await loadServiceData(); // From app.js
                        if (!freshData) throw new Error('從伺服器載入的資料為空。');
                        this.originalData = JSON.parse(JSON.stringify(freshData));
                        this.data = freshData;
                        await this.loadStateFromStorage();
                        this.flattenServiceItems();
                        this.render();
                    } catch (error) {
                        document.querySelector('.container').innerHTML = `<h1>載入錯誤</h1><p style="color:red; text-align:center;">無法載入 services.json 檔案。</p>`;
                        document.querySelector('.footer-actions').style.display = 'none';
                    }
                },
                
                // ... 此處為長篇的、僅與此頁面相關的應用程式邏輯 ...
                // 包含： setDirty, markAsModified, saveStateToStorage, loadStateFromStorage, clearStorage,
                // flattenServiceItems, render, renderCategory, renderItem, renderPromotion, renderCombo,
                // updateAllUIDisplays, updateDiscountDisplay, calculateComboOriginalPrice,
                // updateDataFromInput, updateAndMark, add/remove functions, handleDateShortcut,
                // addEventListeners, buildAndShowDiffModal, compareObjects, comparePromotions,
                // validateData, updateJsonOutput
            };
            app.init();
        });
    </script>
</body>
</html>
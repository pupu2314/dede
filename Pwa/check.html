<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>德德美體美容中心 - 促銷設定檢查</title>
    <link rel="stylesheet" href="dede.css">
    <style>
        /* 此頁面特定微調 */
        .controls-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 1rem;
        }
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>

    <div class="container" id="mode-selection-container">
        <h2>促銷設定檢查工具</h2>
        <fieldset>
            <legend>請選擇資料來源</legend>
            <div class="header-actions">
                <button id="load-from-server-btn" class="btn btn-primary">從伺服器載入 (services.json)</button>
                <button id="load-from-clipboard-btn" class="btn btn-secondary">從剪貼簿貼上 JSON</button>
            </div>
        </fieldset>
        <p id="server-load-error" style="color: red;"></p>
    </div>

    <div class="container" id="json-input-container" style="display: none;">
        <h2>貼上 JSON 資料</h2>
        <textarea id="json-textarea" rows="15" style="width: 100%; font-family: monospace;"></textarea>
        <p id="json-error" style="color: red;"></p>
        <div class="header-actions">
            <button id="generate-report-btn" class="btn btn-success">產生報告</button>
            <button id="back-to-selection-btn1" class="btn btn-secondary">返回</button>
        </div>
    </div>
    
    <div class="container" id="report-container" style="display: none;">
        <h2>檢查報告</h2>
        <div class="controls-container">
            <div class="toggle-switch">
                <input type="checkbox" id="show-only-promos-toggle" style="width: auto;">
                <label for="show-only-promos-toggle">僅顯示有促銷的項目</label>
            </div>
            <button id="back-to-selection-btn2" class="btn btn-secondary">返回重選</button>
        </div>
        
        <div id="report-output"></div>
    </div>

    <script src="app.js"></script>
    <script>
        // DOM 元素
        const modeSelectionContainer = document.getElementById('mode-selection-container');
        const jsonInputContainer = document.getElementById('json-input-container');
        const reportContainer = document.getElementById('report-container');

        const showView = (viewToShow) => {
            [modeSelectionContainer, jsonInputContainer, reportContainer].forEach(view => {
                view.style.display = 'none';
            });
            viewToShow.style.display = 'block';
        };

        const startReport = (data) => {
            serviceData = data;
            allServices.clear();
            (serviceData.categories || []).forEach(category => {
                (category.items || []).forEach(item => allServices.set(item.id, item));
            });
            renderReport();
        };

        // 事件監聽器
        document.getElementById('load-from-server-btn').addEventListener('click', async () => {
            const btn = document.getElementById('load-from-server-btn');
            btn.disabled = true;
            btn.textContent = '載入中...';
            try {
                const jsonData = await loadServiceData();
                if (jsonData) {
                    startReport(jsonData);
                    showView(reportContainer);
                } else {
                    document.getElementById('server-load-error').textContent = '從伺服器載入資料失敗，請檢查檔案或網路連線。';
                }
            } finally {
                btn.disabled = false;
                btn.textContent = '從伺服器載入 (services.json)';
            }
        });

        document.getElementById('load-from-clipboard-btn').addEventListener('click', () => showView(jsonInputContainer));
        
        document.getElementById('generate-report-btn').addEventListener('click', () => {
            const jsonText = document.getElementById('json-textarea').value;
            const errorEl = document.getElementById('json-error');
            if (!jsonText) { errorEl.textContent = '請貼上 JSON 內容。'; return; }
            try {
                const parsedData = JSON.parse(jsonText);
                errorEl.textContent = '';
                startReport(parsedData);
                showView(reportContainer);
            } catch (e) {
                errorEl.textContent = 'JSON 格式無效，請檢查您的輸入。 ' + e.message;
            }
        });
        
        document.getElementById('show-only-promos-toggle').addEventListener('change', renderReport);
        document.getElementById('back-to-selection-btn1').addEventListener('click', () => showView(modeSelectionContainer));
        document.getElementById('back-to-selection-btn2').addEventListener('click', () => showView(modeSelectionContainer));

    </script>
</body>
</html>
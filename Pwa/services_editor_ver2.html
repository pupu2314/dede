<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服務資料編輯器</title>
    <link rel="stylesheet" href="dede.css">
    <style>
        /* Editor-specific styles */
        :root { --toast-height: 50px; }
        body { padding-bottom: 120px; }
        .container { max-width: 1000px; }
        h1, h2 { text-align: center; }
        h3 { font-size: 1.2em; font-weight: bold; color: #333; margin-top: 1.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem; }
        .btn { display: inline-block; width: auto; padding: 10px 15px; border-radius: 5px; font-weight: bold; text-align: center; cursor: pointer; border: none; color: #fff; background-color: #007bff; transition: background-color 0.2s; font-size: 0.9em; margin-top: 5px; box-sizing: border-box; }
        .btn.btn-block { width: 100%; }
        .btn.btn-sm { padding: 5px 10px; font-size: 0.8em; }
        .btn.btn-danger { background-color: #dc3545; }
        .btn.btn-danger:hover { background-color: #c82333; }
        .btn.btn-secondary { background-color: #6c757d; }
        .btn.btn-secondary:hover { background-color: #5a6268; }
        
        /* Table Styles for Desktop */
        .table-view { display: none; }
        @media (min-width: 768px) {
            .table-view { display: table; width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
            .table-view th, .table-view td { border: 1px solid #dee2e6; padding: 12px; text-align: left; vertical-align: middle; }
            .table-view thead { background-color: #e9ecef; }
            .original-view { display: none; }
            .detailed-edit-input { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        }
        
        .promo-item, .combo-item { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 8px; margin-top: 8px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .actions-group { display: flex; gap: 8px; flex-shrink: 0; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 600px; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #dee2e6; padding-bottom: 15px; margin-bottom: 15px; }
        .modal-header h4 { margin: 0; color: #0056b3; }
        .modal-body { flex-grow: 1; overflow-y: auto; }
        .modal-body .form-group { margin-bottom: 15px; }
        .modal-body .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .modal-body .form-group input, .modal-body .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .modal-footer { flex-shrink: 0; display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .modal-error, .promo-calculation { color: #dc3545; margin-top: 10px; font-size: 0.9em; font-weight: bold; }
        .promo-calculation { color: #28a745; }
        .promo-calculation.strong-discount { color: #ffc107; }
        #changes-list { list-style-type: disc; padding-left: 20px; background: #f8f9fa; border: 1px solid #eee; padding: 10px; border-radius: 4px; max-height: 40vh; overflow-y: auto; }
        #changes-list li { margin-bottom: 5px; }
        select[multiple] { height: 200px; }

        .bottom-actions { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .bottom-actions .container { display: flex; gap: 15px; padding: 0; }

        .detailed-edit-toggle { background-color: #f0f0f0; padding: 15px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #ddd; }
    </style>
    <script src="https://unpkg.com/vue@2"></script>
</head>
<body>

<div id="app" class="container">
    <h1>服務資料編輯器</h1>

    <div class="detailed-edit-toggle">
        <label><input type="checkbox" v-model="detailedEditEnabled"> <strong>啟用服務項目詳細編輯 (ID、名稱、價格)</strong></label>
    </div>

    <!-- 服務項目編輯區塊 -->
    <div v-for="(category, ci) in data.categories" :key="'cat-table-'+ci">
        <h3>{{ category.name }}</h3>
        <!-- (桌面版與行動版視圖，為簡潔省略，功能與先前相同) -->
    </div>

    <!-- 組合優惠編輯區塊 -->
    <h2>組合優惠編輯</h2>
    <div v-if="!data.combos || data.combos.length === 0" style="color: #6c757d; text-align: center; padding: 20px;">目前沒有組合優惠</div>
    <div v-for="(combo, cbi) in data.combos" :key="'combo-'+cbi" class="combo-item">
        <div>
            <strong>{{ combo.name }}</strong> ({{ combo.itemIds.length }}個項目)
            <br><small>原價: {{ calculateComboOriginalPrice(combo).toLocaleString() }}</small>
        </div>
        <div class="actions-group">
            <button @click="openComboModal(cbi)" class="btn btn-secondary btn-sm">編輯</button>
            <button @click="deleteCombo(cbi)" class="btn btn-danger btn-sm">刪除</button>
        </div>
    </div>
    <button @click="openComboModal(-1)" class="btn">新增組合優惠</button>
    

    <!-- (多個彈出視窗，為簡潔省略HTML，功能在JS中實現) -->
    <!-- 1. 編輯優惠 Modal -->
    <!-- 2. 編輯組合 Modal -->
    <!-- 3. 變更確認 Modal -->


    <!-- 底部操作按鈕 -->
    <div class="bottom-actions">
        <div class="container">
            <button @click="discardAndReload" class="btn btn-secondary btn-block">放棄暫存並重載</button>
            <button v-if="isDirty" @click="openChangesModal" class="btn btn-block">產生JSON</button>
            <button v-else @click="copyJson(true)" class="btn btn-block">複製JSON</button>
        </div>
    </div>
</div>

<script>
    new Vue({
        el: '#app',
        data: {
            data: { categories: [], combos: [] },
            originalData: null, // 用於比較變更
            isDirty: false,
            initialLoadComplete: false,
            detailedEditEnabled: false,
            // ... (其他 Modal 狀態)
            isComboModalVisible: false,
            currentCombo: { name: '', itemIds: [] },
            editingComboIndex: -1,
            isChangesModalVisible: false,
            changesList: []
        },
        computed: {
            allItems: function() {
                return (this.data.categories || []).flatMap(cat => cat.items || []);
            }
        },
        watch: {
            data: {
                handler: function(newData) {
                    if (this.initialLoadComplete) {
                        localStorage.setItem('autosavedData', JSON.stringify(newData));
                        this.isDirty = true;
                    }
                },
                deep: true
            }
        },
        methods: {
            // --- 組合優惠方法 ---
            openComboModal: function(index) {
                this.editingComboIndex = index;
                if (index === -1) {
                    this.currentCombo = { name: '', itemIds: [] };
                } else {
                    this.currentCombo = JSON.parse(JSON.stringify(this.data.combos[index]));
                }
                this.isComboModalVisible = true;
            },
            saveCombo: function() {
                if (!this.currentCombo.name.trim()) { alert('組合名稱不可為空'); return; }
                if (this.currentCombo.itemIds.length < 2) { alert('組合至少需包含 2 個服務項目'); return; }

                if (this.editingComboIndex === -1) {
                    if (!this.data.combos) this.$set(this.data, 'combos', []);
                    this.data.combos.push(this.currentCombo);
                } else {
                    this.$set(this.data.combos, this.editingComboIndex, this.currentCombo);
                }
                this.isComboModalVisible = false;
            },
            deleteCombo: function(index) {
                if (confirm('確定要刪除「' + this.data.combos[index].name + '」這個組合嗎？')) {
                    this.data.combos.splice(index, 1);
                }
            },
            calculateComboOriginalPrice: function(combo) {
                if (!combo || !combo.itemIds) return 0;
                return combo.itemIds.reduce((sum, id) => {
                    const item = this.allItems.find(i => i.id === id);
                    return sum + (item ? item.price : 0);
                }, 0);
            },
            
            // --- 全新變更提交流程 ---
            openChangesModal: function() {
                this.generateChangesList();
                this.isChangesModalVisible = true;
            },
            generateChangesList: function() {
                // ... (此處為複雜的比較邏輯，為簡潔省略)
                // 範例：
                this.changesList = ["修改項目 '私密處除毛' 的價格", "為 '鼻毛' 新增優惠 '9月優惠'"];
            },

            // --- 修改後的資料處理方法 ---
            copyJson: function(isManualCopy = false) {
                var outputData = JSON.parse(JSON.stringify(this.data));
                // ... (清理空 promotions 的邏輯)
                var jsonString = JSON.stringify(outputData, null, 2);
                 navigator.clipboard.writeText(jsonString).then(() => {
                    this.showToast('JSON 已複製到剪貼簿，請傳送給管理者更新伺服器資料才會生效。');
                    if(this.isChangesModalVisible) this.isChangesModalVisible = false;
                    // 注意：不再移除 autosave
                    // isDirty 狀態在複製後應重設，代表目前狀態已 "發布"
                    this.originalData = JSON.parse(JSON.stringify(this.data)); 
                    this.isDirty = false;
                    // 如果是手動複製(在沒有變更時)，也更新 originalData
                    if (isManualCopy) {
                         this.originalData = JSON.parse(JSON.stringify(this.data));
                    }
                }, () => {
                    alert('複製失敗!');
                });
            },
            loadDataFromServer: async function() {
                try {
                    var response = await fetch('services.json?t=' + new Date().getTime());
                    const data = await response.json();
                    this.data = data;
                    this.originalData = JSON.parse(JSON.stringify(data)); // 保存原始副本
                    this.isDirty = false;
                } catch (error) {
                    alert('無法載入資料!');
                } finally {
                    this.initialLoadComplete = true;
                }
            },
            discardAndReload: function() {
                 if (confirm('您確定要放棄所有未儲存的變更嗎？')) {
                    localStorage.removeItem('autosavedData');
                    this.loadDataFromServer();
                }
            },

            // --- 智慧標籤 ---
            openModal: function(item, promoIndex) {
                 // ... (原有邏輯)
                if (promoIndex === -1) {
                    this.currentPromotion.label = '新優惠';
                }
                // ...
            },
            setThisMonth: function() {
                // ... (原有日期設定邏輯)
                const month = new Date().getMonth() + 1;
                if (this.currentPromotion.label === '新優惠') {
                    this.currentPromotion.label = `${month}月優惠`;
                }
            },
            setNextMonth: function() {
                // ... (原有日期設定邏輯)
                const now = new Date();
                const month = new Date(now.getFullYear(), now.getMonth() + 1, 1).getMonth() + 1;
                if (this.currentPromotion.label === '新優惠') {
                    this.currentPromotion.label = `${month}月優惠`;
                }
            },
            // ... (其他所有既有方法)
        },
        mounted: function() {
            const savedData = localStorage.getItem('autosavedData');
            if (savedData) {
                this.data = JSON.parse(savedData);
                this.loadDataFromServer().then(() => { // 載入原始資料以供比較
                    this.data = JSON.parse(savedData); // 重新應用暫存資料
                    this.isDirty = true;
                    this.showToast('已載入上次未儲存的編輯內容。');
                });
            } else {
                this.loadDataFromServer();
            }
        }
    });
</script>

<!-- 以下為彈出視窗的HTML模板 -->
<template id="promo-modal-template">
    <!-- ... -->
</template>
<template id="combo-modal-template">
    <!-- ... -->
</template>
<template id="changes-modal-template">
    <!-- ... -->
</template>

</body>
</html>
